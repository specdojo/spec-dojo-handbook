# 業務プロセス仕様書（BPS）作成ルール

本ドキュメントは、業務分析・要求定義のために **業務プロセス仕様（Business Process Specification: BPS）を統一形式で記述する標準ルール**です。
DFD（概念データフロー図）・業務イベント一覧・ビジネスルール（BR）・概念状態遷移図（CSTD）とのトレーサビリティを高め、後続の設計・テスト設計を効率化することを目的とします。

---

## 1. 全体方針

- 対象は「業務上の単位処理（プロセス）」であり、画面遷移・UI操作列を冗長に列挙しない。
- **概念レベルの手順＋判断ポイント＋入出力の明確化**に集中する（実装クラス名・SQL・UIコンポーネント名は記述しない）。
- 他ドキュメント（DFD / 業務イベント / BR / CSTD / データ辞書）との参照を ID ベースで明示する。
- 1ファイル = 1 プロセス（例: `BP-010 在庫不足検知`）。複雑な場合は下位プロセスへ分解。

---

## 2. 用語定義

| 用語               | 定義                                                                        |
| ------------------ | --------------------------------------------------------------------------- |
| 業務プロセス（BP） | 業務イベントまたは条件を契機に起動し、明確な成果物/状態変化を生む処理単位   |
| 開始条件（When）   | プロセスを開始させるイベント・状態・タイミング                              |
| Input              | プロセスが参照/取得するデータ（概念レベル）。データ辞書・クラス図のIDで参照 |
| Process            | 手順/判断の論理的なステップ。順序と分岐を含む（番号付け）                   |
| Output             | プロセスが生成/更新/通知するデータ・イベント・状態変化                      |
| Postcondition      | プロセス終了後に保証される整合状態（不変条件）                              |
| BR参照             | ビジネスルール ID（BR-xxx）一覧。判断ロジックは BR に寄せる                 |
| Exception          | 異常/例外パス（入力不備・判定失敗・外部連携失敗等）                         |
| KPI/Metric         | 効果測定用の定量指標（頻度、所要時間、失敗率など）                          |

---

## 3. ファイル命名・ID規則

- ファイル名: `BP-<番号>-<短い日本語名>.md` （例: `BP-010-在庫不足検知.md`）
- Frontmatter `id`: `bp-010` のように小文字ハイフン形式。
- `title`: 「BP-010 在庫不足検知 業務プロセス仕様」など。
- 下位分割する場合: `BP-010-01`, `BP-010-02` を `id` に含め、親の `depends_on` に列挙。

---

## 4. 推奨 Frontmatter 項目

| 項目       | 説明                                 | 必須 |
| ---------- | ------------------------------------ | ---- |
| id         | プロセスID (bp-xxx)                  | ○    |
| type       | `domain` 固定                        | ○    |
| title      | プロセス名                           | ○    |
| status     | `draft`/`ready`/`deprecated`         | ○    |
| version    | バージョン                           | 任意 |
| owners     | 担当者                               | 任意 |
| depends_on | 前提となる他プロセス/イベント/ルール | 任意 |
| implements | 関連 BR / 要件 ID                    | 任意 |
| tests      | 関連テストケース ID                  | 任意 |
| kpis       | 追跡する KPI 名                      | 任意 |

余計な実装メタ（クラス名・API パス）は不要。必要なら後続設計ドキュメントで管理。

---

## 5. 本文構成（標準テンプレ）

各 BPS ファイルは以下見出しを順番に並べる。

1. 概要（Purpose）
2. 開始条件（When / Trigger）
3. 前提条件（Preconditions）
4. Input（参照データ / 取得元）
5. Process（手順ステップ）
6. Output（生成・更新・通知）
7. Postcondition（終了後保証）
8. 参照ビジネスルール（BR Links）
9. 例外 / 異常系（Exception Paths）
10. データ更新一覧（Data Effects）
11. KPI / 計測観点（Metrics）
12. トレーサビリティ（Traceability Map）
13. メモ / 将来課題（Notes / TODO）

---

## 6. 記述ガイド詳細

### 6.1 概要

短い一文＋背景（なぜ存在するか）。課題解決の意図をビジネス用語で書く。

### 6.2 開始条件（When / Trigger）

- 業務イベント ID（EV-xxx）を必ず引用。
- 時間スケジュール（毎日 02:00）、状態変化（在庫更新後）、人操作（バイヤーが“発注生成”をクリック）などを列挙。

### 6.3 前提条件（Preconditions）

- 開始前に真であるべき条件。例: 「対象商品が販売中状態」「店舗が営業中」等。

### 6.4 Input

- データ辞書/CCD/CSTD の ID を列挙し、利用目的を簡潔に付記。
  - 例: `INVENTORY`（現在在庫数参照）, `REORDER_POINT`（閾値参照）。
- 外部システム IF の場合は IF 仕様の ID を引用。

### 6.5 Process（手順）

番号付き箇条書きで最小限のステップ。分岐は `if / else` ではなく日本語条件句。

例:

1. 対象商品群を抽出（在庫数 ＜ 発注点）
2. 既存未処理発注候補がある商品を除外
3. 自動発注候補レコード生成（数量 = 発注点 − 在庫数）
4. EV-020「発注候補生成」イベント発火

### 6.6 Output

- 新規生成: レコード/イベント/通知。
- 更新: どの項目がどう変わるか（増減/ステータス変更）。
- 削除（あれば）。

### 6.7 Postcondition

終了後に保証される整合状態（例: 「対象商品の発注候補は1件のみ」「在庫数は未変更」）。テストの判定基準に直結。

### 6.8 参照ビジネスルール

- 判断を BR に外出し済みか確認。`BR-xxx` を列挙し「どのステップで適用か」コメント。

### 6.9 例外 / 異常系

- 外部呼び出し失敗 / 入力欠損 / 矛盾（発注点 < 0）など。
- 失敗時挙動（再試行回数 / 中断 / 警告ログ / オペレーション通知）を記述。

### 6.10 データ更新一覧

表形式（対象テーブル / 操作 / 主な項目 / 条件）。概念レベルで要約、物理項目名は書かない。

### 6.11 KPI / Metrics

- 例: 処理件数, 所要時間, 重複候補発生率, 失敗率。
- 計測方法（イベントログ / メトリクスカウンタなど）を一言。

### 6.12 トレーサビリティ

関連 ID を表形式でまとめる。

| 種類           | ID           | 役割         |
| -------------- | ------------ | ------------ |
| イベント       | EV-010       | 開始条件     |
| ビジネスルール | BR-001       | 在庫不足判定 |
| CCD            | クラス: 在庫 | 在庫数参照   |
| CSTD           | 商品状態図   | 状態前提確認 |
| テストケース   | TC-INV-001   | 正常系検証   |

### 6.13 メモ / 将来課題

既知の改善余地（閾値動的化、並行処理最適化など）。

---

## 7. 命名・記述スタイル

- プロセス名は「名詞＋機能動詞」: 例 `在庫不足検知`, `自動発注候補生成`。
- ステップは簡潔に。禁止: 冗長なスクリーン操作列（「ページを開く→スクロール→クリック」）。
- 条件文は業務用語ベースで。「在庫数 − 予約数 < 発注点」などは式と意味を併記可。
- 受動態より能動態（「システムは候補を生成する」）。

---

## 8. 階層分解ガイド

| シグナル         | 下位プロセスへ分割検討 |
| ---------------- | ---------------------- |
| ステップ数が10超 | 冗長化・可読性低下     |
| 分岐が3種類以上  | 条件別プロセス分離     |
| 複数イベント混在 | イベント別に分割       |
| 出力が多種（>5） | 目的別再編             |

親から子へ `depends_on` で関連付けし、子の `Postcondition` が親のステップ対応になるよう意識。

---

## 9. 禁止事項

| 項目                         | 理由                           |
| ---------------------------- | ------------------------------ |
| UI操作列の逐語的記述         | 可読性低下・設計変更に弱い     |
| 物理テーブル名・SQL全文      | 概念レベル逸脱（DB設計に記述） |
| 画面レイアウト詳細           | 画面仕様へ委譲                 |
| 機能要件以外の雑多な会話ログ | メンテ不能                     |
| ビジネスルール重複記述       | 変更時不整合リスク             |
| 未定義略語乱用               | 用語集との整合欠如             |

---

## 10. よくある誤りと対策

- 在庫不足判定ロジックをステップ内に長文記載 → BR 化して参照。
- 画面遷移記述を羅列 → 「開始条件」「Output」に要約。
- 外部 API エラー未記載 → 例外セクションで HTTP タイムアウト・再試行方針を明示。
- Postcondition が曖昧（「正常終了」など）→ 検証可能な状態を列挙。

---

## 11. サンプル（簡易）

```markdown
---
id: bp-010
type: domain
title: BP-010 在庫不足検知 業務プロセス仕様
status: draft
implements: [BR-001]
depends_on: [ev-010]
tests: [TC-INV-001]
---

## 概要

在庫数が発注点を下回った商品に対し発注候補を生成する。

## 開始条件 (When)

EV-010 在庫数更新イベント受信後。

## 前提条件

- 商品が販売可能状態
- 発注点 > 0

## Input

- INVENTORY: 現在在庫数
- REORDER_POINT: 発注点
- PENDING_ORDER_CANDIDATE: 未処理候補存在確認

## Process

1. 在庫数 < 発注点 の商品を抽出
2. 未処理候補がある商品を除外
3. 発注数量 = 発注点 − 在庫数 を計算
4. 発注候補レコード生成
5. EV-020 発注候補生成イベント発火

## Output

- 新規 ORDER_CANDIDATE レコード
- EV-020 発注候補生成イベント

## Postcondition

- 対象商品の ORDER_CANDIDATE は重複なし
- 在庫数は未変更

## 参照ビジネスルール

- BR-001 在庫不足判定（ステップ1）

## 例外

- 発注点未設定 → ログ WARN, 商品スキップ
- 外部API遅延（在庫取得失敗）→ 3回リトライ後失敗記録

## データ更新一覧

| 対象            | 操作   | 主項目          | 条件            |
| --------------- | ------ | --------------- | --------------- |
| ORDER_CANDIDATE | INSERT | product_id, qty | 在庫数 < 発注点 |

## KPI

- 重複候補発生率 (目標 0%)
- 処理時間 P95 < 500ms

## トレーサビリティ

| 種類 | ID         | 役割     |
| ---- | ---------- | -------- |
| EV   | EV-010     | 開始     |
| EV   | EV-020     | 生成通知 |
| BR   | BR-001     | 判定     |
| TC   | TC-INV-001 | 正常系   |

## メモ

将来: 閾値を動的（曜日別）にする拡張検討。
```

---

## 12. 生成 AI への指示テンプレート

以下をプロンプトとして提示することで、生成 AI に業務プロセス仕様の初稿を作成させる。

> - 業務プロセス仕様（BPS）を作成してください。出力は Markdown。
> - 1つのプロセス (BP-xxx) について、以下見出しで構成してください：概要 / 開始条件 / 前提条件 / Input / Process / Output / Postcondition / 参照ビジネスルール / 例外 / データ更新一覧 / KPI / トレーサビリティ / メモ。
> - 開始条件には対応する業務イベント ID (EV-xxx) を必ず含めてください。
> - Input / Output は概念レベルで記述し、物理テーブル名・SQL は書かないでください。
> - 判断ロジックは可能な限りビジネスルール ID (BR-xxx) を参照する形にしてください。
> - Process は番号付きリストで 5〜9 ステップ程度、簡潔に。条件分岐は自然な日本語で。
> - Postcondition は検証可能な整合状態を列挙してください（曖昧な「正常終了」は不可）。
> - 例外は主要な 2〜4 ケースを挙げ、挙動（リトライ／スキップ／失敗記録）を明記してください。
> - データ更新一覧は表形式 (対象/操作/主項目/条件) で概念的に記述してください。
> - KPI は 1〜3 個、処理品質を測る指標を挙げてください。
> - 全体を業務用語で統一し、略語は用語集に存在するもののみ使用してください。
> - 出力は ```markdown コードブロックで返してください。

このテンプレートをコピーして生成 AI に貼り付けて利用してください。

---

## 13. 今後の拡張案（任意）

- 自動テーブル: BP ↔ BR ↔ EV ↔ TC のクロス参照一覧生成スクリプト。
- 複雑分岐プロセスへの Mermaid フローチャート連携（概念レベル限定）。
- KPI ログ出力規約の別ドキュメント化。
