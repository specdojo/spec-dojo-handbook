# 販売概念データフロー図（現状）

凡例と記号の意味は[mermaid-dfd-rules.md](mermaid-dfd-rules.md)を参照してください。

## 販売プロセス概要

| プロセス           | 業務内容                                             | 担当 | 業務が発生するイベント         | インプット                 | アウトプット                         |
| ------------------ | ---------------------------------------------------- | ---- | ------------------------------ | -------------------------- | ------------------------------------ |
| 品出し             | 売り場棚の商品の減った分をバックヤードから補充する。 | 店主 | 売り場在庫が足りなくなった     | 在庫商品数量、販売商品数量 | 販売商品                             |
| 陳列               | 売り場棚に商品を整える。                             | 店主 | 開店の準備を始めた             | 販売商品                   | 販売商品                             |
| 購買受付           | お客様が選んだ商品を受け取り、販売手続きを開始。     | 店主 | お客様が商品をレジに持ってきた | 販売商品                   | 請求金額、会計対象商品               |
| 代金受領           | 現金で代金を受け取る。                               | 店主 | お客様が代金を払った           | 会計対象商品、受領現金     | 領収書、釣銭、レジ現金の更新、売上金 |
| 商品引渡           | 袋詰め・提供などを行い、お客様に商品を渡す。         | 店主 | お客様が代金を支払った         | 会計対象商品               | 販売済商品、販売数量情報             |
| 購買キャンセル対応 | お客様が購入を取りやめた商品を棚に戻す。             | 店主 | お客様が購買を取りやめた       | 会計対象商品               | 販売商品                             |
| つけ販売受付       | お客様の希望で代金を後払いとして記録。               | 店主 | お客様がつけ購入を希望した     | 会計対象商品               | 掛払商品、掛売伝票、つけ金額情報     |

## 品出し、陳列

```mermaid
flowchart LR

  %% プロセス
  品出し("品出し<br>（担当: 店主）")
  陳列("陳列<br>（担当: 店主）")

  %% イベント
  棚減少{{"売り場在庫が減った"}}
  開店準備{{"開店準備開始"}}

  %% データストア
  在庫台帳[(在庫台帳)]

  %% 物理保管
  売り場棚([売り場棚])

  %% 品出し
  棚減少 --> 品出し
  バックヤード ==>|在庫商品| 品出し
  品出し ==>|販売商品| 売り場棚
  在庫台帳 -->|在庫数量| 品出し
  品出し -->|出庫数量| 在庫台帳

  %% 陳列
  開店準備 --> 陳列
  売り場棚 -->|陳列情報| 陳列
  陳列 ==>|棚配置更新| 売り場棚
```

## 購買受付、代金受領、商品引渡し

```mermaid
flowchart LR

  %% プロセス
  購買受付("購買受付<br>（担当: 店主）")
  代金受領("代金受領<br>（担当: 店主）")
  商品引渡("商品引渡<br>（担当: 店主）")

  %% イベント
  商品持込{{"お客様が商品を持ってきた"}}
  支払意志{{"お客様が代金を払う"}}
  支払完了{{"支払完了"}}

  %% 外部主体
  顧客[顧客]

  %% データストア
  在庫台帳[(在庫台帳)]
  レジ記録[(レジ記録)]

  %% 物理保管
  レジ([レジ])

  %% 購買受付
  商品持込 --> 購買受付
  顧客 ==>|販売商品| 購買受付
  購買受付 ==>|会計対象商品| 代金受領
  購買受付 --> 支払意志

  %% 代金受領
  支払意志 --> 代金受領
  顧客 ==>|現金| 代金受領
  代金受領 ==>|釣銭| 顧客
  代金受領 -->|受領金額| レジ記録
  代金受領 ==>|レジ現金| レジ
  代金受領 ==>|引渡前商品| 商品引渡

  %% 商品引渡
  代金受領 --> 支払完了 --> 商品引渡
  商品引渡 ==>|販売済商品| 顧客
  商品引渡 -->|販売数量| 在庫台帳
```

## 例外処理：購買キャンセル対応、つけ販売受付

```mermaid
flowchart LR

  %% プロセス
  購買受付("購買受付<br>（担当: 店主）")
  購買キャンセル対応("購買キャンセル対応<br>（担当: 店主）")
  つけ販売受付("つけ販売受付<br>（担当: 店主）")

  %% イベント
  商品持込{{"お客様が商品を持ってきた"}}
  購買取消{{"購買を取りやめた"}}
  つけ希望{{"つけ購入を希望した"}}

  %% 外部主体
  顧客[顧客]

  %% データストア
  在庫台帳[(在庫台帳)]
  つけ帳[(つけ帳)]

  %% 物理保管
  売り場棚([売り場棚])

  %% 購買受付
  商品持込 --> 購買受付
  顧客 ==>|販売商品| 購買受付
  購買受付 ==>|会計対象商品| 購買キャンセル対応
  購買受付 --> つけ希望
  購買受付 --> 購買取消

  %% 購買キャンセル対応
  購買取消 --> 購買キャンセル対応
  顧客 ==>|キャンセル商品| 購買キャンセル対応
  購買キャンセル対応 ==>|販売商品| 売り場棚
  購買キャンセル対応 -->|販売商品| 在庫台帳

  %% つけ販売受付
  つけ希望 --> つけ販売受付
  購買受付 ==>|会計対象商品| つけ販売受付
  つけ販売受付 -->|掛売金額| つけ帳
  つけ販売受付 ==>|掛売商品| 顧客
  つけ販売受付 -->|出庫数量| 在庫台帳
```
