# 業務受入条件仕様（BAC）作成ルール

本ドキュメントは、業務分析・要求定義のために **業務受入条件（Business Acceptance Criteria: BAC）を統一形式で記述する標準ルール**です。
BAC は「業務側から見て、このシステムで業務が回せる」ことを確認するための受け入れ条件を、**Gherkin（Feature / Scenario）形式**で定義します。

## 1. 全体方針

- 対象は「業務として受け入れ可能であること」を示す条件であり、**業務用語で、期待結果が検証可能な形**に書きます。
- 実装詳細（例: 物理テーブル名、SQL、実装クラス/関数名、APIの内部処理）は記載しません。
- クリック手順の逐語列挙など、UIの操作手順に寄りすぎた記述は避け、**業務行為**として要約します。
- 1ファイル = 1 Feature（業務の塊）を基本とします。肥大化する場合は Feature を分割します。

## 2. 用語定義

| 用語     | 定義                                                   |
| -------- | ------------------------------------------------------ |
| BAC      | 業務受入条件。業務側の観点での受け入れ基準（期待結果） |
| Feature  | 業務として実現したい能力（例: 商品販売）               |
| Scenario | 具体的な業務シナリオ（例: 顧客が商品を購入する）       |
| Given    | 事前条件（前提状態、準備）                             |
| When     | 業務の実行（業務イベントや操作の要約）                 |
| Then     | 期待結果（観測可能な事実：状態変化、記録、通知など）   |

## 3. ファイル命名・ID規則

- ファイル名: `bac-<番号>-<短い日本語名>.md` （例: `bac-0010-商品販売.md`）
- Frontmatter:
  - `id`: `bac-sale-checkout` のように小文字ハイフン形式。
  - `title`: 「業務受入条件: 商品販売」など。

## 4. 推奨 Frontmatter 項目

Frontmatter は `docs/tools/schemas/spec-frontmatter.schema.yaml` の制約に従います。

| 項目       | 説明                                     | 必須 |
| ---------- | ---------------------------------------- | ---- |
| id         | 受入条件ID（`bac-...`）                  | ○    |
| type       | `test` 固定                              | ○    |
| title      | 受入条件名（例: 業務受入条件: 商品販売） | ○    |
| status     | `draft`/`ready`/`deprecated`             | ○    |
| version    | バージョン（SemVer）                     | 任意 |
| owners     | 担当者                                   | 任意 |
| tags       | タグ・分類                               | 任意 |
| depends_on | 参照する仕様ID（BPS/BR/UI/BEV/BEL 等）   | 任意 |
| supersedes | 置き換え関係（古仕様→新仕様）            | 任意 |

推奨:

- `depends_on` に、受入対象の仕様IDを列挙します（例: `bps-...`, `br-...`, `ui-...`, `bev-...`）。
- BR や BPS 側の `tests` から BAC を参照できるよう、ID は安定させます（名前を変える場合は `supersedes` を使う）。

## 5. 本文構成（標準テンプレ）

各 BAC ファイルは以下の見出しを順番に並べます。

1. 概要
2. 受入条件（Gherkin）
3. メモ / 将来課題

## 6. 記述ガイド詳細

### 6.1 概要

- 1〜3文で「何を受け入れるか」を書きます。
- 可能であれば、対象の業務イベント（BEV）や業務プロセス（BPS）を言及し、`depends_on` と整合させます。

### 6.2 受入条件（Gherkin）

Gherkin ブロックで Feature と Scenario を記述します。

基本:

- Feature は 1 つを基本（大きい場合はファイル分割）。
- Scenario は 2〜8 個程度を目安に、業務の代表パターンを押さえます。
- 期待結果は **観測可能な事実** として書きます（例: 「在庫が減少する」「売上が記録される」「納品が記録される」など）。

記述のコツ:

- Given は「前提状態」。データ準備が必要なら業務用語で表現します（例: 「商品Aの在庫が10ある」）。
- When は「業務行為」。クリック手順ではなく、業務として何をしたかに寄せます（例: 「レジ担当者が会計を確定する」）。
- Then は「期待結果」。状態変化/記録/通知などを、過不足なく列挙します。

### 6.3 メモ / 将来課題

- 未確定の運用（例: 締め処理、例外時の扱い）や、将来追加したい Scenario を記録します。

## 7. 禁止事項

| 項目                                  | 理由                         |
| ------------------------------------- | ---------------------------- |
| 物理テーブル名・物理カラム名・SQL全文 | 概念レベル逸脱               |
| 実装クラス/関数名、APIの内部実装詳細  | 実装依存で変更に弱い         |
| クリック/画面遷移の逐語列挙           | UI変更に弱い・本質が埋もれる |
| Then が曖昧（「正しく処理される」等） | 検証不能                     |

## 8. よくある誤りと対策

- Scenario が UI 手順書になっている → When を「業務行為」に要約し、Then を「事実」に寄せる。
- Then が 10 個以上に肥大 → Scenario を分割するか、期待結果を整理（“必須の観測点”に絞る）。
- 例外系が抜けている → 代表的な異常（在庫不足、入力不備、締め済み等）を Scenario で追加する。

## 9. サンプル（簡易）

````markdown
---
id: bac-sale-checkout
type: test
title: 業務受入条件: 商品販売
status: draft
version: '1.0.0'
owners: []
tags: [sale]
depends_on:
 - bps-sale-checkout
 - bev-sale-checkout
 - br-sale-total-calc
supersedes: []
---

## 概要

レジ会計時に、商品販売（会計確定）が業務として成立し、売上と在庫が正しく記録されること。

## 受入条件（Gherkin）

```gherkin
Feature: 商品販売
 システムはレジ会計時に商品販売処理ができること

 Scenario: 顧客が商品を購入する
 Given 顧客がレジに商品を持参している
 And 商品の在庫が十分にある
 When レジ担当者が会計を確定する
 Then 売上が記録される
 And 商品の在庫が減少する
```

## メモ / 将来課題

- 将来: 返品・取消の受入条件を追加する。
````

### 9.2 サンプル（複合・長め）

「複合シナリオ」の例です（発注→入荷→支払までを 1 つの受入条件として確認）。

````markdown
---
id: bac-procurement-order-to-payment
type: test
title: 業務受入条件: 仕入（発注〜入荷〜支払）
status: draft
version: '1.0.0'
owners: []
tags: [procurement, inventory, accounting]
depends_on:
 - bps-procurement-order
 - bps-procurement-receive
 - bps-accounting-payment
 - bev-purchase-order-confirmed
 - bev-goods-receipt-confirmed
 - bev-invoice-received
 - bev-payment-confirmed
supersedes: []
---

## 概要

在庫補充のための仕入で、発注・入荷・支払までの一連が業務として成立し、在庫・仕入・支払の記録が矛盾なく追跡できること。

## 受入条件（Gherkin）

```gherkin
Feature: 仕入（発注〜入荷〜支払）
 システムは仕入の一連処理を記録・追跡できること

 Scenario: 発注から入荷・支払までが完了する
  Given 商品Aの在庫が発注点以下である
  And 仕入先Sが取引可能（取引停止ではない）である
  And 仕入先Sの支払条件が登録されている
  When 発注担当者が商品Aを数量10で発注確定する
  And 仕入先Sから商品Aが数量10で納品され、入荷検品を確定する
  And 経理担当者が仕入先Sの請求書（発注分）を受領する
  And 経理担当者が支払を確定する
  Then 発注が記録される
  And 発注には発注番号、仕入先、発注明細（商品、数量、単価）が保持される
  And 入荷が記録される
  And 入荷には入荷日、仕入先、入荷明細（商品、数量）が保持される
  And 在庫が数量10増加する
  And 請求が記録される
  And 請求には請求番号、仕入先、対象期間、請求金額が保持される
  And 支払が記録される
  And 支払には支払日、仕入先、支払金額、支払方法が保持される
  And 発注・入荷・請求・支払が相互に追跡できる（参照関係を辿れる）

 Scenario: 入荷検品で数量差異があり、差異が記録される
  Given 発注担当者が商品Aを数量10で発注確定している
  And 仕入先Sから商品Aが数量9で納品される
  When 入荷検品を確定する
  Then 入荷が記録される
  And 入荷数量は数量9として記録される
  And 発注との差異（不足1）が記録される
  And 在庫が数量9増加する
```

## メモ / 将来課題

- 将来: 分納（複数回入荷）を扱う Scenario を追加する。
- 将来: 値引・返品・訂正（請求訂正、支払取消）を扱う Scenario を追加する。
````

## 10. 生成 AI への指示テンプレート

生成 AI に業務受入条件（BAC）を作らせるときは、以下のような指示を与えます。

> - 以下のルールに従って、**業務受入条件（BAC）** を 1 ファイル作成してください。出力は **Markdown** とします。
> - 対象は 1 つの Feature（1ファイル=1Feature）です。形式は **Gherkin** とします。
> - 禁止: 物理テーブル名・物理カラム名・SQL全文、実装クラス/関数名、API内部実装詳細、クリック手順など UI 操作の逐語列挙
> - 先頭に YAML Frontmatter を付与し、以下の形式で記述してください（`id` / `type` / `title` / `status` は必須）：
>
>   ```yaml
>   ---
>   id: bac-<英小文字とハイフンで構成したID>
>   type: test
>   title: 業務受入条件: <Feature名>
>   status: draft # draft / ready / deprecated
>   version: '1.0.0'
>   owners: []
>   tags: []
>   depends_on: []
>   supersedes: []
>   ---
>   ```
>
> - 本文は次の見出し（日本語）をこの順序で必ず含めてください：
>   1. 概要
>   2. 受入条件（Gherkin）
>   3. メモ / 将来課題
> - Gherkin では Feature を 1つ、Scenario を 2〜6 個程度作成してください。
> - Then は「観測可能な事実」（状態変化/記録/通知など）として具体的に書き、検証可能にしてください。
> - 全体を **業務用語で統一** し、略語を使う場合は、業務用語集に存在する一般的な略語のみとし、意味が推測しづらい略語や内部コードは使用しないでください。
