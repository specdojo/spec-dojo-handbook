# 単体テスト仕様 全体構成 作成ルール

Unit Test Specification Index (UTS Index) Documentation Rules

本ドキュメントは、単体テスト仕様のうち **全体構成 （`uts-index`）** を統一形式で記述するための標準ルールです。
`uts-index` は、TPC で整理された観点・条件を単体テストの責務として解釈し、個別単体テスト仕様（`uts-<term>`）へ分配するための **入口（ナビゲーション）** になります。

個別単体テスト仕様（`uts-<term>`）の記述ルールは [uts-rules.md](uts-rules.md) で定義します。

## 1. 目的

`uts-index` に以下を明文化し、単体テストの責務・境界・合格基準の認識ズレを防ぎます。

- TPC の観点・条件を「単体テストの責務」としてどう解釈するか
- 観点・条件を **対象単位（`uts-<term>`）** にどう分配するか（分配方針）
- 単体テストの **共通前提**（対象単位の定義、モック/スタブ境界）
- 単体レベルの **共通合格基準**（品質ゲートに影響するもの）
- 個別仕様（`uts-<term>`）へのナビゲーション（一覧・リンク）

## 2. 基本原則

- `uts-index` は **方針・基準・分配**までを扱い、個別の詳細条件やテストケースは扱いません。
- トレース表（観点ID↔上位仕様IDの表）は原則 TPC に集約し、`uts-index` は Frontmatter の `based_on` で追跡可能にします。
- 曖昧表現（例:「十分に」「適切に」）は禁止し、判定可能な言葉（対象/境界/基準/エビデンス）で書きます。

## 3. ファイル命名・ID規則

- 本ドキュメント（全体構成）の `id` は `uts-index` 固定とします。
- 個別仕様は `uts-<term>` とします（詳細は [uts-rules.md](uts-rules.md)）。
- ファイル名は`uts-010-単体テスト仕様-全体構成.md` 等、プロジェクト内で一意になるように命名します。

## 4. 推奨 Frontmatter 項目

Frontmatter は共通スキーマに従います（あわせてメタ情報ルールも参照）。

- 参照スキーマ: [docs/shared/schemas/spec-frontmatter.schema.yaml](../../../shared/schemas/spec-frontmatter.schema.yaml)
- メタ情報ルール: [meta-document-metadata-rules.md](meta-document-metadata-rules.md)

| 項目       | 説明                                               | 必須 |
| ---------- | -------------------------------------------------- | ---- |
| id         | `uts-index`（固定）                                | ○    |
| type       | `test` 固定                                        | ○    |
| title      | 単体テスト仕様: 全体構成                           | ○    |
| status     | `draft` / `ready` / `deprecated`                   | ○    |
| part_of    | `[]`（`uts-index` 自身は親なので通常は空配列）     | 任意 |
| based_on   | 根拠となる仕様ID（ID配列。未指定時は `[]` を許容） | 任意 |
| supersedes | 置き換え関係（ID配列。未指定時は `[]` を許容）     | 任意 |

推奨:

- `based_on` には最低限 `tpc-...` を含めます（必要に応じて BAC/NFR/BR 等も列挙）。
- 可能であれば、試験戦略/方針の上位文書（例: `tsp-overview`）も `based_on` に含めます。
- `part_of` / `based_on` / `supersedes` は ID 配列で記載し、未指定の場合も `[]` として明示してよいです。

## 5. 本文構成（標準テンプレ）

`uts-index` は以下の見出し構成を **必ず守ります**（順序固定）。

1. 概要
2. 対象単位の定義
3. 単体テストの境界（モック/スタブ方針）
4. 分配方針（TPC → `uts-<term>`）
5. 共通合格基準とエビデンス
6. 個別仕様一覧（`uts-<term>` へのリンク）
7. 対象外・除外理由
8. メモ / 将来課題

## 6. 記述ガイド

### 6.1. 概要

- `uts-index` が **単体テストで何をどこまで保証するか（全体の責務・境界・合格基準）** を簡潔に述べます。
- 「TPC の観点・条件を `uts-<term>` に分配する入口である」ことを明示します。
- 前版（`supersedes`）からの変更点があれば、ここで要点のみ触れてよいです（詳細な変更履歴は別途管理してもよい）。

### 6.2. 対象単位の定義（必須）

- `uts-<term>` の **粒度・命名・対象の切り方**を定義します。
- **1ドキュメント = 1論理対象**の原則、分割/統合の判断基準（例: 状態と責務が同一か、境界が明確か）を明記します。
- 実装構造（クラス名、モジュール名、API 名）には依存しない表現にします。

推奨の表（例）:

| `uts-<term>`        | 対象の要約                     |
| ------------------- | ------------------------------ |
| `uts-sale-checkout` | 会計確定の核（計算/検証/遷移） |
| `uts-inventory`     | 在庫引当/減算/戻しの核         |

### 6.3. 単体テストの境界（モック/スタブ方針）（必須）

- **単体で責任を持つ範囲**と、**結合以降へ委譲する範囲**を明確にします。
- 依存（DB、外部 API、時刻、乱数、ファイル等）をどう扱うか（モック/スタブ/固定化）を方針として記載します。

推奨の書き方（例）:

| 区分       | 内容                                              |
| ---------- | ------------------------------------------------- |
| 境界で切る | DB I/O、外部決済、帳票出力、外部在庫連携、時刻    |
| 依存の扱い | リポジトリはモック、時刻は固定、外部 API はスタブ |
| 結合で担保 | トランザクション整合性、実接続、同時実行制御      |

### 6.4. 分配方針（TPC → `uts-<term>`）（必須）

`uts-index` の中核です。最低限、次を満たします。

- `uts-<term>` ごとに **担当するTPC（またはTPCの観点範囲）** が追跡可能であること
- 分配の理由（責務/境界/関心の分離）が説明されていること
- 分配により **抜け/重複**が起きないための取り扱い（例: 例外系はどこで担保するか）を明示すること

推奨の表（例）:

| `uts-<term>`        | 担当するTPC（例）                                 | コメント                       |
| ------------------- | ------------------------------------------------- | ------------------------------ |
| `uts-sale-checkout` | `tpc-sale-checkout` の会計計算/取消/返品/権限制御 | 会計の核ロジックを単体で担保   |
| `uts-inventory`     | `tpc-sale-checkout` の在庫連動/在庫不足           | 在庫計算・不足判定を単体で担保 |

> トレース表（観点ID ↔ 上位仕様ID）の網羅は原則 TPC に置き、`uts-index` では分配の方針・リンク関係が分かる粒度に留めます。

### 6.5. 共通合格基準とエビデンス（必須）

- 単体テスト全体で共通に適用する **品質ゲート**を定義します（例: 失敗 0 件、重大不具合 0 件など）。
- 何をもって合格とし、何をエビデンスとするかを **判定可能な形**で示します。

推奨の表（例）:

| 項目         | 合格基準（例）        | エビデンス          |
| ------------ | --------------------- | ------------------- |
| 実行結果     | 失敗 0 件             | CI のテストレポート |
| 未解決不具合 | Blocker/Critical 0 件 | 不具合管理票        |

### 6.6. 個別仕様一覧（必須）

- `uts-<term>` の一覧を列挙し、リンク（相対リンク）で記載します。
- 分配方針の表と対応が取れるようにします（命名ゆれ禁止）。

### 6.7. 対象外・除外理由（必須）

- 単体テストで担保しない事項を列挙し、**どのレベル（結合/総合/非機能等）で担保するか**を明記します。

例:

- DB 制約・トランザクション整合性（結合テスト）
- 同時実行制御（負荷/非機能テスト）
- 外部 API 実接続（結合テスト）

### 6.8. メモ / 将来課題

- 未確定の方針、将来追加したい観点、分割/統合の見直し候補を記載します。
- 合否判定に影響する事項はここに置かず、本文（特に 6.4 / 6.5）へ反映します。

## 7. 禁止事項

| 項目                                         | 理由                                          |
| -------------------------------------------- | --------------------------------------------- |
| `uts-<term>` の本文と同じ内容の重複記載      | 更新漏れの温床                                |
| 個別ロジックの詳細条件（具体値・網羅ケース） | 下位（`uts-<term>` / UTD）へ委譲すべき        |
| テストケース（手順/期待結果の逐語列挙）      | 下位（UTD/テストコード）へ委譲すべき          |
| テストコード（クラス/メソッド/設定）         | 実装依存・単体テスト設計以降に委ねる          |
| 曖昧表現（「適切に」「十分に」等）           | 合否判定不能                                  |
| 未定義のメタ情報プロパティ追加               | スキーマ違反（`additionalProperties: false`） |

## 8. サンプル（最小）

### 8.1. メタ情報（Frontmatter）

```yaml
---
id: uts-index
type: test
title: 単体テスト仕様: 全体構成（駄菓子屋販売管理システム）
status: draft
part_of: []
based_on:
  - tpc-sale-checkout
  - bac-sale-checkout
  - bac-inventory-replenishment
supersedes: []
---
```

### 8.2. 概要

本ドキュメント（`uts-index`）は、単体テストで担保する **責務・境界・共通合格基準** を定義し、TPC の観点・条件を対象単位（`uts-<term>`）へ **分配する入口（ナビゲーション）** とする。

### 8.3. 対象単位の定義

- `uts-<term>` は **1ドキュメント = 1論理対象（責務のまとまり）** とする。
- 分割/統合の基準は、責務・状態・境界（依存の切れ目）が同一かどうかで判断する。
- クラス名・関数名などの実装構造には依存しない名称とする。

| `uts-<term>`        | 対象の要約                               |
| ------------------- | ---------------------------------------- |
| `uts-sale-checkout` | 会計確定（計算・入力検証・状態遷移の核） |
| `uts-inventory`     | 在庫引当/減算/戻しの核                   |

### 8.4. 単体テストの境界（モック/スタブ方針）

- 単体テストでは **純粋なビジネス判断・計算・遷移の正しさ** を担保する。
- 外部依存は単体の境界で切り、結合以降で実接続・整合性を担保する。

| 区分       | 内容                                                    |
| ---------- | ------------------------------------------------------- |
| 境界で切る | DB I/O、外部決済、帳票/ファイル出力、外部在庫連携、時刻 |
| 依存の扱い | リポジトリはモック、外部 API はスタブ、時刻は固定       |
| 結合で担保 | 実接続、トランザクション整合性、同時実行制御            |

### 8.5. 分配方針（TPC → `uts-<term>`）

- `uts-<term>` ごとに担当するTPC（または観点範囲）を示し、分配理由（責務/境界/関心分離）を記述する。
- 例外系・境界条件は、原則「その判断を行う責務を持つ `uts-<term>`」に割り当て、重複を避ける。

| `uts-<term>`        | 担当するTPC（例）                                 | コメント                         |
| ------------------- | ------------------------------------------------- | -------------------------------- |
| `uts-sale-checkout` | `tpc-sale-checkout` の会計計算/取消/返品/権限制御 | 会計の核ロジックを単体で担保     |
| `uts-inventory`     | `tpc-sale-checkout` の在庫連動/在庫不足           | 在庫の計算・不足判定を単体で担保 |

### 8.6. 共通合格基準とエビデンス

| 項目         | 合格基準（例）        | エビデンス（例）          |
| ------------ | --------------------- | ------------------------- |
| 実行結果     | 単体テスト失敗 0 件   | CI のテストレポート       |
| 未解決不具合 | Blocker/Critical 0 件 | 不具合管理票/チケット一覧 |

### 8.7. 個別仕様一覧（`uts-<term>`）

- `uts-sale-checkout`
- `uts-inventory`

### 8.8. 対象外・除外理由

- DB 制約・トランザクション整合性: 結合テストで担保する（単体では DB をモックするため）。
- 外部 API の実接続・疎通: 結合テストで担保する。
- 同時実行制御・性能/負荷: 非機能テストで担保する。

### 8.9. メモ / 将来課題

- `uts-<term>` の粒度見直し（例: 在庫と会計の境界が変更された場合の再分配）。
- 共通合格基準に静的解析/カバレッジ等を追加するかの検討（追加する場合は数値基準を明記）。

## 9. 生成 AI への指示テンプレート

生成 AI に `uts-index` を作らせるときの指示テンプレートは [uts-instruction.md](../instructions/uts-instruction.md) を参照してください。
