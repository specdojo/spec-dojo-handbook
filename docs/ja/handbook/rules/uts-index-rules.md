# 単体テスト仕様 全体構成 作成ルール

(Unit Test Specification Index Rules: UTS Index Rules)

本ドキュメントは、単体テスト仕様のうち **全体構成（Index）= `uts-index`** を統一形式で記述するための標準ルールです。
`uts-index` は、TPC で整理された観点・条件を単体テストの責務として解釈し、個別単体テスト仕様（`uts-<term>`）へ分配するための **入口（ナビゲーション）** になります。

個別単体テスト仕様（`uts-<term>`）の記述ルールは [uts-rules.md](uts-rules.md) で定義します。

## 1. 目的

`uts-index` に以下を明文化し、単体テストの責務・境界・合格基準の認識ズレを防ぎます。

- TPC の観点・条件を「単体テストの責務」としてどう解釈するか
- 観点・条件を **対象単位（`uts-<term>`）** にどう分配するか（分配方針）
- 単体テストの **共通前提**（対象単位の定義、モック/スタブ境界）
- 単体レベルの **共通合格基準**（品質ゲートに影響するもの）
- 個別仕様（`uts-<term>`）へのナビゲーション（一覧・リンク）

## 2. 基本原則

- `uts-index` は **方針・基準・分配**までを扱い、個別の詳細条件やテストケースは扱いません。
- トレース表（観点ID↔上位仕様IDの表）は原則 TPC に集約し、`uts-index` は Frontmatter の `based_on` で追跡可能にします。
- 曖昧表現（例:「十分に」「適切に」）は禁止し、判定可能な言葉（対象/境界/基準/エビデンス）で書きます。

## 3. ファイル命名・ID規則

- 本ドキュメント（全体構成）の `id` は `uts-index` 固定とします。
- 個別仕様は `uts-<term>` とします（詳細は [uts-rules.md](uts-rules.md)）。
- ファイル名は`uts-010-単体テスト仕様-全体構成.md` 等、プロジェクト内で一意になるように命名します。

## 4. 推奨 Frontmatter 項目

Frontmatter は共通スキーマに従います（あわせてメタ情報ルールも参照）。

- 参照スキーマ: [docs/shared/schemas/spec-frontmatter.schema.yaml](../../../shared/schemas/spec-frontmatter.schema.yaml)
- メタ情報ルール: [meta-document-metadata-rules.md](meta-document-metadata-rules.md)

| 項目       | 説明                                               | 必須 |
| ---------- | -------------------------------------------------- | ---- |
| id         | `uts-index`（固定）                                | ○    |
| type       | `test` 固定                                        | ○    |
| title      | 単体テスト仕様: 全体構成                           | ○    |
| status     | `draft` / `ready` / `deprecated`                   | ○    |
| part_of    | `[]`（`uts-index` 自身は親なので通常は空配列）     | 任意 |
| based_on   | 根拠となる仕様ID（ID配列。未指定時は `[]` を許容） | 任意 |
| supersedes | 置き換え関係（ID配列。未指定時は `[]` を許容）     | 任意 |

推奨:

- `based_on` には最低限 `tpc-...` を含めます（必要に応じて BAC/NFR/BR 等も列挙）。
- `part_of` / `based_on` / `supersedes` は ID 配列で記載し、未指定の場合も `[]` として明示してよいです。

## 5. 本文構成（標準テンプレ）

`uts-index` は以下の見出しを順番に並べます。

1. 概要
2. 対象単位の定義（用語・粒度・命名）
3. 単体テストの境界（モック/スタブ方針）
4. 分配方針（TPC → `uts-<term>`）
5. 共通合格基準とエビデンス（単体レベル）
6. 個別仕様一覧（`uts-<term>` へのリンク）
7. 対象外 / 除外理由
8. メモ / 将来課題

## 6. 記述ガイド

### 6.1 分配方針の最小要素

`uts-index` の中核は「分配方針」です。最低限、次を含めます。

- 対象単位（`uts-<term>`）の一覧と定義
- 各対象単位が担う保証範囲（TPC の観点・条件をどう割り当てたか）
- 単体で担保する範囲/結合以降へ委譲する範囲（境界の判断）

推奨の表（例）:

| `uts-<term>`    | 対象の要約           | 担当するTPC                           | 境界（単体で切るもの） |
| --------------- | -------------------- | ------------------------------------- | ---------------------- |
| `uts-inventory` | 在庫引当・減算・戻し | `tpc-sale-checkout` の TP-02/TP-03 等 | DB/外部在庫I/F         |

### 6.2 `uts-index` に書かないこと

- 個別ロジックの詳細条件（具体値・網羅ケース）
- テストケース（ケース展開・手順・期待結果の逐語列挙）
- テストコード（クラス/メソッド/フレームワーク設定）

## 7. 禁止事項

| 項目                                    | 理由                                          |
| --------------------------------------- | --------------------------------------------- |
| `uts-<term>` の本文と同じ内容の重複記載 | 更新漏れの温床                                |
| ケース/手順/具体値の列挙                | 下位（UTD/コード）へ委譲すべき                |
| 未定義のメタ情報プロパティ追加          | スキーマ違反（`additionalProperties: false`） |

## 8. サンプル（最小）

### メタ情報

```yaml
---
id: uts-index
type: test
title: 単体テスト仕様: 全体構成（駄菓子屋販売管理システム）
status: draft
part_of: []
based_on:
  - tsp-overview
  - tpc-sale-checkout
  - bac-sale-checkout
  - bac-inventory-replenishment
supersedes: []
---
```

### 概要

単体テストで担保する保証範囲・境界・合格基準を定義し、TPC の観点・条件を対象単位（`uts-<term>`）へ分配する。

### 対象単位の定義（例）

| `uts-<term>`        | 対象の要約                               |
| ------------------- | ---------------------------------------- |
| `uts-sale-checkout` | 会計確定（計算・入力検証・状態遷移の核） |
| `uts-inventory`     | 在庫引当/減算/戻しの核                   |

### 境界（例）

- DB I/O・外部決済・帳票出力・時刻はモック/スタブで境界を切る（実接続は結合以降で担保）

### 分配方針（例）

| `uts-<term>`        | 担当するTPC（例）                                 | コメント                     |
| ------------------- | ------------------------------------------------- | ---------------------------- |
| `uts-sale-checkout` | `tpc-sale-checkout` の会計計算/取消/返品/権限制御 | 会計の核ロジックを単体で担保 |
| `uts-inventory`     | `tpc-sale-checkout` の在庫連動/在庫不足           | 在庫計算・判定を単体で担保   |

### 共通合格基準とエビデンス（例）

| 項目         | 合格基準（例）        | エビデンス          |
| ------------ | --------------------- | ------------------- |
| 実行結果     | 失敗 0 件             | CI のテストレポート |
| 未解決不具合 | Blocker/Critical 0 件 | 不具合管理票        |

### 個別仕様一覧（例）

- `uts-sale-checkout`
- `uts-inventory`

## 9. 生成 AI への指示テンプレート

生成 AI に `uts-index` を作らせるときの指示テンプレートは [uts-instruction.md](../instructions/uts-instruction.md) を参照してください。
