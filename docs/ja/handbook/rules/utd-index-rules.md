# 単体テスト設計（UTD）作成ルール

本ドキュメントは、単体テスト仕様（UTS）に基づき、
**単体テストをどのように設計し、テストコードへ落とし込むか**を統一形式で記述するための標準ルールです。

UTD（Unit Test Design）は、

- 単体テスト仕様（UTS）で定義された保証範囲を前提に
- **テスト観点 × テスト条件 × ケース構成**を整理し
- テストコード（JUnit 等）を **迷いなく実装・レビューできる状態**を作る

ことを目的とします。

---

## 1. 全体方針

- UTD は **単体テスト仕様（UTS）の下位成果物**です。
  - UTD 単体で意味を持たせず、必ず上位仕様を参照します。

- UTD は **テストコードそのものではありません**。
  - ただし、テストコードと 1 対 1 で追跡可能であることを重視します。

- UTD の主眼は以下です。
  - ケースの分解方針（どの観点×条件をどう組み合わせるか）
  - テストコード構成の方針（クラス/ファイル/命名/配置）
  - 実行方法・結果参照先の明確化

- 数値・具体データは **必要最小限のみ記載**します。
  - 境界値・代表値を示すのは可
  - 大量のパラメータ列挙は禁止

- 原則として UTD は **全体設計（`utd-main`）**のみを扱います。
  - 個別のテストケース設計は UTD-D（`utd-<term>`）に寄せます。

---

## 2. 位置づけ（ドキュメント階層）

UTD は以下の階層に位置します。

```plaintext
TSP（テスト戦略・方針）
  ↓
TPC（テスト観点・条件）
  ↓
UTS（単体テスト仕様・全体）
  ↓
UTD（単体テスト設計） ← 本ドキュメント
  ↓
テストコード（JUnit 等）
```

---

## 3. ファイル命名・ID規則

### ファイル名

```text
020-単体テスト設計.md
```

例:

- `020-単体テスト設計.md`（全体設計）

### ID 規則

- `id`: `utd-main`
- prefix は必ず `utd-` を使用します

---

## 4. 推奨 Frontmatter 項目

| 項目       | 説明                                             | 必須 |
| ---------- | ------------------------------------------------ | ---- |
| id         | UTD ID（`utd-...`）                              | ○    |
| type       | `test` 固定                                      | ○    |
| title      | 単体テスト設計: <対象名>                         | ○    |
| status     | `draft` / `ready` / `deprecated`                 | ○    |
| based_on   | 上位仕様（`uts-*`, `tpc-*`, `br-*`, `bac-*` 等） | 必須 |
| supersedes | 置き換え関係                                     | 任意 |

### 推奨

- `based_on` には `uts-main` を必ず含めます。
- `tests` にはテストコードの場所（パスや論理名）を記載可能です。

---

## 5. 本文構成（標準テンプレ）

UTD は以下の見出し構成を **必ず守ります**。

1. 概要
2. 設計対象と前提
3. ケース分解方針
4. テストケース設計（観点 × 条件）
5. テストコード構成・命名
6. テストデータ・モック方針
7. 実行方法・結果参照
8. メモ / 留意事項

---

## 6. 記述ガイド詳細

### 6.1 概要

- この設計が **どの UTS（原則: `uts-main`）を具体化するものか**を明示します。
- 対象の単体テストで **どこまで設計で決めるか**を簡潔に書きます。

---

### 6.2 設計対象と前提（必須）

#### 推奨の書き方

| 項目         | 内容                   |
| ------------ | ---------------------- |
| 対象         | 単体テスト設計（全体） |
| 対応仕様     | uts-main               |
| 前提         | 外部API・DBはモック化  |
| テスト対象外 | 性能、並行実行         |

---

### 6.3 ケース分解方針（必須）

UTD の最重要セクションです。

#### 基本方針

- テストケースは **「観点 × 条件」**で分解します。
- 観点は **UTD-D 側で UTS（個別）（必要に応じて UTS-D）**から取得します。
- 条件は **状態レベル**で整理し、値は最小限に留めます。

#### 記述例

| 観点ID  | 分解方針                         |
| ------- | -------------------------------- |
| UT-I-01 | 正常系は代表1ケース＋境界1ケース |
| UT-I-02 | 境界値（最小/最大）を各1ケース   |
| UT-I-03 | 入力不正パターンを分類単位で網羅 |

> すべての組合せを作るのではなく、「保証に十分な代表集合」を設計します。

---

### 6.4 テストケース設計（必須）

ここでは **ケースの構造**を示します。
※ テストコードの写経は禁止。

#### 推奨カラム

| ケースID | 観点ID  | 条件ID | 入力の考え方 | 期待結果 | 備考 |
| -------- | ------- | ------ | ------------ | -------- | ---- |
| UTC-01   | UT-I-01 | UC-01  | 正常入力     | 正常完了 |      |
| UTC-02   | UT-I-02 | UC-02  | 境界値       | 引当不可 |      |
| UTC-05   | UT-I-03 | UC-05  | 不正入力     | エラー   |      |

記述のコツ:

- 入力値は「考え方」で書く（具体値はコード側）
- 期待結果は **方向性**まで（メッセージ文言等は不要）

---

### 6.5 テストコード構成・命名（必須）

テストコードの **置き場所・構成・命名規則**を示します。

#### 推奨記述内容

| 項目             | 内容例                            |
| ---------------- | --------------------------------- |
| テストクラス配置 | `<module>/test/.../InventoryTest` |
| クラス命名       | `<対象名>Test`                    |
| メソッド命名     | `<条件>_<期待結果>`               |
| 観点との対応     | コメントで観点IDを付与            |

> 実装言語やフレームワークに依存しすぎない書き方を心がけます。

---

### 6.6 テストデータ・モック方針（必須）

#### 推奨の書き方

| 対象       | 方針               |
| ---------- | ------------------ |
| リポジトリ | モックで戻り値制御 |
| 時刻       | 固定クロック       |
| 乱数       | 固定シード         |

---

### 6.7 実行方法・結果参照（必須）

#### 記載例

| 項目     | 内容                        |
| -------- | --------------------------- |
| 実行方法 | CI またはローカルで自動実行 |
| 実行単位 | モジュール単位              |
| 結果参照 | CI レポート、JUnit レポート |

---

### 6.8 メモ / 留意事項

- 実装変更時の注意点
- 将来追加予定のケース

---

## 7. 禁止事項

| 項目             | 理由           |
| ---------------- | -------------- |
| テストコード全文 | 設計書の役割外 |
| SQL・物理名      | 実装依存       |
| 値の総当たり列挙 | 保守不能       |
| 曖昧表現         | 合否不明       |

---

## 8. サンプル（最小）

```yaml
---
id: utd-main
type: test
title: 単体テスト設計: 全体（店頭販売＋在庫連動）
status: draft
based_on:
  - uts-main
  - tsp-overview
  - tpc-sale-checkout
  - bac-sale-checkout
  - nfr-security
supersedes: []
---
```

### 概要

本ドキュメントは、販売管理システム（店頭販売＋在庫連動）における単体テストの設計方針を定義し、UTS/UTS-D で定義した保証範囲をテストコードへ落とし込むための共通ルール（分解方針、命名、モック方針、実行方法）を提供する。

### 設計対象と前提

| 項目         | 内容                                                                   |
| ------------ | ---------------------------------------------------------------------- |
| 対象範囲     | ドメインロジック（会計計算、割引、在庫引当、取引状態遷移など）         |
| 前提         | 外部 API・DB I/O は境界で切り、モック/スタブで制御する                 |
| テスト対象外 | DBトランザクション整合性、同時実行制御、外部決済連携（結合以降で担保） |
| 成果物の分担 | `utd-main` は共通方針と一覧、個別のケース一覧は UTD-D（`utd-<term>`）  |

### ケース分解方針

- ケースは「観点（保証）× 条件（状態）× 期待結果」で分解する。
- “総当たり”は避け、代表集合（正常・境界・例外・状態）で設計する。
- 観点ID/条件IDは UTS（個別）/ UTS-D で定義したものを基本として使用し、必要な場合のみ UTD-D で補助的に追加する。

### テストケース設計（観点 × 条件）

| 対象（UTS）           | 個別設計（UTD-D）     | 代表ケースの方針（例）                                           |
| --------------------- | --------------------- | ---------------------------------------------------------------- |
| uts-inventory         | utd-inventory         | 在庫十分/在庫不足/入力不正を代表化し、境界は必要最小限に追加     |
| uts-price-calculation | utd-price-calculation | 税/割引の組み合わせは代表集合で設計し、総当たりを避ける          |
| uts-transaction-state | utd-transaction-state | 状態遷移（確定/取消/返品など）を代表遷移で担保し、禁止遷移も含む |

> 補足: UTS-D（個別詳細）がある場合は、対応する UTD-D の根拠として `based_on` に追加して構いません（例: `uts-inventory-allocation`）。

### テストコード構成・命名

| 項目         | ルール例                           |
| ------------ | ---------------------------------- |
| クラス命名   | `<対象名>Test`                     |
| メソッド命名 | `<条件>_<期待結果>`                |
| 観点との対応 | テスト名またはコメントで観点ID付与 |

### テストデータ・モック方針

| 依存       | 方針                 |
| ---------- | -------------------- |
| リポジトリ | モックで戻り値制御   |
| 時刻       | 固定クロック         |
| 乱数       | 固定シード（必要時） |

### 実行方法・結果参照

| 項目     | 内容                        |
| -------- | --------------------------- |
| 実行方法 | CI またはローカルで自動実行 |
| 結果参照 | CI レポート、JUnit レポート |

### メモ / 留意事項

- 個別のケース一覧・データ詳細は UTD-D に寄せ、`utd-main` は共通方針に限定する。
- 業務ルール追加（割引種別、予約在庫など）時は、対応する UTS（必要に応じて UTS-D）と UTD-D を追加/更新する。

---

## 9. 生成AIへの指示テンプレート

> 以下のルールに従って **単体テスト設計（UTD）** を作成してください。
>
> - 入力は UTS（単体テスト仕様・個別）または UTS-D（単体テスト仕様・個別詳細）です。
> - ケースは「観点 × 条件」で分解し、代表ケースを設計してください。
> - テストコードの全文や具体値は書かないでください。
> - テストコードの構成・命名・実行方法が分かるようにしてください。
