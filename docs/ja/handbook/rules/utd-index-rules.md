# 単体テスト設計 全体構成 作成ルール

Unit Test Design Index (UTD Index) Documentation Rules

本ドキュメントは、単体テスト設計のうち **全体構成（Index）= `utd-index`** を統一形式で記述するための標準ルールです。
`utd-index` は、単体テスト仕様（UTS）で定義された保証範囲を、テストコードへ落とし込むための **共通設計方針（ケース分解・命名・実行・エビデンス）** と、個別単体テスト設計（`utd-<term>`）への **入口（ナビゲーション）** を提供します。

個別単体テスト設計（`utd-<term>`）の記述ルールは [utd-rules.md](utd-rules.md) で定義します。

## 1. 目的

`utd-index` に以下を明文化し、設計〜実装〜レビューの迷いと抜け漏れを減らします。

- UTS（特に `uts-index` / `uts-<term>`）を、単体テストケースへ分解する共通方針
- ケース設計の粒度・代表集合の作り方（総当たり回避の基準）
- テストデータ/モック/スタブの共通方針（単体の境界の固定）
- テストコード構成・命名・配置の共通方針
- 実行方法・結果参照（エビデンス）の共通方針
- 個別設計（`utd-<term>`）へのナビゲーション（一覧・リンク）

## 2. 基本原則

- `utd-index` は **共通方針・共通基準・ナビゲーション**を扱い、個別のケース一覧・具体値は扱いません。
- `utd-index` は **テストコードそのものではありません**（ただし、コードへ落とせる具体性は必要）。
- トレースは Frontmatter の `based_on` を基本とし、上位成果物（UTS/TPC/BAC/NFR 等）への追跡可能性を担保します。
- 曖昧表現（例:「十分に」「適切に」）は禁止し、判定可能な言葉（対象/境界/基準/エビデンス）で書きます。
- 未定義プロパティの追加は禁止です（`additionalProperties: false`）。

## 3. ファイル命名・ID規則

- 本ドキュメント（全体構成）の `id` は `utd-index` 固定とします。
- 個別設計は `utd-<term>` とします（詳細は [utd-rules.md](utd-rules.md)）。
- ファイル名は `utd-020-単体テスト設計-全体構成.md` 等、プロジェクト内で一意になるように命名します。

## 4. 推奨 Frontmatter 項目

Frontmatter は共通スキーマに従います（あわせてメタ情報ルールも参照）。

- 参照スキーマ: `docs/handbook/shared/schemas/spec-frontmatter.schema.yaml`
- メタ情報ルール: [meta-document-metadata-rules.md](meta-document-metadata-rules.md)

| 項目       | 説明                                               | 必須 |
| ---------- | -------------------------------------------------- | ---- |
| id         | `utd-index`（固定）                                | ○    |
| type       | `test` 固定                                        | ○    |
| title      | 単体テスト設計: 全体構成                           | ○    |
| status     | `draft` / `ready` / `deprecated`                   | ○    |
| part_of    | `[]`（`utd-index` 自身は親なので通常は空配列）     | 任意 |
| based_on   | 根拠となる仕様ID（ID配列。未指定時は `[]` を許容） | 任意 |
| supersedes | 置き換え関係（ID配列。未指定時は `[]` を許容）     | 任意 |

推奨:

- `based_on` には最低限 `uts-index` を含めます（必要に応じて `tpc-...` / BAC / NFR 等も列挙）。
- `part_of` / `based_on` / `supersedes` は ID の配列で記載し、未指定の場合も `[]` として明示してよいです。

## 5. 本文構成（標準テンプレ）

`utd-index` は以下の見出しを順番に並べます。

1. 概要
2. 設計対象の範囲と前提（単体の境界）
3. ケース分解ポリシー（観点 × 条件 → 代表ケース）
4. テストデータ・モック/スタブの共通方針
5. テストコード構成・命名・配置
6. 実行方法・結果参照（エビデンス）
7. 個別設計一覧（`utd-<term>` へのリンク）
8. 対象外 / 除外理由
9. メモ / 留意事項

## 6. 記述ガイド

### 6.1 ケース分解ポリシーの最小要素

`utd-index` の中核は「ケース分解ポリシー」です。最低限、次を含めます。

- 観点（保証）をどう分類し、どの粒度でケースにするか
- 条件（状態）をどう表現し、どこまでを設計に書くか（具体値の扱い）
- 代表集合の考え方（総当たり回避の基準・例外）

推奨の表（例）:

| 観点分類 | 代表ケースの作り方（例）                     | 具体値の扱い                                          |
| -------- | -------------------------------------------- | ----------------------------------------------------- |
| 正常     | 代表1 + 境界1                                | 数値は原則「境界値」として扱い、値は個別設計/コードへ |
| 境界     | 最小/最大/0 などの代表                       | 値は必要最小限のみ明記                                |
| 例外     | 入力不正/状態不正/依存失敗（モック）に分ける | 例外種別の期待結果を明示                              |

### 6.2 個別設計への分配（ナビゲーション）

`utd-index` は、UTS と個別設計を対応づけて辿れるようにします。

推奨の表（例）:

| UTS（根拠）         | 個別設計（UTD）     | コメント                           |
| ------------------- | ------------------- | ---------------------------------- |
| `uts-sale-checkout` | `utd-sale-checkout` | 会計計算・入力検証の代表ケース設計 |
| `uts-inventory`     | `utd-inventory`     | 在庫引当/減算/戻しの代表ケース設計 |

### 6.3 `utd-index` に書かないこと

- 個別ロジックの大量ケース一覧（肥大化する場合は `utd-<term>` に分割）
- テストコード（クラス/メソッド/フレームワーク設定）の全文
- 具体値の総当たり（必要なら「境界値」「代表値」レベルで方針のみ）

## 7. 禁止事項

| 項目                                             | 理由                                          |
| ------------------------------------------------ | --------------------------------------------- |
| 未定義のメタ情報プロパティ追加（例: `tests` 等） | スキーマ違反（`additionalProperties: false`） |
| テストケースの大量列挙（ケース表が肥大化する）   | 個別設計（`utd-<term>`）へ分割すべき          |
| テストコード全文の貼り付け                       | ドキュメントの役割外                          |
| 値の総当たり列挙                                 | 保守不能、意図が伝わらない                    |

## 8. サンプル（最小）

### メタ情報

```yaml
---
id: utd-index
type: test
title: 単体テスト設計: 全体構成（店頭販売＋在庫連動）
status: draft
part_of: []
based_on:
  - uts-index
  - tsp-overview
  - tpc-sale-checkout
  - bac-sale-checkout
  - nfr-security
supersedes: []
---
```

### 概要

単体テスト仕様（UTS）で定義した保証範囲を、代表ケースの集合へ分解し、テストコードへ落とし込むための共通設計方針（命名・モック・実行・エビデンス）を定義する。

### ケース分解ポリシー（例）

- ケースは「観点（保証）× 条件（状態）× 期待結果」で表現する。
- “総当たり”は避け、正常・境界・例外・状態の代表集合で設計する。
- 具体値は必要最小限とし、値の網羅は個別設計/コードへ委譲する。

### 個別設計一覧（例）

- `utd-sale-checkout`（根拠: `uts-sale-checkout`）
- `utd-inventory`（根拠: `uts-inventory`）

## 9. 生成 AI への指示テンプレート

生成 AI に `utd-index` を作らせるときは、以下の制約で指示します。

- 入力は `uts-index` と、必要に応じて主要な `uts-<term>` とする
- `utd-index` は共通方針・共通基準・ナビゲーションのみ（個別の大量ケースは書かない）
- 未定義のメタ情報項目は追加しない
- 具体値・テストコード全文は書かない（必要なら「境界値」「代表値」など方針レベルで示す）
