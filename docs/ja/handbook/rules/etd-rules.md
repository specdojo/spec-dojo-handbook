# 外部結合テスト設計（ETD）作成ルール

本ドキュメントは、品質保証・テスト実装のために
**外部結合テスト設計（External Integration Test Design: ETD）**
を統一形式で記述する標準ルールです。

ETD は、

- 外部結合テスト仕様（ETS / ETS-D）で定義された
- **保証観点・テスト条件**
- を **どのようにテストとして具体化・実行するか**

を **実装に落とし込めるレベル**で設計することを目的とします。

---

## 0. 位置づけ（必読）

ETD は「仕様」と「実装」の橋渡しとなる設計成果物です。

```plaintext
TSP（テスト戦略・方針）
 └ ETS（外部結合テスト仕様・全体）
    └ ETS-D（外部結合テスト仕様・個別）
       └ ETD（外部結合テスト設計） ← 本書
          └ テスト実装・実行（JUnit / Newman / CI 等）
```

| 観点   | ETS / ETS-D      | ETD                              |
| ------ | ---------------- | -------------------------------- |
| 役割   | 何を保証するか   | **どうやって確認するか**         |
| 主眼   | 契約・境界・運用 | **テスト構成・切り方・実行方法** |
| ケース | 代表条件のみ     | **ケース構造を設計**             |
| 実装   | 言及しない       | 参照先を明示                     |

---

## 1. 全体方針

- ETD は **外部結合テストの実行設計書**です。
- 「ケース一覧表＝設計」ではありません。
- 実装コード（JUnit / Postman / スクリプト等）を直接貼ることは原則禁止です。
- ETD の責務は以下です。
  - テスト単位の定義
  - ケース分解の軸（振る舞い × 状態 × 障害）
  - テスト環境・外部接続方式の切り替え方
  - 実行・自動化・エビデンス取得方法

---

## 2. 対象と粒度

### 対象

- 外部結合テスト全体（ETS-main に対応）
- または、複数の ETS-D（外部連携群）を束ねた設計

### 粒度の原則

- **ETD = 外部結合テストの共通設計**
- 個別外部システムごとの差分は、次段の **ETD-D（個別設計）** に委譲します。

---

## 3. ファイル命名・ID規則

### ファイル名（推奨）

```sh
020-外部結合テスト設計.md
```

### Frontmatter

| 項目   | ルール                       |
| ------ | ---------------------------- |
| id     | `etd-main`                   |
| type   | `test`                       |
| title  | 外部結合テスト設計           |
| status | `draft / ready / deprecated` |

---

## 4. 推奨 Frontmatter 項目

| 項目       | 説明                           | 必須     |
| ---------- | ------------------------------ | -------- |
| id         | ETD ID                         | ○        |
| type       | `test` 固定                    | ○        |
| title      | 設計名                         | ○        |
| status     | 状態                           | ○        |
| version    | SemVer                         | 任意     |
| owners     | 担当                           | 任意     |
| depends_on | ETS / ETS-D                    | **必須** |
| tests      | 実装（テストコード・CIジョブ） | 任意     |

---

## 5. 本文構成（標準テンプレ）

ETD は以下の見出しを **必ずこの順序**で記述します。

1. 概要
2. 対象範囲
3. テスト単位の設計
4. ケース設計方針
5. テスト環境・外部接続設計
6. テストデータ設計方針
7. 実行・自動化方針
8. 結果確認・エビデンス取得方法
9. 対象外
10. メモ / 将来課題

---

## 6. 記述ガイド詳細

### 6.1 概要

- 本 ETD が **どの外部結合テストを対象とするか**を明確にします。
- ETS / ETS-D との対応関係を文章で示します。

例:

> 本設計は、外部結合テスト仕様（ETS-main）および決済サービス連携に関する個別仕様（ETS-payment）に基づき、外部結合テストの設計方針を定義する。

---

### 6.2 対象範囲（必須）

#### 推奨（表）

| 項目         | 内容                      |
| ------------ | ------------------------- |
| 対象外部連携 | 決済、仕入先              |
| 対象仕様     | ets-payment, ets-supplier |
| テストレベル | 外部結合テスト            |
| 実行環境     | 結合 / システム           |

---

### 6.3 テスト単位の設計（必須）

**どの単位でテストを分割するか**を定義します。

例:

| テスト単位   | 説明                         |
| ------------ | ---------------------------- |
| 連携単位     | 外部API / Webhook / ファイル |
| パターン単位 | 正常 / 例外 / 冪等 / 障害    |
| 業務単位     | 発注 / 決済 / 取消           |

※ クラス名・関数名は禁止。論理単位で記述します。

---

### 6.4 ケース設計方針（最重要）

外部結合のケース設計は **内部結合よりも障害軸を重視**します。

#### 推奨整理

| 軸       | 内容                     |
| -------- | ------------------------ |
| 振る舞い | 正常 / 契約逸脱 / 例外   |
| 障害     | タイムアウト / 5xx / 4xx |
| 冪等     | 再送 / 重複              |
| 運用     | 手動復旧 / 再実行        |

ポイント:

- **全組合せは作らない**
- ETS-D で定義した「保証観点」を必ず網羅する

---

### 6.5 テスト環境・外部接続設計（必須）

外部結合では **環境差異**が最重要です。

| 項目     | 方針                       |
| -------- | -------------------------- |
| 接続方式 | 実接続 / スタブ / モック   |
| 環境切替 | 設定値で切替可能           |
| 本番限定 | 代替試験 or 運用リハーサル |

---

### 6.6 テストデータ設計方針

| 観点       | 方針           |
| ---------- | -------------- |
| データ生成 | テスト用データ |
| ID         | 相関IDを必須   |
| 再実行     | 冪等キー利用   |

---

### 6.7 実行・自動化方針

| 項目     | 方針                         |
| -------- | ---------------------------- |
| 実行     | 自動（CI）                   |
| ツール   | Postman / JUnit / 専用ツール |
| 実行頻度 | nightly / release前          |
| 失敗時   | 手動確認                     |

---

### 6.8 結果確認・エビデンス取得方法

| 観点 | エビデンス            |
| ---- | --------------------- |
| 応答 | リクエスト/レスポンス |
| 再送 | 再送履歴              |
| 冪等 | 状態不変              |
| 追跡 | 相関IDログ            |

---

### 6.9 対象外

- 外部サービス内部処理
- SLA 違反検証（契約対応）

---

### 6.10 メモ / 将来課題

- 外部仕様変更検知
- 本番検証の自動化検討

---

## 7. 禁止事項

| 禁止            | 理由         |
| --------------- | ------------ |
| 秘密情報の記載  | セキュリティ |
| SQL / JSON 全文 | 実装依存     |
| 実装クラス名    | 抽象度低下   |
| ケース全列挙    | 保守不能     |

---

## 8. サンプル（最小）

```yaml
---
id: etd-main
type: test
title: 外部結合テスト設計
status: draft
version: '1.0.0'
depends_on:
  - ets-main
  - ets-payment
---
```

---

## 9. 生成AI向け指示テンプレート

> - 以下のルールに従って **外部結合テスト設計（ETD）** を作成してください。
> - 対象は ETS / ETS-D で定義された外部連携です。
> - 個別テスト値や実装コードは書かず、**テスト単位・ケース設計方針・環境設計・実行方針**を記述してください。
