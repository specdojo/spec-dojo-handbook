---
id: dmd-rules
title: データ移行設計 作成ルール
type: rulebook
status: draft
---

Data Migration Design (DMD) Documentation Rules

本ドキュメントは、データ移行設計ドキュメント（`dmd-index` / `dmd-<term>`）を統一形式で記述するためのルールです。
旧→新のデータ移行を再現可能に定義し、品質（正確性・完全性）を担保するための内容を定義します。

## 1. 全体方針

`dmd-index`（必要に応じて `dmd-<term>`）は、移行対象データの仕様、変換、実行、検証を **再現可能** な粒度で整理し、品質を担保するための SSOT とする。

- 対象データは「何を・どこから・どこへ・どの条件で移すか」を明確にする
- 抽出方式（フル/増分）と増分基準（基準カラム/キー/基準時刻）を明記し、同条件で再実行できるようにする
- 変換ルールと除外ルールは **再実行しても同じ結果** になる形で記載する
- 移行手順は「手動/バッチ/ツール」を明示し、入出力（形式/置き場）・ログ・再実行性を担保する
- 検証は **件数照合/サンプル照合/重要値照合** を最低限含め、合格基準（差分0 / 許容差ε）を明確にする

運用方針（index/term 分割）:

- 原則 `dmd-index` を作成し、データ移行設計の入口（SSOT）とする
- `dmd-<term>` は、データ領域（例：受注/請求/在庫）やデータセット単位で作成する
- `dmd-<term>` を追加する場合でも、共通方針（抽出方式の扱い、run_id規約、冪等性、検証の種類など）は `dmd-index` を正とする
- **「関連ドキュメント」セクションは必須**（分冊が無い場合でも `（本書のみ）` を明記）

## 2. 位置づけ

`dmd-index` / `dmd-<term>` と他ドキュメントの関係を示します。必要に応じて Mermaid による図を使用してよい。

- `mip-index`：移行の合意・判断のSSOT（成功条件・カットオーバー骨格を含む）
- **`dmd-index`/ `dmd-<term>`：データ移行の詳細設計（マッピング/変換/検証）**
- `mtp-index` / `mtp-<term>`：リハーサル計画・検証設計（観点/手順/証跡）
- `cop-index` / `cop-<term>`：当日実行の詳細手順（Runbook）
- `otp-index` / `otp-<term>`：運用切替の詳細（監視設定/運用手順/窓口）

## 3. ファイル命名・ID規則

- `id` は `dmd-index` または `dmd-<term>`（kebab-case。例: `dmd-order-data`）。
- ファイル名は `dmd-010-データ移行設計.md` / `dmd-020-データ移行設計-<term>.md` 等、プロジェクト内で一意になるように命名する。
- `<term>` は用語集(GL)の論理名キー（英小文字kebab-case）を用いる（表示名は title / ファイル名で日本語を使用してよい）。

## 4. 推奨 Frontmatter 項目

### 4.1. 設定内容

Frontmatter は共通スキーマに従います（参照: [docs/shared/schemas/spec-frontmatter.schema.yaml](../../../shared/schemas/spec-frontmatter.schema.yaml) / [meta-document-metadata-rules.md](meta-document-metadata-rules.md)）。

| 項目       | 説明                                         | 必須 |
| ---------- | -------------------------------------------- | ---- |
| id         | DMD ID（`dmd-index` または `dmd-<term>`）    | ○    |
| type       | `migration` 固定                             | ○    |
| title      | データ移行設計: <対象名>                     | ○    |
| status     | `draft` / `ready` / `deprecated`             | ○    |
| based_on   | 根拠となる仕様ID（ID配列。未指定は `[]` 可） | 任意 |
| supersedes | 置き換え関係（ID配列。未指定は `[]` 可）     | 任意 |

### 4.2. 推奨ルール

- `based_on` には移行判断に直接利用した成果物（例: `mip-index` / `br-*` / `nfr-*` / `issue-*`）のみ列挙する
- `based_on` / `supersedes` は ID 配列（未指定は `[]` 可）

## 5. 本文構成（標準テンプレ）

`dmd-index` / `dmd-<term>` は以下の見出し構成を **順序固定** で配置します。

### 5.1. `dmd-index`（入口・共通SSOT）

| 番号 | 見出し                                            | 必須 |
| ---- | ------------------------------------------------- | ---- |
| 1    | 概要（index）                                     | ○    |
| 2    | 共通方針（抽出/変換/除外/冪等性/ログ）            | ○    |
| 3    | run_id 規約（命名/採番/記録/参照方法）            | ○    |
| 4    | 検証の共通方針（種別/基準/証跡/保管）             | ○    |
| 5    | 対象一覧（スコープ/非対象/担当/対応ドキュメント） | ○    |
| 6    | 関連ドキュメント（必須）                          | ○    |

### 5.2. `dmd-<term>`（個別SSOT）

| 番号 | 見出し                                            | 必須 |
| ---- | ------------------------------------------------- | ---- |
| 1    | 概要（`<term>`）                                  | ○    |
| 2    | 対象データ詳細（テーブル/期間/抽出条件/概算件数） | ○    |
| 3    | データマッピング                                  | ○    |
| 4    | 変換ルール                                        | ○    |
| 5    | 除外ルール                                        | ○    |
| 6    | 移行手順（手動/バッチ/ツール）                    | ○    |
| 7    | 性能/所要時間見積                                 | ○    |
| 8    | ログ/再実行性                                     | ○    |
| 9    | 検証方法（件数照合/サンプル照合/重要値）          | ○    |
| 10   | 関連ドキュメント（必須）                          | ○    |

## 6. 記述ガイド

### 6.1. 概要（index）

生成する `dmd-index` 本文の見出しは **## 1. 概要（index）**

- データ移行設計の目的（再現性・品質担保）と範囲（どのデータ群を扱うか）を 1〜3 行で示す
- 本書が入口（SSOT）であること、分冊がある場合は `dmd-<term>` に詳細があることを明記する

### 6.2. 共通方針（抽出/変換/除外/冪等性/ログ）

生成する `dmd-index` 本文の見出しは **## 2. 共通方針（抽出/変換/除外/冪等性/ログ）**

- 抽出（フル/増分）の採用方針と、増分基準の原則を記載する
- 変換/除外の原則（再実行して同一結果、根拠リンク）を記載する
- 冪等性の原則（方式の選択基準）と、ログ要件（最低限残す項目）を記載する

### 6.3. run_id 規約（命名/採番/記録/参照方法）

生成する `dmd-index` 本文の見出しは **## 3. run_id 規約（命名/採番/記録/参照方法）**

- run_id の命名（例: `DMD-YYYYMMDD-<term>-NN`）や採番方法を定義する
- run_id を「ログ・投入データ・照合レポート」に必ず紐づけることを定義する

推奨フォーマット（表）:

| 項目     | 方針 |
| -------- | ---- |
| 命名     |      |
| 採番     |      |
| 記録先   |      |
| 参照方法 |      |

### 6.4. 検証の共通方針（種別/基準/証跡/保管）

生成する `dmd-index` 本文の見出しは **## 4. 検証の共通方針（種別/基準/証跡/保管）**

- 検証種別（件数/サンプル/重要値）を最低限とする
- 合格基準の書き方（差分0 / 許容差ε）と、例外時の扱い（許容理由の明文化）を定義する
- 証跡（レポート/ログ）の保管場所と命名規約を定義する

### 6.5. 対象一覧（スコープ/非対象/担当/対応ドキュメント）

生成する `dmd-index` 本文の見出しは **## 5. 対象一覧（スコープ/非対象/担当/対応ドキュメント）**

- `mip-index` の移行対象（データ）と整合するように、対象/非対象を一覧化する
- 対象ごとに `dmd-<term>` への導線を持たせる（無い場合は作成予定/未着手を明記する）

推奨フォーマット（表）:

| 区分 | 対象（論理名） | 旧→新 | 方針（フル/増分） | 担当 | 対応DMD |
| ---- | -------------- | ----- | ----------------- | ---- | ------- |

### 6.6. 概要（`<term>`）

生成する `dmd-<term>` 本文の見出しは **## 1. 概要（`<term>`）**

- 対象データが何であり、どの移行範囲を扱うかを 1〜3 行で示す
- 依存する前提（移行方式、移行期間、上位の成功条件）を簡潔に述べる

### 6.7. 対象データ詳細（テーブル/期間/抽出条件/概算件数）

生成する `dmd-<term>` 本文の見出しは **## 2. 対象データ詳細（テーブル/期間/抽出条件/概算件数）**

- 対象テーブル/コレクションを列挙する
- 移行期間/抽出条件を明記する
- 抽出方式（フル/増分）と増分基準（基準カラム/キー/基準時刻）を明記する
- 概算件数（見積り根拠が分かる粒度）を示す

推奨フォーマット（表）:

| 対象 | 期間/抽出条件 | 方式（フル/増分） | 増分基準（カラム/キー/基準時刻） | 概算件数 | 備考 |
| ---- | ------------- | ----------------- | -------------------------------- | -------- | ---- |

### 6.8. データマッピング

生成する `dmd-<term>` 本文の見出しは **## 3. データマッピング**

- 旧→新の対応を明確に示す
- 1対多/多対1の関係は変換ルールと合わせて記述する
- 主キー/参照整合（FK相当）の扱い（維持/再採番/変換テーブル、投入順序の前提）を明記する

推奨フォーマット（表）:

| 旧データ | 新データ | 変換/補足 |
| -------- | -------- | --------- |

### 6.9. 変換ルール

生成する `dmd-<term>` 本文の見出しは **## 4. 変換ルール**

- 変換規則（正規化、コード変換、丸め、文字種変換等）を列挙する
- 再実行しても同じ結果になることを前提に記述する
- 変換の根拠（参照表/仕様ID）がある場合はリンクする

### 6.10. 除外ルール

生成する `dmd-<term>` 本文の見出しは **## 5. 除外ルール**

- 移行対象外となる条件を列挙する
- 除外理由（業務上の不要、期限切れ、品質不良等）を明記する
- 除外した場合の影響（参照のみ/業務に影響なし/代替手段あり）を必要に応じて追記する

### 6.11. 移行手順（手動/バッチ/ツール）

生成する `dmd-<term>` 本文の見出しは **## 6. 移行手順（手動/バッチ/ツール）**

- 手段（手動/バッチ/ツール）を明示する
- 実行順序と依存関係が分かる粒度で記述する
- 入出力（形式/置き場）と実行単位（ジョブ名/コマンド/ツール名）が分かるように記述する（詳細はリンクでよい）

推奨フォーマット（表）:

| 手順 | 内容 | 入力 | 出力 | 実行単位（ジョブ/コマンド） | 備考 |
| ---- | ---- | ---- | ---- | --------------------------- | ---- |

### 6.12. 性能/所要時間見積

生成する `dmd-<term>` 本文の見出しは **## 7. 性能/所要時間見積**

- 所要時間見積と前提条件（件数、並列度、スループット）を示す
- 目標時間がある場合は明記する
- ボトルネックが想定される場合は、暫定対策（並列化/分割/先行移行）を方針として記載してよい

### 6.13. ログ/再実行性

生成する `dmd-<term>` 本文の見出しは **## 8. ログ/再実行性**

- 実行ログの保存先と識別キー（例: `run_id`）を明記する
- 再実行条件（再投入可能範囲、冪等性の担保方法）を示す
- 冪等性方式を明記する（例: `upsert` / `run_id隔離` / `再投入前truncate` / `差分適用`）

推奨フォーマット（表）:

| 項目         | 方針                                       |
| ------------ | ------------------------------------------ |
| 識別キー     | run_id                                     |
| ログ保存先   | （例：S3/ログ基盤/DB）                     |
| 冪等性方式   | upsert / run_id隔離 / …                    |
| 再実行可否   | （例：同一run_id不可、別run_idで再実行可） |
| データ無効化 | （例：run_id単位で隔離/フラグ）            |

### 6.14. 検証方法（件数照合/サンプル照合/重要値）

生成する `dmd-<term>` 本文の見出しは **## 9. 検証方法（件数照合/サンプル照合/重要値）**

- 件数照合、サンプル照合、重要値照合の方法を明記する
- 合格基準は「差分0」か「許容差（ε）」かを明示する（理由も 1 行でよい）
- 検証結果の証跡（レポート/ログ）を示す

推奨フォーマット（表）:

| 検証種別 | 検証項目 | 方法 | 合格基準（差分0 / 許容差ε） | 証跡 |
| -------- | -------- | ---- | --------------------------- | ---- |

### 6.15. 関連ドキュメント（必須）

生成する `dmd-index` / `dmd-<term>` 本文の見出しは **## 6（indexの場合）/ ## 10（termの場合）. 関連ドキュメント**

- `dmd-index` の場合：各 `dmd-<term>` への導線を必ず記載する
- `dmd-<term>` の場合：`dmd-index`（入口SSOT）への導線を必ず記載する
- 分冊が無い場合でも `（本書のみ）` を明記する

## 7. 禁止事項

| 禁止事項                                                 | 理由                                                           |
| -------------------------------------------------------- | -------------------------------------------------------------- |
| 対象データの範囲（期間/抽出条件/件数/方式）を曖昧に書く  | 再現性と品質担保ができないため                                 |
| 変換ルールを未記載にする                                 | 移行結果が再現できないため                                     |
| 除外ルールを未記載にする                                 | 意図しない欠落が発生するため                                   |
| 移行手順の手段（手動/バッチ/ツール）や入出力を曖昧に書く | 実行計画が確定できないため                                     |
| 検証方法を「確認する」など曖昧に書く                     | 合否判定できないため                                           |
| 移行ツールの実装コードや長大なSQLを本文に貼り付ける      | 差分管理が破綻し、更新不整合を起こすため（参照リンクに寄せる） |
| 「関連ドキュメント」セクションを省略する                 | 導線が失われ、参照先が分散するため                             |

## 8. サンプル（最小・整合版）

注：以下はルール文書内の例示です。生成する `dmd-index` / `dmd-<term>` では `## 1...` から始まります。

### 8.1. `dmd-index`（入口・共通SSOT）

```yaml
---
id: dmd-index
type: migration
title: データ移行設計: 全体
status: draft
based_on:
  - mip-index
supersedes: []
---
```

#### 1. 概要（index）

移行対象データの抽出・変換・投入・検証を再現可能に定義し、移行品質（正確性・完全性）を担保する。
本書はデータ移行設計の入口（SSOT）であり、対象データごとの詳細は `dmd-<term>` に分離する。

#### 2. 共通方針（抽出/変換/除外/冪等性/ログ）

- 抽出方式：原則フル。増分を採用する場合は「基準カラム/キー/基準時刻」を必須とする
- 変換/除外：再実行して同一結果になるように定義し、根拠（仕様ID/参照表）をリンクする
- 冪等性：原則 run_id により隔離し、再投入は別run_idで実施する
- ログ：抽出/変換/投入/照合レポートに run_id を必ず付与する

#### 3. run_id 規約（命名/採番/記録/参照方法）

| 項目     | 方針                               |
| -------- | ---------------------------------- |
| 命名     | `DMD-YYYYMMDD-<term>-NN`           |
| 採番     | 当日内でNNを連番                   |
| 記録先   | 移行ログ基盤（例：S3/logs）        |
| 参照方法 | 照合レポート名・投入データにも付与 |

#### 4. 検証の共通方針（種別/基準/証跡/保管）

- 検証種別：件数照合 / サンプル照合 / 重要値照合（最低限）
- 合格基準：原則「差分0」。許容差εを認める場合は理由を1行で明記する
- 証跡：照合レポート/抜取検証ログ/集計照合レポートを run_id で保管する

#### 5. 対象一覧（スコープ/非対象/担当/対応ドキュメント）

| 区分   | 対象（論理名） | 旧→新                     | 方針（フル/増分） | 担当 | 対応DMD          |
| ------ | -------------- | ------------------------- | ----------------- | ---- | ---------------- |
| データ | 受注           | old.orders → new.orders   | フル              | Mig  | dmd-order-data   |
| データ | 請求           | old.invoice → new.invoice | 増分              | Mig  | dmd-invoice-data |
| 非対象 | アーカイブ     | old.archive → -           | -                 | -    | -                |

#### 6. 関連ドキュメント

- `mip-index`：移行計画（成功条件/対象期間/停止許容時間）
- `cop-index`：カットオーバー計画（当日手順・判定点）
- `mtp-index`：移行リハーサル（検証計画・証跡）
- `dmd-order-data`：受注データ移行設計
- `dmd-invoice-data`：請求データ移行設計

---

### 8.2. `dmd-<term>`（個別SSOT：例）

```yaml
---
id: dmd-order-data
type: migration
title: データ移行設計: 受注データ
status: draft
based_on:
  - dmd-index
  - mip-index
supersedes: []
---
```

#### 1. 概要（order-data）

受注データを旧基盤から新基盤へ移行するための抽出・変換・投入・検証方法を定義する。
共通方針（run_id・冪等性・検証の最小セット）は `dmd-index` を正とする。

#### 2. 対象データ詳細（テーブル/期間/抽出条件/概算件数）

| 対象       | 期間/抽出条件   | 方式（フル/増分） | 増分基準（カラム/キー/基準時刻） | 概算件数  | 備考       |
| ---------- | --------------- | ----------------- | -------------------------------- | --------- | ---------- |
| orders     | 2024-01-01 以降 | フル              | -                                | 2,300,000 | 旧基盤のみ |
| order_item | ordersに紐づく  | フル              | -                                | 8,900,000 |            |

#### 3. データマッピング

| 旧データ            | 新データ             | 変換/補足                      |
| ------------------- | -------------------- | ------------------------------ |
| orders.order_id     | orders.id            | 主キー維持（連番維持）         |
| orders.status       | orders.state         | コード変換（参照表に従う）     |
| order_item.order_id | order_items.order_id | orders投入後に投入（参照整合） |

#### 4. 変換ルール

- 状態コードは旧→新の変換表に従う
- 日付は UTC に統一する

#### 5. 除外ルール

- 取消済みかつ 3 年経過のデータは除外（業務上不要、参照も不要）

#### 6. 移行手順（手動/バッチ/ツール）

| 手順 | 内容 | 入力             | 出力                | 実行単位（ジョブ/コマンド） | 備考       |
| ---- | ---- | ---------------- | ------------------- | --------------------------- | ---------- |
| 1    | 抽出 | 旧DB             | 抽出ファイル（CSV） | job: export_orders          | S3に配置   |
| 2    | 変換 | 抽出ファイル     | 変換済みファイル    | job: transform_orders       | 変換表参照 |
| 3    | 投入 | 変換済みファイル | 新DB                | job: load_orders            | run_id付与 |

#### 7. 性能/所要時間見積

- 1,000,000 件あたり 45 分（並列度 4）
- 目標：停止許容時間（`mip-index`）内に完了する

#### 8. ログ/再実行性

| 項目         | 方針                                 |
| ------------ | ------------------------------------ |
| 識別キー     | run_id                               |
| ログ保存先   | 移行ログ基盤（例：S3/logs）          |
| 冪等性方式   | run_id隔離（同一run_idは再投入不可） |
| 再実行可否   | 別run_idで再実行可                   |
| データ無効化 | run_id単位で隔離/無効化フラグ        |

#### 9. 検証方法（件数照合/サンプル照合/重要値）

| 検証種別     | 検証項目                | 方法            | 合格基準（差分0 / 許容差ε） | 証跡             |
| ------------ | ----------------------- | --------------- | --------------------------- | ---------------- |
| 件数照合     | orders件数              | 旧/新件数比較   | 差分0                       | 照合レポート     |
| サンプル照合 | 重要顧客100件の受注明細 | 旧/新の明細突合 | 差分0                       | 抜取検証ログ     |
| 重要値照合   | 売上合計（期間別）      | 旧/新集計値比較 | 差分0                       | 集計照合レポート |

#### 10. 関連ドキュメント

- `dmd-index`：データ移行設計の入口（共通方針/run_id/検証）
- `mip-index`：移行計画（対象期間/停止許容時間/成功条件）
- `mtp-index`：移行リハーサル（検証計画・証跡）
- （必要に応じて）`cop-index`：当日切替（実行順序・判定点）

## 9. 生成 AI への指示テンプレート

生成 AI に `dmd-index` / `dmd-<term>` を作らせるときの指示テンプレートは `dmd-instruction.md` を参照してください。
