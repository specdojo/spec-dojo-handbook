---
id: dmd-rules
title: データ移行設計 作成ルール
type: rulebook
status: draft
---

Data Migration Design (DMD) Documentation Rules

本ドキュメントは、データ移行設計ドキュメント（`dmd-<term>`）を統一形式で記述するためのルールです。
旧→新のデータ移行を再現可能に定義し、品質（正確性・完全性）を担保するための内容を定義します。

## 1. 全体方針

`dmd-<term>` は、移行対象データの仕様、変換、実行、検証を **再現可能** な粒度で整理し、品質を担保するための SSOT とする。

- 対象データは「何を・どこから・どこへ・どの条件で移すか」を明確にする
- 変換ルールと除外ルールは **再実行しても同じ結果** になる形で記載する
- 移行手順は「手動/バッチ/ツール」を明示し、ログと再実行性を担保する
- 検証は **件数照合/サンプル照合/重要値照合** を最低限含める

## 2. 位置づけと用語定義（必要に応じて）

`dmd-<term>` と他ドキュメントの関係を示します。必要に応じて Mermaid を使用してよい。

## 3. ファイル命名・ID規則

- `id` は `dmd-<term>`（kebab-case。例: `dmd-order-data`）。
- ファイル名は `dmd-010-データ移行設計-<term>.md` 等、プロジェクト内で一意になるように命名する。
- `<term>` は用語集(GL)の論理名キー（英小文字kebab-case）を用いる（表示名は title / ファイル名で日本語を使用してよい）。

## 4. 推奨 Frontmatter 項目

### 4.1. 設定内容

Frontmatter は共通スキーマに従います（参照: [docs/shared/schemas/spec-frontmatter.schema.yaml](../../../shared/schemas/spec-frontmatter.schema.yaml) / [meta-document-metadata-rules.md](meta-document-metadata-rules.md)）。

| 項目       | 説明                                         | 必須 |
| ---------- | -------------------------------------------- | ---- |
| id         | DMD ID（個別: `dmd-<term>`）                 | ○    |
| type       | `migration` 固定                             | ○    |
| title      | データ移行設計: <対象名>                     | ○    |
| status     | `draft` / `ready` / `deprecated`             | ○    |
| based_on   | 根拠となる仕様ID（ID配列。未指定は `[]` 可） | 任意 |
| supersedes | 置き換え関係（ID配列。未指定は `[]` 可）     | 任意 |

### 4.2. 推奨ルール

- `based_on` には移行判断に直接利用した成果物（例: `br-*` / `nfr-*` / `issue-*`）のみ列挙する
- `based_on` / `supersedes` は ID 配列（未指定は `[]` 可）

## 5. 本文構成（標準テンプレ）

`dmd-<term>` は以下の見出し構成を **順序固定** で配置します。

| 番号 | 見出し                                            | 必須 |
| ---- | ------------------------------------------------- | ---- |
| 1    | 概要（`<term>`）                                  | ○    |
| 2    | 対象データ詳細（テーブル/期間/抽出条件/概算件数） | ○    |
| 3    | データマッピング                                  | ○    |
| 4    | 変換ルール                                        | ○    |
| 5    | 除外ルール                                        | ○    |
| 6    | 移行手順（手動/バッチ/ツール）                    | ○    |
| 7    | 性能/所要時間見積                                 | ○    |
| 8    | ログ/再実行性                                     | ○    |
| 9    | 検証方法（件数照合/サンプル照合/重要値）          | ○    |

## 6. 記述ガイド

### 6.1. 概要（`<term>`）

生成する `dmd-<term>` 本文の見出しは **## 1. 概要（`<term>`）**

- 対象データが何であり、どの移行範囲を扱うかを 1〜3 行で示す
- 依存する前提（移行方式、移行期間）を簡潔に述べる

### 6.2. 対象データ詳細（テーブル/期間/抽出条件/概算件数）

生成する `dmd-<term>` 本文の見出しは **## 2. 対象データ詳細（テーブル/期間/抽出条件/概算件数）**

- 対象テーブル/コレクションを列挙する
- 移行期間/抽出条件を明記する
- 概算件数（見積り根拠が分かる粒度）を示す

推奨フォーマット（表）:

| 対象 | 期間/抽出条件 | 概算件数 | 備考 |
| ---- | ------------- | -------- | ---- |

### 6.3. データマッピング

生成する `dmd-<term>` 本文の見出しは **## 3. データマッピング**

- 旧→新の対応を明確に示す
- 1対多/多対1の関係は変換ルールと合わせて記述する

推奨フォーマット（表）:

| 旧データ | 新データ | 変換/補足 |
| -------- | -------- | --------- |

### 6.4. 変換ルール

生成する `dmd-<term>` 本文の見出しは **## 4. 変換ルール**

- 変換規則（正規化、コード変換、丸め、文字種変換等）を列挙する
- 再実行しても同じ結果になることを前提に記述する

### 6.5. 除外ルール

生成する `dmd-<term>` 本文の見出しは **## 5. 除外ルール**

- 移行対象外となる条件を列挙する
- 除外理由（業務上の不要、期限切れ、品質不良等）を明記する

### 6.6. 移行手順（手動/バッチ/ツール）

生成する `dmd-<term>` 本文の見出しは **## 6. 移行手順（手動/バッチ/ツール）**

- 手段（手動/バッチ/ツール）を明示する
- 実行順序と依存関係が分かる粒度で記述する

### 6.7. 性能/所要時間見積

生成する `dmd-<term>` 本文の見出しは **## 7. 性能/所要時間見積**

- 所要時間見積と前提条件（件数、並列度、スループット）を示す
- 目標時間がある場合は明記する

### 6.8. ログ/再実行性

生成する `dmd-<term>` 本文の見出しは **## 8. ログ/再実行性**

- 実行ログの保存先と識別キーを明記する
- 再実行条件（再投入可能範囲、冪等性の担保方法）を示す

### 6.9. 検証方法（件数照合/サンプル照合/重要値）

生成する `dmd-<term>` 本文の見出しは **## 9. 検証方法（件数照合/サンプル照合/重要値）**

- 件数照合、サンプル照合、重要値照合の方法を明記する
- 検証結果の証跡（レポート/ログ）を示す

推奨フォーマット（表）:

| 検証項目 | 方法 | 合格基準 | 証跡 |
| -------- | ---- | -------- | ---- |

## 7. 禁止事項

| 禁止事項                                           | 理由                           |
| -------------------------------------------------- | ------------------------------ |
| 対象データの範囲（期間/抽出条件/件数）を曖昧に書く | 再現性と品質担保ができないため |
| 変換ルールを未記載にする                           | 移行結果が再現できないため     |
| 除外ルールを未記載にする                           | 意図しない欠落が発生するため   |
| 移行手順の手段（手動/バッチ/ツール）を曖昧に書く   | 実行計画が確定できないため     |
| 検証方法を「確認する」など曖昧に書く               | 合否判定できないため           |

## 8. サンプル（最小）

注：以下はルール文書内の例示です。生成する `dmd-<term>` では `## 1...` から始まります。

```yaml
---
id: dmd-order-data
type: migration
title: データ移行設計: 受注データ
status: draft
based_on: []
supersedes: []
---
```

### 8.1. 概要（order-data）

受注データを旧基盤から新基盤へ移行するための設計を定義する。

### 8.2. 対象データ詳細（テーブル/期間/抽出条件/概算件数）

| 対象       | 期間/抽出条件      | 概算件数  | 備考       |
| ---------- | ------------------ | --------- | ---------- |
| orders     | 2024-01-01 以降    | 2,300,000 | 旧基盤のみ |
| order_item | ordersに紐づく全件 | 8,900,000 |            |

### 8.3. データマッピング

| 旧データ        | 新データ     | 変換/補足          |
| --------------- | ------------ | ------------------ |
| orders.order_id | orders.id    | 連番維持           |
| orders.status   | orders.state | コード変換（別表） |

### 8.4. 変換ルール

- 状態コードは旧→新の変換表に従う
- 日付は UTC に統一する

### 8.5. 除外ルール

- 取消済みかつ 3 年経過のデータは除外

### 8.6. 移行手順（手動/バッチ/ツール）

- バッチで抽出 → 変換 → 新DB投入

### 8.7. 性能/所要時間見積

- 1,000,000 件あたり 45 分（並列度 4）

### 8.8. ログ/再実行性

- run_id 単位でログ保存。失敗時は run_id で再実行可能

### 8.9. 検証方法（件数照合/サンプル照合/重要値）

| 検証項目   | 方法          | 合格基準  | 証跡         |
| ---------- | ------------- | --------- | ------------ |
| 件数照合   | 旧/新件数比較 | 差分0     | 照合レポート |
| 重要値照合 | サンプル比較  | 99.9%一致 | 抜取検証ログ |

## 9. 生成 AI への指示テンプレート

生成 AI に `dmd-<term>` を作らせるときの指示テンプレートは `dmd-instruction.md` を参照してください。
