---
id: dmd-rules
title: データ移行設計 作成ルール
type: rulebook
status: draft
---

Data Migration Design (DMD) Documentation Rules

本ドキュメントは、データ移行設計ドキュメント（`dmd-<term>`）を統一形式で記述するためのルールです。
旧→新のデータ移行を再現可能に定義し、品質（正確性・完全性）を担保するための内容を定義します。

## 1. 全体方針

`dmd-<term>` は、移行対象データの仕様、変換、実行、検証を **再現可能** な粒度で整理し、品質を担保するための SSOT とする。

- 対象データは「何を・どこから・どこへ・どの条件で移すか」を明確にする
- 抽出方式（フル/増分）と増分基準（基準カラム/キー/基準時刻）を明記し、同条件で再実行できるようにする
- 変換ルールと除外ルールは **再実行しても同じ結果** になる形で記載する
- 移行手順は「手動/バッチ/ツール」を明示し、入出力（形式/置き場）・ログ・再実行性を担保する
- 検証は **件数照合/サンプル照合/重要値照合** を最低限含め、合格基準（差分0 / 許容差ε）を明確にする

## 2. 位置づけと用語定義（必要に応じて）

`dmd-<term>` と他ドキュメントの関係を示します。必要に応じて Mermaid を使用してよい。

- `mip-overview`：移行の合意・判断のSSOT（本体）
- `cop-*`：当日実行の詳細手順（Runbook）
- `dmd-*`：データ移行の詳細設計（本書）
- `mtp-*`：リハーサル計画・検証設計（観点/手順/証跡）
- `otp-*`：運用切替の詳細（監視設定/運用手順/窓口）

## 3. ファイル命名・ID規則

- `id` は `dmd-<term>`（kebab-case。例: `dmd-order-data`）。
- ファイル名は `dmd-010-データ移行設計-<term>.md` 等、プロジェクト内で一意になるように命名する。
- `<term>` は用語集(GL)の論理名キー（英小文字kebab-case）を用いる（表示名は title / ファイル名で日本語を使用してよい）。

## 4. 推奨 Frontmatter 項目

### 4.1. 設定内容

Frontmatter は共通スキーマに従います（参照: [docs/shared/schemas/spec-frontmatter.schema.yaml](../../../shared/schemas/spec-frontmatter.schema.yaml) / [meta-document-metadata-rules.md](meta-document-metadata-rules.md)）。

| 項目       | 説明                                         | 必須 |
| ---------- | -------------------------------------------- | ---- |
| id         | DMD ID（個別: `dmd-<term>`）                 | ○    |
| type       | `migration` 固定                             | ○    |
| title      | データ移行設計: <対象名>                     | ○    |
| status     | `draft` / `ready` / `deprecated`             | ○    |
| based_on   | 根拠となる仕様ID（ID配列。未指定は `[]` 可） | 任意 |
| supersedes | 置き換え関係（ID配列。未指定は `[]` 可）     | 任意 |

### 4.2. 推奨ルール

- `based_on` には移行判断に直接利用した成果物（例: `br-*` / `nfr-*` / `issue-*`）のみ列挙する
- `based_on` / `supersedes` は ID 配列（未指定は `[]` 可）

## 5. 本文構成（標準テンプレ）

`dmd-<term>` は以下の見出し構成を **順序固定** で配置します。

| 番号 | 見出し                                            | 必須 |
| ---- | ------------------------------------------------- | ---- |
| 1    | 概要（`<term>`）                                  | ○    |
| 2    | 対象データ詳細（テーブル/期間/抽出条件/概算件数） | ○    |
| 3    | データマッピング                                  | ○    |
| 4    | 変換ルール                                        | ○    |
| 5    | 除外ルール                                        | ○    |
| 6    | 移行手順（手動/バッチ/ツール）                    | ○    |
| 7    | 性能/所要時間見積                                 | ○    |
| 8    | ログ/再実行性                                     | ○    |
| 9    | 検証方法（件数照合/サンプル照合/重要値）          | ○    |

## 6. 記述ガイド

### 6.1. 概要（`<term>`）

生成する `dmd-<term>` 本文の見出しは **## 1. 概要（`<term>`）**

- 対象データが何であり、どの移行範囲を扱うかを 1〜3 行で示す
- 依存する前提（移行方式、移行期間）を簡潔に述べる

### 6.2. 対象データ詳細（テーブル/期間/抽出条件/概算件数）

生成する `dmd-<term>` 本文の見出しは **## 2. 対象データ詳細（テーブル/期間/抽出条件/概算件数）**

- 対象テーブル/コレクションを列挙する
- 移行期間/抽出条件を明記する
- 抽出方式（フル/増分）と増分基準（基準カラム/キー/基準時刻）を明記する
- 概算件数（見積り根拠が分かる粒度）を示す

推奨フォーマット（表）:

| 対象 | 期間/抽出条件 | 方式（フル/増分） | 増分基準（カラム/キー/基準時刻） | 概算件数 | 備考 |
| ---- | ------------- | ----------------- | -------------------------------- | -------- | ---- |

### 6.3. データマッピング

生成する `dmd-<term>` 本文の見出しは **## 3. データマッピング**

- 旧→新の対応を明確に示す
- 1対多/多対1の関係は変換ルールと合わせて記述する
- 主キー/参照整合（FK相当）の扱い（維持/再採番/変換テーブル、投入順序の前提）を明記する

推奨フォーマット（表）:

| 旧データ | 新データ | 変換/補足 |
| -------- | -------- | --------- |

### 6.4. 変換ルール

生成する `dmd-<term>` 本文の見出しは **## 4. 変換ルール**

- 変換規則（正規化、コード変換、丸め、文字種変換等）を列挙する
- 再実行しても同じ結果になることを前提に記述する
- 変換の根拠（参照表/仕様ID）がある場合はリンクする

### 6.5. 除外ルール

生成する `dmd-<term>` 本文の見出しは **## 5. 除外ルール**

- 移行対象外となる条件を列挙する
- 除外理由（業務上の不要、期限切れ、品質不良等）を明記する
- 除外した場合の影響（参照のみ/業務に影響なし/代替手段あり）を必要に応じて追記する

### 6.6. 移行手順（手動/バッチ/ツール）

生成する `dmd-<term>` 本文の見出しは **## 6. 移行手順（手動/バッチ/ツール）**

- 手段（手動/バッチ/ツール）を明示する
- 実行順序と依存関係が分かる粒度で記述する
- 入出力（形式/置き場）と実行単位（ジョブ名/コマンド/ツール名）が分かるように記述する（詳細はリンクでよい）

推奨フォーマット（例）:

| 手順 | 内容 | 入力 | 出力 | 実行単位（ジョブ/コマンド） | 備考 |
| ---- | ---- | ---- | ---- | --------------------------- | ---- |

### 6.7. 性能/所要時間見積

生成する `dmd-<term>` 本文の見出しは **## 7. 性能/所要時間見積**

- 所要時間見積と前提条件（件数、並列度、スループット）を示す
- 目標時間がある場合は明記する
- ボトルネックが想定される場合は、暫定対策（並列化/分割/先行移行）を方針として記載してよい

### 6.8. ログ/再実行性

生成する `dmd-<term>` 本文の見出しは **## 8. ログ/再実行性**

- 実行ログの保存先と識別キー（例: `run_id`）を明記する
- 再実行条件（再投入可能範囲、冪等性の担保方法）を示す
- 冪等性方式を明記する（例: `upsert` / `run_id隔離` / `再投入前truncate` / `差分適用`）

推奨フォーマット（表）:

| 項目         | 方針                                       |
| ------------ | ------------------------------------------ |
| 識別キー     | run_id                                     |
| ログ保存先   | （例：S3/ログ基盤/DB）                     |
| 冪等性方式   | upsert / run_id隔離 / …                    |
| 再実行可否   | （例：同一run_id不可、別run_idで再実行可） |
| データ無効化 | （例：run_id単位で隔離/フラグ）            |

### 6.9. 検証方法（件数照合/サンプル照合/重要値）

生成する `dmd-<term>` 本文の見出しは **## 9. 検証方法（件数照合/サンプル照合/重要値）**

- 件数照合、サンプル照合、重要値照合の方法を明記する
- 合格基準は「差分0」か「許容差（ε）」かを明示する（理由も 1 行でよい）
- 検証結果の証跡（レポート/ログ）を示す

推奨フォーマット（表）:

| 検証種別 | 検証項目 | 方法 | 合格基準（差分0 / 許容差ε） | 証跡 |
| -------- | -------- | ---- | --------------------------- | ---- |

## 7. 禁止事項

| 禁止事項                                                 | 理由                                                           |
| -------------------------------------------------------- | -------------------------------------------------------------- |
| 対象データの範囲（期間/抽出条件/件数/方式）を曖昧に書く  | 再現性と品質担保ができないため                                 |
| 変換ルールを未記載にする                                 | 移行結果が再現できないため                                     |
| 除外ルールを未記載にする                                 | 意図しない欠落が発生するため                                   |
| 移行手順の手段（手動/バッチ/ツール）や入出力を曖昧に書く | 実行計画が確定できないため                                     |
| 検証方法を「確認する」など曖昧に書く                     | 合否判定できないため                                           |
| 移行ツールの実装コードや長大なSQLを本文に貼り付ける      | 差分管理が破綻し、更新不整合を起こすため（参照リンクに寄せる） |

## 8. サンプル（最小）

注：以下はルール文書内の例示です。生成する `dmd-<term>` では `## 1...` から始まります。

```yaml
---
id: dmd-order-data
type: migration
title: データ移行設計: 受注データ
status: draft
based_on: []
supersedes: []
---
```

### 8.1. 概要（order-data）

受注データを旧基盤から新基盤へ移行するための設計を定義する。

### 8.2. 対象データ詳細（テーブル/期間/抽出条件/概算件数）

| 対象       | 期間/抽出条件      | 方式（フル/増分） | 増分基準（カラム/キー/基準時刻） | 概算件数  | 備考       |
| ---------- | ------------------ | ----------------- | -------------------------------- | --------- | ---------- |
| orders     | 2024-01-01 以降    | フル              | -                                | 2,300,000 | 旧基盤のみ |
| order_item | ordersに紐づく全件 | フル              | -                                | 8,900,000 |            |

### 8.3. データマッピング

| 旧データ            | 新データ             | 変換/補足                            |
| ------------------- | -------------------- | ------------------------------------ |
| orders.order_id     | orders.id            | 主キー維持（連番維持）               |
| orders.status       | orders.state         | コード変換（変換表: dmd-\*-mapping） |
| order_item.order_id | order_items.order_id | orders投入後に投入（参照整合）       |

### 8.4. 変換ルール

- 状態コードは旧→新の変換表に従う
- 日付は UTC に統一する

### 8.5. 除外ルール

- 取消済みかつ 3 年経過のデータは除外（業務上不要）

### 8.6. 移行手順（手動/バッチ/ツール）

| 手順 | 内容 | 入力             | 出力                | 実行単位（ジョブ/コマンド） | 備考       |
| ---- | ---- | ---------------- | ------------------- | --------------------------- | ---------- |
| 1    | 抽出 | 旧DB             | 抽出ファイル（CSV） | job: export_orders          | S3に配置   |
| 2    | 変換 | 抽出ファイル     | 変換済みファイル    | job: transform_orders       | 変換表参照 |
| 3    | 投入 | 変換済みファイル | 新DB                | job: load_orders            | run_id付与 |

### 8.7. 性能/所要時間見積

- 1,000,000 件あたり 45 分（並列度 4、スループット 370行/秒相当）
- 目標：停止許容時間（MIP）内に完了すること

### 8.8. ログ/再実行性

| 項目         | 方針                                 |
| ------------ | ------------------------------------ |
| 識別キー     | run_id                               |
| ログ保存先   | 移行ログ基盤（例：S3/logs）          |
| 冪等性方式   | run_id隔離（同一run_idは再投入不可） |
| 再実行可否   | 別run_idで再実行可                   |
| データ無効化 | run_id単位で隔離/無効化フラグ        |

### 8.9. 検証方法（件数照合/サンプル照合/重要値）

| 検証種別     | 検証項目                | 方法            | 合格基準（差分0 / 許容差ε） | 証跡             |
| ------------ | ----------------------- | --------------- | --------------------------- | ---------------- |
| 件数照合     | orders件数              | 旧/新件数比較   | 差分0                       | 照合レポート     |
| サンプル照合 | 重要顧客100件の受注明細 | 旧/新の明細突合 | 差分0                       | 抜取検証ログ     |
| 重要値照合   | 売上合計（期間別）      | 旧/新集計値比較 | 許容差ε=0（差分0）          | 集計照合レポート |

## 9. 生成 AI への指示テンプレート

生成 AI に `dmd-<term>` を作らせるときの指示テンプレートは `dmd-instruction.md` を参照してください。
