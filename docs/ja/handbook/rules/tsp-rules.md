# テスト戦略・方針（TSP）作成ルール

本ドキュメントは、品質保証・テスト設計のために **テスト戦略・方針（Test Strategy and Policy: TSP）を統一形式で記述する標準ルール**です。
TSP は「全体として、どのようにテストで品質を担保するか」を、**レビューしやすい Markdown 形式**で明文化し、テスト設計・実施・受入判断の認識ズレを防ぎます。

TSP は「個別のテストケース集」ではありません。
各テストレベル（単体/結合/システム/受入など）の **目的・範囲・体制**、および **フェーズ間の入口／出口条件（品質ゲート）** を合意することが主目的です。

## 1. 全体方針

- TSP は **プロジェクト/システムのテストの全体像**（考え方）を定義します。
  - 例: 「ドメインロジックは単体〜結合まで自動化し、UI は主要シナリオのみ E2E を行う」
- TSP は下位成果物（テスト観点・テスト条件一覧、各レベルのテスト仕様、受入条件）を導く **上位方針**です。
  - 下位成果物に“何をどこまで書くか”の境界も TSP で定義します。
- 曖昧な表現（例: 「十分にテストする」「品質を確保する」）は禁止し、
  - スコープ（対象/対象外）
  - 品質ゲート（入口/出口条件）
  - エビデンス（何をもって合否判断するか）
    を明確に書きます。
- クリック手順の逐語列挙は避け、**業務行為/入力/期待結果**として要約します。
- 実装詳細（例: 物理テーブル名、SQL全文、実装クラス/関数名、特定ライブラリの設定値）は記載しません。
- 1ファイル = 1 方針（原則）です。
  - 肥大化する場合は、`tsp-...` を目的別（例: 全体方針/回帰方針/非機能試験方針）に分割し、`depends_on` で関連付けします。

## 2. 用語定義

| 用語                   | 定義                                                                           |
| ---------------------- | ------------------------------------------------------------------------------ |
| TSP                    | テスト戦略・方針。プロジェクト全体のテストの考え方（目的/範囲/体制/ゲート）    |
| テストレベル           | 単体/結合/システム/受け入れ等、段階別のテスト区分                              |
| スコープ               | テスト対象（含む）と対象外（除外）                                             |
| 入口条件               | そのテストレベルを開始してよい状態（前提、準備完了条件）                       |
| 出口条件               | そのテストレベルを完了（合格）してよい条件（合格基準、残課題扱い）             |
| エビデンス             | 合否判定の根拠（レポート、メトリクス、ログ、記録、承認など）                   |
| 回帰（リグレッション） | 変更により既存機能が壊れていないことを確認する試験                             |
| 自動化                 | テスト実行・検証をツールで繰り返し可能にすること（どこまで自動化するかが方針） |
| 重大度                 | 不具合の影響度（業務影響/停止有無/回避可否など）                               |

## 3. ファイル命名・ID規則

- ファイル名: `tsp-<番号>-<短い日本語名>.md`（例: `tsp-0010-全体方針.md`）
- Frontmatter:
  - `id`: `tsp-overview`, `tsp-regression` のように小文字ハイフン形式。
  - `title`: 「テスト戦略・方針: 全体」など。

推奨:

- 原則として `tsp-overview` を“全体方針”の入口にします。
- 分割する場合は、方針の対象範囲が分かる ID にします。
  - 例: `tsp-nfr-testing`（非機能試験方針）, `tsp-regression`（回帰方針）

## 4. 推奨 Frontmatter 項目

Frontmatter は `docs/handbook/shared/schemas/spec-frontmatter.schema.yaml` の制約に従います。

| 項目       | 説明                                                                  | 必須 |
| ---------- | --------------------------------------------------------------------- | ---- |
| id         | TSP ID（`tsp-...`）                                                   | ○    |
| type       | `test` 固定                                                           | ○    |
| title      | 方針名（例: テスト戦略・方針: 全体）                                  | ○    |
| status     | `draft`/`ready`/`deprecated`                                          | ○    |
| version    | バージョン（SemVer）                                                  | 任意 |
| owners     | 担当者                                                                | 任意 |
| tags       | タグ・分類                                                            | 任意 |
| depends_on | 参照する仕様ID（BAC/NFR/SAC/ADR/TSL/UIS/EAPIS 等）                    | 任意 |
| implements | 満たすべき上位方針（ルール/ポリシー）があれば                         | 任意 |
| tests      | 下位のテスト仕様 ID（テスト条件一覧・各レベルのテスト仕様等）があれば | 任意 |
| supersedes | 置き換え関係（古仕様→新仕様）                                         | 任意 |

推奨:

- `depends_on` に、方針の根拠となる主要仕様（例: `bac-...`, `nfr-...`, `adr-...`）を列挙し、スコープを明確にします。
- TSP が下位の成果物へ分解される場合は、`tests` から参照できるよう ID は安定させます。

## 5. 本文構成（標準テンプレ）

各 TSP ファイルは以下の見出しを順番に並べます。

1. 概要
2. テスト戦略・方針
3. メモ / 将来課題

## 6. 記述ガイド詳細

### 6.1 概要

- 1〜3文で「何の品質を、どの範囲に対して、どのように担保するか（全体方針）」を書きます。
- 可能なら対象仕様（BAC/NFR/主要機能）を言及し、`depends_on` と整合させます。

### 6.2 テスト戦略・方針

TSP 本文では、最低限として次を含めます。

- テストレベル一覧（目的/範囲/体制）
- スコープ（対象/対象外）
- テスト環境・テストデータの方針
- フェーズ間の入口／出口条件（品質ゲート）

必要に応じて、回帰方針、不具合管理、品質メトリクスも追記します。

#### 6.2.1 テストレベル一覧表（必須）

テストレベルは **一覧表** で定義します。

最小の列は次を推奨します。

| 列             | 目的                                          |
| -------------- | --------------------------------------------- |
| テストレベル   | 単体/結合/システム/受け入れ等                 |
| 目的           | そのレベルで何を保証したいか                  |
| 範囲           | 対象（例: モジュール/画面/API/バッチ/外部IF） |
| 実施体制・備考 | 実施主体、ツール、自動化方針、除外など        |

記述のコツ:

- “何をそのレベルで確認し、何を下位/上位に委ねるか”の境界をはっきりさせます。
- 「範囲」は成果物（モジュール/画面/API/バッチ等）で書き、個別ケースは下位文書に委ねます。

#### 6.2.2 スコープ（対象/対象外）（必須）

TSP は必ず「どこまでがテスト対象か」を定義します。

- 対象（含む）
- 対象外（除外）
- 除外の理由（任意）

例:

- 対象: 主要業務フロー（販売/発注/入荷/棚卸）、主要 API、主要バッチ
- 対象外: 外部サービス自体の SLA（外部契約に委ねる）、外部端末の物理故障

#### 6.2.3 テスト環境・テストデータ（必須）

環境やデータの前提が曖昧だと、試験結果が比較できません。
次を“方針”として定義します。

- 環境区分（例: 開発/結合/システム/受入）と用途
- データ方針（匿名化、代表データ量、マスタの扱い）
- 外部IFの扱い（実接続/スタブ/モック、切り替え方針）

#### 6.2.4 入口／出口条件（品質ゲート）（必須）

フェーズ間の入口／出口条件は、**合否判定できる形**で書きます。

推奨の書き方（表）:

| フェーズ/テストレベル | 入口条件（開始条件） | 出口条件（完了条件） | エビデンス（根拠） |
| --------------------- | -------------------- | -------------------- | ------------------ |
| 単体テスト            | …                    | …                    | …                  |
| 結合テスト            | …                    | …                    | …                  |
| システムテスト        | …                    | …                    | …                  |
| 受け入れテスト        | …                    | …                    | …                  |

記述のコツ:

- 出口条件には「未解決不具合の扱い（重大度別の許容）」を含めます。
- 非機能の出口条件は、可能なら NFR/SAC と接続します（例: 「全 NFR を満たす」）。

#### 6.2.5 自動化方針（任意だが推奨）

自動化は “やる/やらない” ではなく、**どこを自動化し、どこを手動で補うか** を決めます。

- 自動化の優先領域（例: ドメインロジック、計算、バリデーション、回帰）
- 手動で行う領域（例: UX の探索、端末差異、教育/運用リハーサル）
- 回帰の基本方針（例: 変更影響のある領域は自動回帰を必須）

#### 6.2.6 不具合管理方針（任意）

不具合管理は、テスト成果の解釈ブレを防ぐために記載してよいです。

- 重大度（例: Blocker/Critical/Major/Minor）と判断観点（業務影響/回避可否）
- 収束基準（出口条件との関係）
- 既知不具合の扱い（残課題/例外承認/ロールバック条件）

#### 6.2.7 品質メトリクス（任意）

合意が必要な場合のみ、最小限のメトリクスを定義します。

- 例: 自動テストの実行結果（Pass率）、主要シナリオの実施状況、重大不具合件数、性能の合否（NFR達成状況）

### 6.3 メモ / 将来課題

- 未確定の前提（例: ピーク時の定義、想定データ量、外部依存の SLA）
- 将来追加したい試験（例: DR 訓練、長期運用での監査手順、非機能の拡充）

## 7. 禁止事項

| 項目                                            | 理由                                        |
| ----------------------------------------------- | ------------------------------------------- |
| 物理テーブル名・物理カラム名・SQL全文           | 実装依存で変更に弱い                        |
| 実装クラス/関数名、特定ライブラリの設定値の列挙 | 実装依存で変更に弱い                        |
| クリック/画面遷移の逐語列挙                     | UI変更に弱い・本質が埋もれる                |
| 個別テストケースの大量列挙                      | 下位文書（テスト仕様/条件一覧）に分解すべき |
| 「十分」「適切」「問題ない」等の曖昧表現        | 合否判定不能                                |
| 前提なしの数値（条件が不明）                    | 合意不能、再現不能                          |

## 8. よくある誤りと対策

- テストレベルの役割分担が曖昧 → レベルごとに「目的/範囲/体制」を表で固定する
- スコープが書かれていない → 対象/対象外を必ず明記し、除外理由も残す
- 入口/出口条件がない → フェーズ間の品質ゲート（開始/完了条件）を表で定義する
- 自動化の範囲が不明 → 自動化する領域と手動で補う領域を分けて記述する
- 不具合が残ったまま“完了”扱いになる → 重大度別の許容と例外承認のルールを出口条件に含める

## 9. サンプル（最小）

### メタ情報

```yaml
---
id: tsp-overview
type: test
title: テスト戦略・方針: 全体
status: draft
version: '1.0.0'
owners: []
tags: [quality]
depends_on: []
implements: []
tests: []
supersedes: []
---
```

### 概要

本プロジェクトにおけるテストの全体方針を定義し、テスト設計・実施・受入判断の基準を統一する。

### テスト戦略・方針

#### テストレベル一覧

| テストレベル   | 目的                   | 範囲                  | 実施体制・備考                                     |
| -------------- | ---------------------- | --------------------- | -------------------------------------------------- |
| 単体テスト     | 各機能の正確な動作確認 | モジュール・関数単位  | 開発者が実施。ドメインロジックは自動化を優先する   |
| 結合テスト     | 機能間連携の確認       | 画面・API・バッチ連携 | 開発者・テスト担当。主要な連携パターンを押さえる   |
| システムテスト | システム全体の品質確認 | 全画面・全API・バッチ | テスト担当・業務担当。非機能は NFR/SAC に従う      |
| 受け入れテスト | 業務要件の満足確認     | 業務シナリオ・KPI     | 業務担当・ユーザー。合否は受入条件に基づき判断する |

#### スコープ（対象/対象外）

- 対象: 主要業務フロー、主要画面、主要 API
- 対象外: 外部サービス自体の可用性（契約SLAに委ねる）

#### 入口／出口条件（例）

| フェーズ/テストレベル | 入口条件（開始条件）               | 出口条件（完了条件）                  | エビデンス（根拠）         |
| --------------------- | ---------------------------------- | ------------------------------------- | -------------------------- |
| 結合テスト            | 主要機能の単体テストが完了している | 重大不具合が残っていない              | 結合テスト結果レポート     |
| システムテスト        | 結合テストが完了している           | 受入に影響する重大不具合が 0 件である | システムテスト結果レポート |

### メモ / 将来課題

- ピーク時条件（同時数・データ量）の確定

## 10. 生成 AI への指示テンプレート

生成 AI に TSP を作らせるときは、以下のような指示を与えます。

> - 以下のルールに従って、**テスト戦略・方針（TSP）** を 1 ファイル作成してください。出力は **Markdown** とします。
> - 目的: テストレベルの目的/範囲/体制、スコープ、環境、フェーズ間の入口／出口条件（品質ゲート）を明確化し、認識ズレを防ぐこと。
> - 禁止: 物理テーブル名・物理カラム名・SQL全文、実装クラス/関数名、特定ライブラリの設定値の列挙、クリック手順など UI 操作の逐語列挙、個別テストケースの大量列挙
>
> ## 出力フォーマット
>
> - 先頭に YAML Frontmatter を付与し、以下の形式で記述してください（`id` / `type` / `title` / `status` は必須、`type` は `test` 固定）：
>
>   ```yaml
>   ---
>   id: tsp-<英小文字とハイフンで構成したID>
>   type: test
>   title: テスト戦略・方針: <対象名>
>   status: draft # draft / ready / deprecated
>   version: '1.0.0'
>   owners: []
>   tags: []
>   depends_on: []
>   implements: []
>   tests: []
>   supersedes: []
>   ---
>   ```
>
> - 本文は次の見出し（日本語）をこの順序で必ず含めてください：
>   1. 概要
>   2. テスト戦略・方針
>   3. メモ / 将来課題
>
> ## 記述ルール（重要）
>
> - 「テスト戦略・方針」には必ず以下を含めてください：
>   - テストレベル一覧表（`テストレベル` / `目的` / `範囲` / `実施体制・備考`）
>   - スコープ（対象/対象外）
>   - テスト環境・テストデータの方針（最小限）
>   - 入口／出口条件（品質ゲート。表形式推奨）
> - 曖昧表現（例: 「十分」「適切」「問題ない」）は禁止し、合否判定できる形（条件・観測点・根拠）に落としてください。
