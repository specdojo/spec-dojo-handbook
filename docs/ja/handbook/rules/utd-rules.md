# 単体テスト設計（UTD）作成ルール

本ドキュメントは、単体テスト仕様（UTS / UTS-D）に基づき、
**単体テストをどのように設計し、テストコードへ落とし込むか**を統一形式で記述するための標準ルールです。

UTD（Unit Test Design）は、

- 単体テスト仕様（UTS / UTS-D）で定義された保証範囲を前提に
- **テスト観点 × テスト条件 × ケース構成**を整理し
- テストコード（JUnit 等）を **迷いなく実装・レビューできる状態**を作る

ことを目的とします。

---

## 1. 全体方針

- UTD は **単体テスト仕様（UTS / UTS-D）の下位成果物**です。
  - UTD 単体で意味を持たせず、必ず上位仕様を参照します。

- UTD は **テストコードそのものではありません**。
  - ただし、テストコードと 1 対 1 で追跡可能であることを重視します。

- UTD の主眼は以下です。
  - ケースの分解方針（どの観点×条件をどう組み合わせるか）
  - テストコード構成の方針（クラス/ファイル/命名/配置）
  - 実行方法・結果参照先の明確化

- 数値・具体データは **必要最小限のみ記載**します。
  - 境界値・代表値を示すのは可
  - 大量のパラメータ列挙は禁止

- 1ファイル = 1 設計単位（原則）とします。
  - 対象単位は **UTS-D と一致**させます。

---

## 2. 位置づけ（ドキュメント階層）

UTD は以下の階層に位置します。

```plaintext
TSP（テスト戦略・方針）
  ↓
TPC（テスト観点・条件）
  ↓
UTS（単体テスト仕様・全体）
  ↓
UTS-D（単体テスト仕様・個別）
  ↓
UTD（単体テスト設計） ← 本ドキュメント
  ↓
テストコード（JUnit 等）
```

---

## 3. ファイル命名・ID規則

### ファイル名

```text
020-単体テスト設計.md
020-単体テスト設計-<用語集term>.md
```

例:

- `020-単体テスト設計.md`（全体設計）
- `020-単体テスト設計-在庫.md`（在庫の個別設計）

### ID 規則

- `id`: `utd-main`, `utd-inventory` など
- prefix は必ず `utd-` を使用します

---

## 4. 推奨 Frontmatter 項目

| 項目       | 説明                                             | 必須 |
| ---------- | ------------------------------------------------ | ---- |
| id         | UTD ID（`utd-...`）                              | ○    |
| type       | `test` 固定                                      | ○    |
| title      | 単体テスト設計: <対象名>                         | ○    |
| status     | `draft` / `ready` / `deprecated`                 | ○    |
| owners     | 担当者                                           | 任意 |
| tags       | タグ（例: unit, design, inventory）              | 任意 |
| depends_on | 上位仕様（`uts-*`, `tpc-*`, `br-*`, `bac-*` 等） | 必須 |
| tests      | 実装・実行ドキュメントやテストコード参照         | 任意 |
| supersedes | 置き換え関係                                     | 任意 |

### 推奨

- `depends_on` には **必ず対応する UTS-D** を含めます。
- `tests` にはテストコードの場所（パスや論理名）を記載可能です。

---

## 5. 本文構成（標準テンプレ）

UTD は以下の見出し構成を **必ず守ります**。

1. 概要
2. 設計対象と前提
3. ケース分解方針
4. テストケース設計（観点 × 条件）
5. テストコード構成・命名
6. テストデータ・モック方針
7. 実行方法・結果参照
8. メモ / 留意事項

---

## 6. 記述ガイド詳細

### 6.1 概要

- この設計が **どの UTS / UTS-D を具体化するものか**を明示します。
- 対象の単体テストで **どこまで設計で決めるか**を簡潔に書きます。

---

### 6.2 設計対象と前提（必須）

#### 推奨の書き方

| 項目         | 内容                  |
| ------------ | --------------------- |
| 対象         | 在庫コンポーネント    |
| 対応仕様     | uts-inventory         |
| 前提         | 外部API・DBはモック化 |
| テスト対象外 | 性能、並行実行        |

---

### 6.3 ケース分解方針（必須）

UTD の最重要セクションです。

#### 基本方針

- テストケースは **「観点 × 条件」**で分解します。
- 観点は **UTS-D の保証観点**から取得します。
- 条件は **状態レベル**で整理し、値は最小限に留めます。

#### 記述例

| 観点ID  | 分解方針                         |
| ------- | -------------------------------- |
| UT-I-01 | 正常系は代表1ケース＋境界1ケース |
| UT-I-02 | 境界値（最小/最大）を各1ケース   |
| UT-I-03 | 入力不正パターンを分類単位で網羅 |

> すべての組合せを作るのではなく、「保証に十分な代表集合」を設計します。

---

### 6.4 テストケース設計（必須）

ここでは **ケースの構造**を示します。
※ テストコードの写経は禁止。

#### 推奨カラム

| ケースID | 観点ID  | 条件ID | 入力の考え方 | 期待結果 | 備考 |
| -------- | ------- | ------ | ------------ | -------- | ---- |
| UTC-01   | UT-I-01 | UC-01  | 正常入力     | 正常完了 |      |
| UTC-02   | UT-I-02 | UC-02  | 境界値       | 引当不可 |      |
| UTC-05   | UT-I-03 | UC-05  | 不正入力     | エラー   |      |

記述のコツ:

- 入力値は「考え方」で書く（具体値はコード側）
- 期待結果は **方向性**まで（メッセージ文言等は不要）

---

### 6.5 テストコード構成・命名（必須）

テストコードの **置き場所・構成・命名規則**を示します。

#### 推奨記述内容

| 項目             | 内容例                            |
| ---------------- | --------------------------------- |
| テストクラス配置 | `<module>/test/.../InventoryTest` |
| クラス命名       | `<対象名>Test`                    |
| メソッド命名     | `<条件>_<期待結果>`               |
| 観点との対応     | コメントで観点IDを付与            |

> 実装言語やフレームワークに依存しすぎない書き方を心がけます。

---

### 6.6 テストデータ・モック方針（必須）

#### 推奨の書き方

| 対象       | 方針               |
| ---------- | ------------------ |
| リポジトリ | モックで戻り値制御 |
| 時刻       | 固定クロック       |
| 乱数       | 固定シード         |

---

### 6.7 実行方法・結果参照（必須）

#### 記載例

| 項目     | 内容                        |
| -------- | --------------------------- |
| 実行方法 | CI またはローカルで自動実行 |
| 実行単位 | モジュール単位              |
| 結果参照 | CI レポート、JUnit レポート |

---

### 6.8 メモ / 留意事項

- 実装変更時の注意点
- 将来追加予定のケース

---

## 7. 禁止事項

| 項目             | 理由           |
| ---------------- | -------------- |
| テストコード全文 | 設計書の役割外 |
| SQL・物理名      | 実装依存       |
| 値の総当たり列挙 | 保守不能       |
| 曖昧表現         | 合否不明       |

---

## 8. サンプル（最小）

```yaml
---
id: utd-inventory
type: test
title: 単体テスト設計: 在庫
status: draft
depends_on:
  - uts-inventory
  - tpc-order-process
tests:
  - inventory-unit-test
---
```

---

## 9. 生成AIへの指示テンプレート

> 以下のルールに従って **単体テスト設計（UTD）** を作成してください。
>
> - 入力は UTS-D（単体テスト仕様・個別）です。
> - ケースは「観点 × 条件」で分解し、代表ケースを設計してください。
> - テストコードの全文や具体値は書かないでください。
> - テストコードの構成・命名・実行方法が分かるようにしてください。
