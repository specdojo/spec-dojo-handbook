# 内部結合テスト設計（ITD）作成ルール

本ドキュメントは、品質保証・テスト実装のために
**内部結合テスト設計（Internal Integration Test Design: ITD）**
を統一形式で記述する標準ルールです。

ITD は、

- 内部結合テスト仕様（ITS / ITS-D）で定義された
- **保証観点・テスト条件**を
- **どのようにテストとして具体化するか**

を **実装可能な粒度**で設計することを目的とします。

---

## 0. 位置づけ（最重要）

ITD は「仕様」と「実装」の**中間成果物**です。

```plaintext
TSP（戦略）
 └ ITS（内部結合テスト仕様・全体）
    └ ITS-D（内部結合テスト仕様・個別）
       └ ITD（内部結合テスト設計） ← 本ドキュメント
          └ テスト実装・実行（JUnit / CI）
```

| 観点   | ITS / ITS-D    | ITD                      |
| ------ | -------------- | ------------------------ |
| 役割   | 何を保証するか | **どうやって確認するか** |
| 粒度   | 意味・観点     | **テスト構成・切り方**   |
| ケース | 代表条件のみ   | **ケース構造の設計**     |
| 実装   | 言及しない     | 参照先を明示             |

---

## 1. 全体方針

- ITD は **内部結合テストの実装方針書**です。
- 「個別ケースの羅列」ではありません。
- JUnit 等の **テストコードを直接貼らない**ことが原則です。
- 目的は以下の明確化です。
  - テスト単位の切り方
  - ケース設計の軸（データ × 振る舞い）
  - 自動化・実行・結果確認の方法

---

## 2. 対象と粒度

### 対象

- 内部結合テスト全体（ITS-main に対応）
- もしくは、特定の内部結合群（ITS-D 群）

### 粒度の原則

- **1 設計 = 複数の仕様（ITS-D）を束ねてもよい**
- 仕様が 1 件しかなくても、設計は単独で成立する

---

## 3. ファイル命名・ID規則

### ファイル名（推奨）

```sh
020-内部結合テスト設計.md
```

※ 個別設計は次ステップ（ITD-D）で分離します。

### Frontmatter

| 項目   | ルール                     |
| ------ | -------------------------- |
| id     | `itd-main`                 |
| type   | `test`                     |
| title  | 内部結合テスト設計         |
| status | draft / ready / deprecated |

---

## 4. 推奨 Frontmatter 項目

| 項目       | 説明         | 必須 |
| ---------- | ------------ | ---- |
| id         | ITD ID       | ○    |
| type       | `test`       | ○    |
| title      | 設計名       | ○    |
| status     | 状態         | ○    |
| owners     | 担当         | 任意 |
| depends_on | ITS / ITS-D  | 推奨 |
| tests      | テスト実装ID | 任意 |

---

## 5. 本文構成（標準テンプレ）

ITD は以下の見出しを **必ずこの順序**で記述します。

1. 概要
2. 対象範囲
3. テスト単位の設計
4. ケース設計方針
5. テストデータ設計方針
6. 実行・自動化方針
7. 結果確認・判定方法
8. 対象外
9. メモ / 将来課題

---

## 6. 記述ガイド詳細

### 6.1 概要

- この ITD が **どの内部結合テストを設計するか**を明記します。
- ITS / ITS-D との対応関係を文章で書きます。

例:

> 本設計は、内部結合テスト仕様（ITS-main）および在庫連携に関する個別仕様（ITS-inventory）に基づき、内部結合テストのケース設計および実行方針を定義する。

---

### 6.2 対象範囲

#### 推奨（表）

| 項目         | 内容                   |
| ------------ | ---------------------- |
| 対象連携     | 注文API × 在庫ドメイン |
| 対象仕様     | its-inventory          |
| テストレベル | 内部結合テスト         |
| 実行環境     | 結合試験環境           |

---

### 6.3 テスト単位の設計（必須）

**どの単位でテストを分けるか**を定義します。

例:

| テスト単位 | 説明                    |
| ---------- | ----------------------- |
| API 単位   | API 呼出結果の確認      |
| 連携単位   | API → Domain の状態遷移 |
| 例外単位   | エラー分岐ごとの確認    |

> ポイント
>
> - モジュール名・クラス名は書かない
> - 論理的な責務単位で分ける

---

### 6.4 ケース設計方針（最重要）

**ケースは「データ × 振る舞い」**で設計します。

#### 推奨表現

| 軸         | 内容                           |
| ---------- | ------------------------------ |
| 振る舞い軸 | 正常 / 例外 / 状態遷移 / 監査  |
| データ軸   | 境界値 / 業務的代表値 / 異常値 |

例:

- 正常 × 代表データ
- 正常 × 境界データ
- 例外 × 異常データ

※ 個々の値は **コード側**で定義します。

---

### 6.5 テストデータ設計方針

- データの作り方・粒度のみを記述します。
- 固定値や件数は書きません。

例:

| 観点             | 方針                   |
| ---------------- | ---------------------- |
| マスタ           | 業務代表パターンを用意 |
| トランザクション | 各ケースごとに独立生成 |
| 外部依存         | スタブを使用           |

---

### 6.6 実行・自動化方針

- **どこまで自動化するか**
- **どのツールを使うか（名称のみ）**

例:

| 項目     | 方針            |
| -------- | --------------- |
| 実行方法 | CI 上で自動実行 |
| ツール   | JUnit           |
| 実行頻度 | 毎コミット      |

---

### 6.7 結果確認・判定方法

| 観点 | 判定方法             |
| ---- | -------------------- |
| 機能 | Assertion の全成功   |
| 状態 | 状態遷移が仕様通り   |
| ログ | 必須ログが出力される |

---

### 6.8 対象外

例:

- 性能検証 → 非機能テスト
- 外部IF → 外部結合テスト

---

### 6.9 メモ / 将来課題

- 将来の結合拡張
- テスト高速化検討

---

## 7. 禁止事項

| 禁止              | 理由                 |
| ----------------- | -------------------- |
| SQL / JSON の貼付 | 実装依存             |
| JUnit コード全文  | 実装と重複           |
| ケース値の網羅    | メンテ不能           |
| クラス・関数名    | 設計の抽象度を下げる |

---

## 8. サンプル（最小）

```yaml
---
id: itd-main
type: test
title: 内部結合テスト設計
status: draft
depends_on:
  - its-main
  - its-inventory
---
```

---

## 9. 生成AI向け指示テンプレート

> - 以下のルールに従って **内部結合テスト設計（ITD）** を作成してください。
> - 対象は ITS / ITS-D で定義された内部結合です。
> - 個別テストケースや具体値は書かず、**ケース設計方針と実行方針**を記述してください。
> - 実装依存情報（SQL、クラス名、テストコード全文）は禁止です。
