# 内部結合テスト仕様（ITS）作成ルール

本ドキュメントは、品質保証・テスト設計のために **内部結合テスト仕様（Internal Integration Test Specification: ITS）を統一形式で記述する標準ルール**です。
ITS は「**システム内部（自組織の管理範囲）にあるコンテナ／コンポーネント間の連携**が、仕様どおり成立すること」を **Markdown でレビュー可能**な形に落とし込み、結合不具合の流入を防ぎます。

ITS は「テストコード」ではありません。
また、ITS は「個別のテスト手順書」でもなく、**何を連携の観点で保証するか（What）**を明確にする文書です。

---

## 1. 全体方針

- ITS は **内部結合（Internal Integration）**を対象とします。
  - 例: UI ↔ API、API ↔ Domain、API ↔ DB（論理I/Fとして）、Batch ↔ Domain、Service ↔ Queue（内部）など

- 外部システム（他社SaaS、決済、配送、IdP 等）との結合は **外部結合テスト仕様（ETS）**へ分離します。
- ITS は上位方針（TSP）と整合し、`depends_on` で根拠仕様（TPC/NFR/SAC/BAC/ADR/EAPIS 等）を追跡可能にします。
- 曖昧表現は禁止します。
  - 「正常に連携できること」ではなく、**入力／連携点／期待結果／観測点**を記述します。

- クリック手順の逐語列挙は避け、**業務行為／入力／期待結果**として要約します。
- 実装詳細（SQL全文、内部クラス名、特定ライブラリ設定の列挙）は書きません。
- 1ファイル = 1 仕様（原則）です。
  - 肥大化する場合は、`its-...` を連携対象（例: order-api, inventory-api）で分割し、`depends_on` で関連付けします。

---

## 2. 用語定義

| 用語          | 定義                                                                 |
| ------------- | -------------------------------------------------------------------- |
| ITS           | 内部結合テスト仕様。システム内部の連携で保証する範囲を定義する文書   |
| 内部結合      | 自組織が管理するシステム境界内のコンテナ／コンポーネント間連携       |
| 連携点        | I/F境界（API、メッセージ、DBアクセス（論理）、ファイル（内部）等）   |
| テスト対象    | 内部連携に関与する成果物（画面、API、バッチ、キュー等）              |
| 観測点        | 合否判定の根拠となる観測箇所（レスポンス、ログ、DB状態、イベント等） |
| スタブ/モック | 依存を切るための代替。内部結合では「内部は実、外はスタブ」が基本     |

---

## 3. ファイル命名・ID規則

### ファイル名（推奨）

- 全体: `010-内部結合テスト仕様.md`
- 個別: `010-内部結合テスト仕様-<用語集term>.md`（例: `010-内部結合テスト仕様-在庫.md`）

### Frontmatter

- `id`: `its-main`, `its-order-api`, `its-inventory-api` など（小文字ハイフン）
- `type`: `test`
- `title`: `内部結合テスト仕様: 全体` / `内部結合テスト仕様: 在庫` など

---

## 4. 推奨 Frontmatter 項目

| 項目       | 説明                                                    | 必須         |
| ---------- | ------------------------------------------------------- | ------------ |
| id         | ITS ID（`its-...`）                                     | ○            |
| type       | `test` 固定                                             | ○            |
| title      | 仕様名（例: 内部結合テスト仕様: 在庫）                  | ○            |
| status     | `draft` / `ready` / `deprecated`                        | ○            |
| owners     | 担当者                                                  | 任意         |
| tags       | タグ・分類                                              | 任意         |
| depends_on | 根拠となる仕様ID（TPC/NFR/SAC/BAC/EAPIS/UIS/BR/ADR 等） | 任意（推奨） |
| tests      | 下位の設計（ITD）や実装・実行（ITR）への参照            | 任意         |
| supersedes | 置き換え関係                                            | 任意         |

推奨:

- `depends_on` に `tsp-overview` と関連 `tpc-*` を含め、結合で確認すべき観点と対応させます。
- API連携なら `eapis-*`、画面なら `uis-*`、非機能なら `nfr-*`/`sac-*` を含めます。

---

## 5. 本文構成（標準テンプレ）

各 ITS ファイルは以下の見出しを順番に並べます。

1. 概要
2. 対象スコープと連携境界
3. 連携パターン一覧
4. 保証範囲（観点）
5. テスト条件（代表条件）
6. 合格基準とエビデンス
7. 対象外 / 除外理由
8. メモ / 将来課題

---

## 6. 記述ガイド詳細

### 6.1 概要

- 1〜3文で「どの内部連携を、何のために保証するか」を書きます。
- 可能なら対象仕様（BAC/NFR/主要機能）に言及し、`depends_on` と整合させます。

---

### 6.2 対象スコープと連携境界（必須）

「内部結合でどこまで実体連携するか」を明確にします。

#### 推奨（表）

| 項目       | 内容例                                               |
| ---------- | ---------------------------------------------------- |
| 対象範囲   | UI↔API、API↔Domain、API↔DB（論理）                |
| 対象成果物 | 画面（UIS）、API（EAPIS）、バッチ                    |
| 連携点     | REST、メッセージ、内部イベント、内部テーブル（論理） |
| 依存の扱い | 外部はスタブ、内部は実接続（原則）                   |
| 観測点     | レスポンス、イベント発行、DB状態、ログ               |

記述のコツ:

- DBは「物理テーブル名」を書かず、**データストア（概念）や業務データ辞書の用語**で記述します。

---

### 6.3 連携パターン一覧（必須）

内部結合で押さえるべき連携パターンを列挙します（ケースの羅列ではない）。

#### 推奨（表）

| パターンID | 呼称     | 連携元 → 連携先              | 連携点         | 目的                 |
| ---------- | -------- | ---------------------------- | -------------- | -------------------- |
| IIT-01     | 在庫引当 | Order API → Inventory Domain | API呼出        | 注文確定時に在庫引当 |
| IIT-02     | 状態更新 | Domain → Data Store          | 永続化（論理） | 状態を記録する       |
| IIT-03     | 内部通知 | Domain → Internal Event      | メッセージ     | 下流へ通知           |

---

### 6.4 保証範囲（観点）（必須）

「内部結合で何を保証するか」を観点として整理します。

#### 推奨カラム

| 観点ID | 観点分類 | 観点名    | 保証内容                                          | 根拠    |
| ------ | -------- | --------- | ------------------------------------------------- | ------- |
| II-01  | 正常     | 連携成功  | 正しい入力で連携が成立し、期待する出力/状態になる | TPC-xx  |
| II-02  | 例外     | 入力不正  | バリデーションで拒否され、状態が汚れない          | BR-xx   |
| II-03  | 例外     | 依存障害  | 内部依存が失敗した場合の扱いが仕様通り            | SAC-xx  |
| II-04  | 状態     | 状態遷移  | 状態依存分岐が正しく、遷移が正しい                | CSTD-xx |
| II-05  | 非機能   | 監査/ログ | 監査ログが必要箇所で残る                          | NFR-xx  |

---

### 6.5 テスト条件（代表条件）（必須）

具体的な値や手順は ITD（設計）へ委ねつつ、代表条件を示します。

| 観点ID | 条件ID | 条件（状態レベル） | 期待結果（方向性）                |
| ------ | ------ | ------------------ | --------------------------------- |
| II-01  | IC-01  | 正常入力で注文確定 | 在庫引当→状態更新→応答OK          |
| II-02  | IC-05  | 必須項目欠落       | 400/エラー、状態変更なし          |
| II-03  | IC-08  | 内部依存が失敗     | リトライ/ロールバック等が仕様通り |

---

### 6.6 合格基準とエビデンス（必須）

| 項目         | 合格基準（例）         | エビデンス   |
| ------------ | ---------------------- | ------------ |
| 実行結果     | 失敗0件                | CIレポート   |
| 重要観点     | Highの観点が全て実施済 | 実施記録     |
| 未解決不具合 | Critical 0             | 不具合管理票 |

---

### 6.7 対象外 / 除外理由（必須）

例:

- 外部サービス自体のSLA（外部契約に委ねる）→ ETSへ
- 性能のピーク検証 → NFR試験へ

---

### 6.8 メモ / 将来課題

- 未確定のIF（API変更予定など）
- 将来追加する結合パターン

---

## 7. 禁止事項

| 項目                               | 理由                 |
| ---------------------------------- | -------------------- |
| SQL全文、物理テーブル/物理カラム名 | 実装依存で変更に弱い |
| 内部クラス/関数名の列挙            | 実装依存で変更に弱い |
| クリック手順の逐語列挙             | UI変更に弱い         |
| 個別ケースの大量列挙               | ITD/実装に分解すべき |
| 「十分」「適切」等の曖昧表現       | 合否判定不能         |

---

## 8. サンプル（最小）

```yaml
---
id: its-main
type: test
title: 内部結合テスト仕様: 全体
status: draft
owners: []
tags: [test, integration, internal]
depends_on: [tsp-overview, tpc-order-process]
tests: [itd-main]
supersedes: []
---
```

---

## 9. 生成 AI への指示テンプレート

> - 以下のルールに従って **内部結合テスト仕様（ITS）** を 1 ファイル作成してください。出力は Markdown。
> - 目的: システム内部の連携で保証すべき範囲（連携境界・パターン・観点・条件・合格基準）を明文化する。
> - 禁止: SQL全文、物理名、実装クラス/関数名、クリック手順の逐語列挙、個別テストケースの大量列挙。
>
> ## 出力フォーマット
>
> - YAML Frontmatter（`id`/`type=test`/`title`/`status`必須）
> - 本文見出し（この順）:
>   1. 概要
>   2. 対象スコープと連携境界
>   3. 連携パターン一覧
>   4. 保証範囲（観点）
>   5. テスト条件（代表条件）
>   6. 合格基準とエビデンス
>   7. 対象外 / 除外理由
>   8. メモ / 将来課題
