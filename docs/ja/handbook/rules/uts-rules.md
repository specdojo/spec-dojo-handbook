# 単体テスト仕様（UTS）作成ルール

本ドキュメントは、品質保証・テスト実装のために **単体テスト仕様（Unit Test Specification: UTS）を統一形式で記述する標準ルール**です。
UTS は「単体テストで **何を保証するか（保証範囲）**」を、**レビューしやすい Markdown 形式**で明文化し、実装（JUnit 等）への落とし込みと、回帰・品質ゲートの判断根拠を揃えることを目的とします。

UTS は「テストコード」ではありません。
ただし、UTS はテストコードと強く対応し、**“コードで何を担保しているか”が説明できる**状態にします。

---

## 1. 全体方針

- UTS は **単体テストの保証範囲（What）**を定義します。
  - 例: 「在庫引当ロジックは、境界値・異常値・状態遷移の観点で担保する」

- 単体テストの主対象は **ドメインロジック/計算/バリデーション/分岐**です。
  - UI 表示・外部サービスの実体・DB の物理I/Oは原則対象外（必要ならモック/スタブで境界を切る）。

- UTS は上位成果物（TSP/TPC/NFR/SAC/BAC）に整合し、`depends_on` で根拠を追跡可能にします。
- UTS は下位成果物（単体テスト設計/実装）を導く上位仕様であり、**個別テストケースの羅列は禁止**です。
- 曖昧表現（例:「十分に」「基本的に」「適切に」）は禁止し、
  - 対象（含む/除外）
  - 合格基準（出口条件に影響する観点）
  - エビデンス（どのレポート/結果で判定するか）
    を明確に書きます。

- 1ファイル = 1 仕様（原則）です。
  - 肥大化する場合は `uts-...` を対象単位（例: コンポーネント/モジュール）で分割し、`depends_on` で関連付けします。

---

## 2. 用語定義

| 用語       | 定義                                                                   |
| ---------- | ---------------------------------------------------------------------- |
| UTS        | 単体テスト仕様。単体テストで保証する範囲・観点・条件を定義する文書     |
| 単体テスト | 最小単位（関数/クラス/コンポーネント等）の振る舞いを検証するテスト     |
| 対象単位   | 単体テストの粒度（例: ドメインサービス、ユースケース、ユーティリティ） |
| テスト境界 | 外部依存（DB/外部API/時刻/乱数）をモック等で切り分ける境界             |
| 観点       | 何を確認するかの切り口（正常/例外/境界/状態/非機能の一部 等）          |
| 条件       | 観点を検証するための入力・前提状態                                     |
| エビデンス | 合否判定の根拠（CI結果、カバレッジ、レポート）                         |

---

## 3. ファイル命名・ID規則

- ファイル名:
  - 全体: `010-単体テスト仕様.md`（推奨）
  - 個別: `010-単体テスト仕様-<用語集term>.md`（例: `010-単体テスト仕様-在庫.md`）

- Frontmatter:
  - `id`: `uts-main`, `uts-inventory` のように `uts-...`（小文字ハイフン）
  - `title`: 「単体テスト仕様: 全体」または「単体テスト仕様: 在庫」

推奨:

- `uts-main` を単体テスト仕様の入口（index）とし、個別仕様へリンクします。
- 個別仕様の `<用語集term>` は **用語集の表記に合わせて固定**します（リンク切れ対策）。

---

## 4. 推奨 Frontmatter 項目

Frontmatter は共通スキーマに従います。

| 項目       | 説明                                              | 必須 |
| ---------- | ------------------------------------------------- | ---- |
| id         | UTS ID（`uts-...`）                               | ○    |
| type       | `test` 固定                                       | ○    |
| title      | 仕様名（例: 単体テスト仕様: 在庫）                | ○    |
| status     | `draft` / `ready` / `deprecated`                  | ○    |
| version    | バージョン（SemVer）                              | 任意 |
| owners     | 担当者                                            | 任意 |
| tags       | タグ・分類                                        | 任意 |
| depends_on | 根拠となる仕様ID（TPC/NFR/SAC/BAC/BPS/BR/ADR 等） | 任意 |
| tests      | 下位文書（UTD/実装・実行）への参照ID（任意）      | 任意 |
| supersedes | 置き換え関係                                      | 任意 |

推奨:

- `depends_on` に `tpc-...`（観点・条件）を必ず含めます。
- `tests` に `utd-...`（単体テスト設計）や実装・実行への参照を置けるように ID を安定させます。

---

## 5. 本文構成（標準テンプレ）

各 UTS ファイルは以下の見出しを順番に並べます。

1. 概要
2. 対象と境界
3. 保証範囲（観点）
4. テスト条件（代表条件）
5. 合格基準とエビデンス
6. 対象外 / 除外理由
7. メモ / 将来課題

---

## 6. 記述ガイド詳細

### 6.1 概要

- 1〜3文で「この単体テストで何を保証するか」を書きます。
- `depends_on` に含めた上位仕様（TPC/NFR/BAC等）との整合を意識します。

---

### 6.2 対象と境界（必須）

単体テストの対象単位と、外部依存の切り方を明示します。

#### 推奨の書き方（表）

| 項目       | 内容例                                                       |
| ---------- | ------------------------------------------------------------ |
| 対象単位   | 在庫引当サービス、在庫計算ユーティリティ                     |
| 対象成果物 | ドメインサービス、ユースケース、バリデータ                   |
| テスト境界 | DB I/Oはリポジトリをモック、外部APIはスタブ、時刻はClock注入 |
| 依存の扱い | 例: 例外系はモックで再現、実接続は結合テストへ               |

記述のコツ:

- 「単体で担保すること」と「結合で担保すること」の境界を明確にします。

---

### 6.3 保証範囲（観点）（必須）

UTS の中核です。単体テストで保証する観点を一覧化します。

#### 推奨カラム

| 観点ID | 観点分類 | 観点名    | 保証内容（何を保証するか）                 | 優先度 | 備考（根拠） |
| ------ | -------- | --------- | ------------------------------------------ | ------ | ------------ |
| UT-01  | 正常     | 基本計算  | 入力が妥当な場合、計算結果が仕様通りである | High   | BR-xxx       |
| UT-02  | 境界     | 最小/最大 | 境界値で誤差なく処理できる                 | High   | TPC-xx       |
| UT-03  | 例外     | 入力不正  | 不正入力は例外/エラーで拒否される          | High   | BAC-xx       |
| UT-04  | 状態     | 状態遷移  | 状態条件により分岐が正しい                 | Mid    | CSTD-xx      |

記述のコツ:

- “正常/異常”だけで終わらせず、境界・状態・例外・ルールを分けます。
- ここで「網羅するべき切り口」を決め、個別ケースの列挙は UTD に委ねます。

---

### 6.4 テスト条件（代表条件）（必須）

UTD（設計）へ落とす前段として、代表的な条件を「状態レベル」で示します。

#### 推奨カラム

| 観点ID | 条件ID | 条件（状態レベル）           | 期待結果（方向性） |
| ------ | ------ | ---------------------------- | ------------------ |
| UT-02  | UC-01  | 在庫数=0、注文数=1           | 在庫不足として拒否 |
| UT-02  | UC-02  | 在庫数=最大値、注文数=最大値 | 正常に完了         |
| UT-03  | UC-05  | 商品IDが存在しない           | エラー/例外        |

記述のコツ:

- 具体的な値の羅列は禁止（必要なら“境界値”と書き、値は設計へ）。
- 条件は「データ×状態×分岐」が見える粒度にします。

---

### 6.5 合格基準とエビデンス（必須）

単体テストの完了条件を明文化します（TSPの出口条件と整合）。

#### 推奨の書き方（表）

| 項目               | 合格基準（例）                 | エビデンス          |
| ------------------ | ------------------------------ | ------------------- |
| 実行結果           | 失敗 0 件                      | CI のテストレポート |
| カバレッジ（任意） | 重要ロジックは分岐網羅を満たす | カバレッジレポート  |
| 未解決不具合       | Blocker/Critical 0 件          | 不具合管理票        |

記述のコツ:

- カバレッジは“数値だけ”を書かず、対象（重要ロジック等）を明示します。

---

### 6.6 対象外 / 除外理由（必須）

単体では扱わない事項を明確にします。

例:

- 外部APIの疎通（結合テストで担保）
- DB性能・インデックス（非機能/性能試験で担保）
- UI操作性（E2E/探索テストで担保）

---

### 6.7 メモ / 将来課題

- 未確定の境界条件
- 将来追加すべき観点（例: 監査ログの単体検証の追加）

---

## 7. 禁止事項

| 項目                                     | 理由                   |
| ---------------------------------------- | ---------------------- |
| テストコード全文の貼り付け               | 実装に委ねるべき       |
| 物理テーブル名・SQL全文                  | 実装依存で変更に弱い   |
| クリック手順の逐語列挙                   | UI変更に弱い           |
| 個別テストケースの大量列挙               | UTD/コードに分解すべき |
| 「十分」「適切」「問題ない」等の曖昧表現 | 合否判定不能           |
| 条件に前提がない数値（条件不明の閾値）   | 合意不能、再現不能     |

---

## 8. よくある誤りと対策

- UTS がケース集になっている
  → 観点・保証範囲に留め、ケースは UTD に委ねる
- 単体の境界が曖昧（どこまでモックするか）
  → 「対象と境界」表で外部依存の扱いを固定する
- 合格基準がない
  → CI結果など、判定可能なエビデンスを明記する
- 例外系が「異常系」と一括り
  → 入力不正、状態不正、外部例外（モック）など分類する

---

## 9. サンプル（最小）

### メタ情報

```yaml
---
id: uts-main
type: test
title: 単体テスト仕様: 全体
status: draft
version: '1.0.0'
owners: []
tags: [test, unit]
depends_on: [tsp-overview, tpc-order-process, bac-order-approved, br-discount]
tests: [utd-main]
supersedes: []
---
```

### 概要

単体テストにより、ドメインロジックの正確性（計算・分岐・入力検証）を保証し、結合テスト以降での不具合流入を抑止する。

---

## 10. 生成 AI への指示テンプレート

> 以下のルールに従って **単体テスト仕様（UTS）** を 1 ファイル作成してください。出力は **Markdown** とします。
>
> - 目的: 単体テストで保証する範囲（観点・条件・境界・合格基準）を明文化する
> - 禁止: テストコード全文、SQL、物理名、クリック手順、個別テストケースの大量列挙
>
> ## 出力フォーマット
>
> - 先頭に YAML Frontmatter（`id` / `type=test` / `title` / `status` 必須）
> - 本文は次の見出しをこの順で必ず含める:
>   1. 概要
>   2. 対象と境界
>   3. 保証範囲（観点）
>   4. テスト条件（代表条件）
>   5. 合格基準とエビデンス
>   6. 対象外 / 除外理由
>   7. メモ / 将来課題
>
> ## 記述ルール（重要）
>
> - 観点は「何を保証するか」を表で整理する（ケースの羅列は禁止）
> - 条件は「状態レベル」で代表例を示し、数値や手順は設計へ委ねる
> - 単体のテスト境界（モック/スタブ）を必ず明示する
> - 合格基準は判定可能な形（条件・根拠）で書く

---

必要なら次に、**単体テスト設計（UTD）作成ルール**も同じトーンで作れます（FV×DV、組合せ戦略、命名規約、タグ付け、テストコードへの紐付けなど）。
