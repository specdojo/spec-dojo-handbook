# 単体テスト仕様（個別仕様）（UTS-D）作成ルール

本ドキュメントは、単体テスト仕様（UTS）のうち、
**特定の対象（コンポーネント／ドメイン単位）に対する個別仕様**を統一形式で記述するための標準ルールです。

UTS-D（Unit Test Specification – Detailed）は、

- 単体テスト全体方針（`uts-main`）
- テスト観点・条件（TPC）

を前提として、
**「この対象について、単体テストで何をどこまで保証するか」**を明確化します。

---

## 1. 全体方針

- UTS-D は **単体テスト仕様（UTS）の詳細化**であり、独立した方針文書ではありません。
  - 必ず `uts-main` を前提にします。

- 対象は **1ドキュメント = 1論理対象**を原則とします。
  - 例: 在庫、商品、注文、価格計算、割引判定 など

- UTS-D は **「保証範囲の明確化」まで**を担い、
  - テストケースの具体値
  - テストコードの構造
    は **単体テスト設計（UTD）以降**に委ねます。

- 観点・条件は **TPC からの派生であることが追跡可能**でなければなりません。
- 曖昧な表現は禁止します。
  - 「基本的な処理」「正常に動作すること」などは禁止
  - **どの条件で、どの振る舞いを保証するか**を明示します。

---

## 2. 位置づけ（他ドキュメントとの関係）

UTS-D は以下の関係にあります。

```plaintext
TSP（テスト戦略・方針）
  ↓
TPC（テスト観点・条件）
  ↓
UTS（単体テスト仕様・全体）
  ↓
UTS-D（単体テスト仕様・個別）
  ↓
UTD（単体テスト設計）
  ↓
テストコード（JUnit 等）
```

---

## 3. ファイル命名・ID規則

### ファイル名

```text
010-単体テスト仕様-<用語集term>.md
```

例:

- `010-単体テスト仕様-在庫.md`
- `010-単体テスト仕様-注文.md`

> `<用語集term>` は **用語集（GL）に定義された論理名**を使用します。

---

### Frontmatter 規則

- `id`: `uts-<term>` 形式（小文字・ハイフン）
  - 例: `uts-inventory`

- `title`: `単体テスト仕様: <論理名>`

---

## 4. 推奨 Frontmatter 項目

| 項目       | 説明                                                         | 必須 |
| ---------- | ------------------------------------------------------------ | ---- |
| id         | UTS-D ID（`uts-<term>`）                                     | ○    |
| type       | `test` 固定                                                  | ○    |
| title      | 単体テスト仕様: <対象名>                                     | ○    |
| status     | `draft` / `ready` / `deprecated`                             | ○    |
| owners     | 担当者                                                       | 任意 |
| tags       | タグ（例: unit, domain, inventory）                          | 任意 |
| depends_on | 上位仕様（`uts-main`, `tpc-*`, `br-*`, `bac-*`, `nfr-*` 等） | 必須 |
| tests      | 下位設計（`utd-*`）や実装参照                                | 任意 |
| supersedes | 置き換え関係                                                 | 任意 |

### 推奨ルール

- `depends_on` には **必ず以下を含めます**
  - `uts-main`
  - 関連する `tpc-*`

- 業務ルール・受入条件に依存する場合は明示します。

---

## 5. 本文構成（標準テンプレ）

UTS-D は以下の見出し構成を **必ず守ります**。

1. 概要
2. 対象の責務と役割
3. 単体テストの対象範囲と境界
4. 保証する観点（個別）
5. テスト条件（代表条件）
6. 合格基準とエビデンス
7. 対象外・除外理由
8. メモ / 将来課題

---

## 6. 記述ガイド詳細

### 6.1 概要

- この対象について、**単体テストで何を保証するのか**を簡潔に記載します。
- 全体仕様（`uts-main`）との差分・特記事項があれば明示します。

例:

> 本ドキュメントは、在庫コンポーネントに対する単体テスト仕様を定義し、
> 在庫引当・減算・不足判定の正確性を保証する。

---

### 6.2 対象の責務と役割（必須）

対象の責務を **業務・設計観点で簡潔に説明**します。

#### 推奨の書き方

| 項目       | 内容                           |
| ---------- | ------------------------------ |
| 対象名     | 在庫                           |
| 主な責務   | 在庫数量の管理、引当可否の判定 |
| 関連ルール | 在庫引当ルール、欠品判定ルール |
| 上位モデル | 業務プロセス: 発注処理         |

> 実装構造（クラス名等）は書きません。

---

### 6.3 単体テストの対象範囲と境界（必須）

#### 推奨の書き方（表）

| 区分         | 内容                               |
| ------------ | ---------------------------------- |
| 対象に含める | 在庫数量計算、引当判定、境界値判定 |
| 境界で切る   | DB 永続化、外部API連携             |
| 依存の扱い   | リポジトリはモック、時刻は固定     |

記述のポイント:

- 「どこまで単体で責任を持つか」を明示
- 結合テストとの責務分離を意識

---

### 6.4 保証する観点（個別）（必須）

UTS-D の中核です。
この対象で **必ず保証する観点**を整理します。

#### 推奨カラム

| 観点ID  | 観点分類 | 観点名   | 保証内容                         | 根拠    |
| ------- | -------- | -------- | -------------------------------- | ------- |
| UT-I-01 | 正常     | 引当可能 | 在庫が十分な場合、引当が成功する | TPC-01  |
| UT-I-02 | 境界     | 在庫0    | 在庫0では引当不可と判定される    | BR-xx   |
| UT-I-03 | 例外     | 不正数量 | 負数指定はエラーとなる           | BAC-xx  |
| UT-I-04 | 状態     | 状態遷移 | 状態に応じて分岐が正しい         | CSTD-xx |

---

### 6.5 テスト条件（代表条件）（必須）

UTD に落とすための **代表条件**を列挙します。

#### 推奨カラム

| 観点ID  | 条件ID | 条件（状態レベル） | 期待される振る舞い |
| ------- | ------ | ------------------ | ------------------ |
| UT-I-01 | UC-01  | 在庫数 > 注文数    | 引当成功           |
| UT-I-02 | UC-02  | 在庫数 = 0         | 引当不可           |
| UT-I-03 | UC-05  | 注文数が負数       | エラー             |

> 数値・具体値は設計（UTD）へ委ねます。

---

### 6.6 合格基準とエビデンス（必須）

#### 推奨の書き方

| 項目         | 基準         | エビデンス  |
| ------------ | ------------ | ----------- |
| テスト結果   | 失敗0件      | CI レポート |
| 重要観点     | すべて検証済 | テスト結果  |
| 未解決不具合 | Critical 0   | 不具合一覧  |

---

### 6.7 対象外・除外理由（必須）

例:

- DB トランザクション保証（結合テスト）
- 同時実行制御（性能・非機能テスト）

---

### 6.8 メモ / 将来課題

- 将来追加したい観点
- 未確定の業務ルール

---

## 7. 禁止事項

| 項目                   | 理由         |
| ---------------------- | ------------ |
| テストコードの記載     | 実装に委ねる |
| SQL / クラス名         | 実装依存     |
| テストケース番号の羅列 | 設計に委ねる |
| 曖昧表現               | 合否判定不能 |

---

## 8. サンプル（最小）

```yaml
---
id: uts-inventory
type: test
title: 単体テスト仕様: 在庫
status: draft
owners: []
tags: [unit, inventory]
depends_on:
  - uts-main
  - tpc-order-process
  - br-inventory-allocation
tests:
  - utd-inventory
supersedes: []
---
```

---

## 9. 生成AIへの指示テンプレート

> 以下のルールに従って **単体テスト仕様（個別仕様）** を 1 ファイル作成してください。
>
> - 対象は 1 つの論理単位（用語集の term）とします。
> - 観点は「何を保証するか」、条件は「どの状態で確認するか」を書いてください。
> - テストコード・具体値・SQL・クラス名は記載しないでください。
> - 上位仕様（UTS/TPC/BAC/BR）と必ずトレース可能にしてください。
