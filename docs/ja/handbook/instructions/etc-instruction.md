# 外部結合テストカタログ 対象別 作成の指示テンプレート

以下のルールに従って、**外部結合テストカタログ-対象別（`etc-<term>`）** を 1 ファイル作成してください。出力は **Markdown** とします。

- `etc-<term>` は **対象固有の情報のみ**を記述し、共通ルールは `etc-overview` を参照します（重複記述しない）。
- 外部結合テストの目的は「**外部境界を跨いだ結合の振る舞い**を、実運用に近い前提で検証すること」です。
- ケースは「表の1行＝1テスト」とし、手順と期待値は **判定可能**な粒度で簡潔に書きます。
- 直積（全組合せ）は避け、代表→境界→重大例外の順で増やします（必要時は理由・範囲を明記）。
- 外部依存（sandbox/スタブ/モック）・テストデータ・秘密情報の扱いは、再現性と安全性を優先して固定します。

## 事前に与えられる情報（入力）

次の情報が与えられている前提で、それに整合する `etc-<term>` を生成してください（不明な場合は「未確定」として明記してよい）。

- 対象システム/プロダクトの概要
- 上位方針: `tsp-overview`
- `etc-overview`（共通方針）
- 対象 `term` の結合責務、境界、主要I/F（API、Webhook、Queue、SDK等）
- 参照すべき上位仕様（`br-*` / `bac-*` / `spec-*` / `nfr-*` 等）
- 外部依存（外部サービス、認証、ネットワーク、時刻等）と扱いの方針
- テストコード/CI での証跡参照先（外部リクエストID、ログ相関キー等）

## 出力フォーマット（必須）

### YAML Frontmatter（必須）

先頭に YAML Frontmatter を付与し、以下の形式で記述してください（`id` / `type` / `title` / `status` は必須、`type` は `test` 固定）。

```yaml
---
id: etc-<term>
type: test
title: 外部結合テストカタログ: <対象名>
status: draft # draft / ready / deprecated
part_of: []
based_on:
 - tsp-overview
 - etc-overview
supersedes: []
---
```

- `based_on` には **最低限** `tsp-overview` と `etc-overview` を含めてください。
- 対象固有の根拠（`br-*` / `bac-*` / `spec-*` / `nfr-*` 等）は、本文の **トレース表** に集約します。

### 本文の見出し（必須・順序固定）

本文は次の見出し（日本語）をこの順序で必ず含めてください。

1. 概要（`<term>`）
2. 責務
3. 対象外
4. 境界/依存/環境
5. トレース
6. テスト観点とケース
7. 実行運用メモ（任意）

## 記述ルール（重要）

### スコープ（書く / 書かない）

- 書く: 対象固有の結合責務・境界・外部依存/環境、観点×条件＝ケース、トレース、証跡
- 書かない: `etc-overview` にある共通方針の再掲、詳細な操作の逐語列挙、データ大量列挙

### 追跡可能性（トレース）

- 本ドキュメントの **トレース表が一次情報（SSOT）** です。
- 観点/ケース表では **仕様IDを直書きせず** `TR-xx` のみ参照します。

### ケース/具体値の扱い

- ケース表の 1 行は 1 テスト（条件×期待値が一意）とします。
- 具体値や詳細手順は最小限に抑え、必要な詳細はテストコードに委譲します。

## 各セクションの書き方

### 1. 概要（`<term>`）

- 対象が何であり、どの外部境界を跨ぐ結合を本カタログで扱うかを 1〜3 行で書く。
- `etc-overview` の分割基準に従い、過分割／肥大化を避ける。

### 2. 責務

- 「この外部結合が何を保証すべきか（ETで確認する責務）」を **動詞で始まる箇条書き** で 3〜7 個程度示す。
- 重大失敗モード（タイムアウト、レート制限、部分失敗、二重処理等）を含める。

### 3. 対象外

- 対象外は理由と代替レベルを併記する（例: 「xxx（理由: yyy、代替: ST）」）。
- `etc-overview` の対象外と矛盾しない。

### 4. 境界/依存/環境

- 境界（入口/出口）を明記する。
- 外部依存はカテゴリごとに列挙し、扱い（sandbox/実/スタブ/モック）と観測点を決める。
- 秘密情報の扱い、テストデータの作り方・クリーンアップ方針を明記する。

### 5. トレース

- 仕様IDに対応する **トレース表** を作成する。
- 各行に `trace_key`（`TR-01` 形式）を付与し、観点/ケース表では `TR-xx` のみ参照する。

### 6. テスト観点とケース

- 観点（見出し）→ 意図 → 条件・ケース表の順で構成する。
- `case_id` は `<level>-<term>-<perspective_key>-<nnn>` を推奨し変更しない。
- `条件` は「入力/状態/環境」で表現する。
- `手順（最小）` は抽象化した最小手順に留める。
- `期待値` は判定可能に書く（観測点を含める）。

### 7. 実行運用メモ（任意）

- テストデータの作り方／namespace／削除手順
- 失敗時のリトライ手順・外部側の後始末（取消、返金、無効化等）
- 実行制約（並列不可、回数制限、実行時間帯、レート制限）
- 外部サービスのメンテ時間や制限がある場合の注意

## ケース表の共通カラム（必須）

`etc-overview` の定義に従い、以下のカラムを **順序固定** で使用します。

- **必須カラム**: `case_id` / `条件` / `手順（最小）` / `期待値`
- **推奨カラム**: `観測点（アサーション）` / `境界/依存` / `トレース` / `優先度` / `自動化` / `証跡`

## 最終チェック（自己検査）

- `id: etc-<term>` / `type: test` / `status` が設定されている
- `based_on` に `tsp-overview` と `etc-overview` が入っている
- 見出しが指定順序で揃っている（欠落なし）
- トレース表が SSOT になっている（`TR-xx` 参照で統一）
- ケース表のカラムが `etc-overview` と一致している
