# データ移行設計 作成の指示テンプレート

以下のルールに従って、**データ移行設計（`dmd-index` / `dmd-<term>`）** を 1 ファイル作成してください。出力は **Markdown** とします。

- `dmd-index` はデータ移行設計の入口（共通SSOT）です。
- `dmd-<term>` は対象別の個別SSOTです。
- 抽出/変換/投入/検証を、同条件で再実行できる粒度で記述してください。
- 合否判定可能な基準（差分0 / 許容差ε）と証跡を必ず明記してください。

## 事前に与えられる情報（入力）

次の情報が与えられている前提で、それに整合する `dmd-index` または `dmd-<term>` を生成してください（不明な場合は「未確定」として明記してよい）。

- 移行対象データ（テーブル/コレクション、期間、抽出条件、概算件数）
- 旧→新のデータマッピング（主キー/参照整合の扱いを含む）
- 変換ルール（コード変換、正規化、丸め、文字種変換など）
- 除外ルール（対象外条件、理由、影響）
- 実行方式（手動/バッチ/ツール）、実行順序、入出力
- 性能前提（件数、並列度、スループット）と所要時間見積
- ログ方針、識別キー（例: `run_id`）、冪等性・再実行方針
- 検証方法（件数照合/サンプル照合/重要値照合）と合格基準
- 関連ドキュメント（`mip-index` / `dmd-index` / `dmd-<term>` など）

## 出力フォーマット（必須）

### YAML Frontmatter（必須）

先頭に YAML Frontmatter を付与し、以下の形式で記述してください（`id` / `type` / `title` / `status` は必須、`type` は `migration` 固定）。

#### `dmd-index` を作る場合

```yaml
---
id: dmd-index
type: migration
title: データ移行設計: 全体
status: draft # draft / ready / deprecated
based_on: []
supersedes: []
---
```

#### `dmd-<term>` を作る場合

```yaml
---
id: dmd-<term>
type: migration
title: データ移行設計: <対象名>
status: draft # draft / ready / deprecated
based_on: []
supersedes: []
---
```

- `based_on` には移行判断に直接利用した成果物のみを列挙してください（例: `mip-index` / `br-*` / `nfr-*` / `issue-*`）。

### 本文の見出し（必須・順序固定）

#### `dmd-index` の場合

1. 概要（index）
2. 共通方針（抽出/変換/除外/冪等性/ログ）
3. run_id 規約（命名/採番/記録/参照方法）
4. 検証の共通方針（種別/基準/証跡/保管）
5. 対象一覧（スコープ/非対象/担当/対応ドキュメント）
6. 関連ドキュメント（必須）

#### `dmd-<term>` の場合

1. 概要（`<term>`）
2. 対象データ詳細（テーブル/期間/抽出条件/概算件数）
3. データマッピング
4. 変換ルール
5. 除外ルール
6. 移行手順（手動/バッチ/ツール）
7. 性能/所要時間見積
8. ログ/再実行性
9. 検証方法（件数照合/サンプル照合/重要値）
10. 関連ドキュメント（必須）

## 記述ルール（重要）

### スコープ（書く / 書かない）

- 書く: 再現性と合否判定に必要な情報（対象範囲、変換、手順、検証、証跡）
- 書かない: 長大な実装コード、長大SQL、運用Runbookの詳細手順（必要なら参照リンク）

### 再現可能性

- 曖昧表現（例: 「適宜」「必要に応じて確認」）は禁止し、**再実行条件が明確な記述** にする。
- 抽出条件、実行単位、冪等性方式、再実行可否を必ず明記する。
- 検証は「何をどう比較し、どの基準で合格とするか」を必ず明記する。

### SSOTと導線

- `dmd-index` は共通方針の正とし、個別詳細は `dmd-<term>` に委譲する。
- `dmd-index` は各 `dmd-<term>` への導線を必ず持たせる。
- `dmd-<term>` は `dmd-index` への導線を必ず持たせる。

## 各セクションの書き方

### 1. 概要（index / `<term>`）

- `dmd-index`: 目的（再現性・品質担保）と範囲を 1〜3 行で示す。
- `dmd-<term>`: 対象データと移行範囲、依存前提（方式/期間）を 1〜3 行で示す。

### 2. 共通方針（index） / 対象データ詳細（term）

- `dmd-index` の共通方針: 抽出（フル/増分）、変換/除外、冪等性、ログ要件の原則を定義する。
- `dmd-<term>` の対象データ詳細: 対象、期間/抽出条件、方式（フル/増分）、増分基準、概算件数を明記する。

`dmd-<term>` 推奨フォーマット（表）:

| 対象 | 期間/抽出条件 | 方式（フル/増分） | 増分基準（カラム/キー/基準時刻） | 概算件数 | 備考 |
| ---- | ------------- | ----------------- | -------------------------------- | -------- | ---- |

### 3. run_id 規約（index） / データマッピング（term）

- `dmd-index`: run_id の命名/採番/記録先/参照方法を定義する。
- `dmd-<term>`: 旧→新対応、1対多/多対1、主キー/参照整合の扱いを明記する。

`dmd-index` 推奨フォーマット（表）:

| 項目     | 方針 |
| -------- | ---- |
| 命名     |      |
| 採番     |      |
| 記録先   |      |
| 参照方法 |      |

`dmd-<term>` 推奨フォーマット（表）:

| 旧データ | 新データ | 変換/補足 |
| -------- | -------- | --------- |

### 4. 検証の共通方針（index） / 変換ルール（term）

- `dmd-index`: 検証種別（件数/サンプル/重要値）、合格基準の書き方、証跡保管を定義する。
- `dmd-<term>`: 変換規則（正規化、コード変換、丸め等）を列挙し、根拠を示す。

### 5. 対象一覧（index） / 除外ルール（term）

- `dmd-index`: 対象/非対象/担当/対応DMDを一覧化し、分冊への導線を示す。
- `dmd-<term>`: 除外条件、除外理由、必要に応じて影響を明記する。

`dmd-index` 推奨フォーマット（表）:

| 区分 | 対象（論理名） | 旧→新 | 方針（フル/増分） | 担当 | 対応DMD |
| ---- | -------------- | ----- | ----------------- | ---- | ------- |

### 6. 関連ドキュメント（index） / 移行手順（term）

- `dmd-index`: 各 `dmd-<term>` への導線を必ず記載する。
- `dmd-<term>`: 手段、実行順序、依存関係、入出力、実行単位（ジョブ/コマンド/ツール）を明記する。

`dmd-<term>` 推奨フォーマット（表）:

| 手順 | 内容 | 入力 | 出力 | 実行単位（ジョブ/コマンド） | 備考 |
| ---- | ---- | ---- | ---- | --------------------------- | ---- |

### 7-9. term固有（性能/所要時間見積、ログ/再実行性、検証方法）

- 性能/所要時間見積: 前提条件（件数、並列度、スループット）と見積を明記する。
- ログ/再実行性: 識別キー、ログ保存先、冪等性方式、再実行条件を明記する。
- 検証方法: 件数照合/サンプル照合/重要値照合の方法、合格基準（差分0 / 許容差ε）、証跡を明記する。

`dmd-<term>` 推奨フォーマット（表）:

| 項目         | 方針                                       |
| ------------ | ------------------------------------------ |
| 識別キー     | run_id                                     |
| ログ保存先   | （例：S3/ログ基盤/DB）                     |
| 冪等性方式   | upsert / run_id隔離 / …                    |
| 再実行可否   | （例：同一run_id不可、別run_idで再実行可） |
| データ無効化 | （例：run_id単位で隔離/フラグ）            |

| 検証種別 | 検証項目 | 方法 | 合格基準（差分0 / 許容差ε） | 証跡 |
| -------- | -------- | ---- | --------------------------- | ---- |

### 10. 関連ドキュメント（term）

- `dmd-<term>` では `dmd-index`（入口SSOT）への導線を必ず記載する。
- 分冊がない場合でも `（本書のみ）` を明記して空欄にしない。

## 最終チェック（自己検査）

- `id` が `dmd-index` または `dmd-<term>` である
- `type: migration` / `status` が設定されている
- 見出しが指定順序で揃っている（欠落なし）
- `dmd-index` の場合、共通方針・run_id規約・検証共通方針・対象一覧・関連ドキュメントがある
- `dmd-<term>` の場合、対象データ詳細に「方式（フル/増分）」と「増分基準」がある
- `dmd-<term>` の場合、データマッピングに主キー/参照整合の扱いがある
- `dmd-<term>` の場合、移行手順に実行単位（ジョブ/コマンド/ツール）と入出力がある
- `dmd-<term>` の場合、ログ/再実行性に識別キー・冪等性方式・再実行条件がある
- `dmd-<term>` の場合、検証方法に件数照合/サンプル照合/重要値照合と合格基準（差分0 / 許容差ε）がある
- `関連ドキュメント` が空欄でない（`（本書のみ）` でも可）
