# データ移行設計 作成の指示テンプレート

以下のルールに従って、**データ移行設計（`dmd-<term>`）** を 1 ファイル作成してください。出力は **Markdown** とします。

- `dmd-<term>` は、旧→新データ移行を **再現可能** に定義するための設計書です。
- 移行対象、マッピング、変換、実行手順、検証方法を、同条件で再実行できる粒度で記述してください。
- 合否判定可能な基準（差分0 / 許容差ε）と証跡を必ず明記してください。

## 事前に与えられる情報（入力）

次の情報が与えられている前提で、それに整合する `dmd-<term>` を生成してください（不明な場合は「未確定」として明記してよい）。

- 移行対象データ（テーブル/コレクション、期間、抽出条件、概算件数）
- 旧→新のデータマッピング（主キー/参照整合の扱いを含む）
- 変換ルール（コード変換、正規化、丸め、文字種変換など）
- 除外ルール（対象外条件、理由、影響）
- 実行方式（手動/バッチ/ツール）、実行順序、入出力
- 性能前提（件数、並列度、スループット）と所要時間見積
- ログ方針、識別キー（例: `run_id`）、冪等性・再実行方針
- 検証方法（件数照合/サンプル照合/重要値照合）と合格基準

## 出力フォーマット（必須）

### YAML Frontmatter（必須）

先頭に YAML Frontmatter を付与し、以下の形式で記述してください（`id` / `type` / `title` / `status` は必須、`type` は `migration` 固定）。

```yaml
---
id: dmd-<term>
type: migration
title: データ移行設計: <対象名>
status: draft # draft / ready / deprecated
based_on: []
supersedes: []
---
```

- `based_on` には移行判断に直接利用した成果物のみを列挙してください（例: `br-*` / `nfr-*` / `issue-*`）。

### 本文の見出し（必須・順序固定）

本文は次の見出し（日本語）をこの順序で必ず含めてください。

1. 概要（`<term>`）
2. 対象データ詳細（テーブル/期間/抽出条件/概算件数）
3. データマッピング
4. 変換ルール
5. 除外ルール
6. 移行手順（手動/バッチ/ツール）
7. 性能/所要時間見積
8. ログ/再実行性
9. 検証方法（件数照合/サンプル照合/重要値）

## 記述ルール（重要）

### スコープ（書く / 書かない）

- 書く: 再現性と合否判定に必要な情報（対象範囲、変換、手順、検証、証跡）
- 書かない: 長大な実装コード、長大SQL、運用Runbookの詳細手順（必要なら参照リンク）

### 再現可能性

- 曖昧表現（例: 「適宜」「必要に応じて確認」）は禁止し、**再実行条件が明確な記述** にする。
- 抽出条件、実行単位、冪等性方式、再実行可否を必ず明記する。
- 検証は「何をどう比較し、どの基準で合格とするか」を必ず明記する。

## 各セクションの書き方

### 1. 概要（`<term>`）

- 対象データと移行範囲を 1〜3 行で示す。
- 依存する前提（移行方式、移行期間）を簡潔に示す。

### 2. 対象データ詳細（テーブル/期間/抽出条件/概算件数）

- 対象テーブル/コレクションを列挙する。
- 期間/抽出条件、方式（フル/増分）、増分基準（基準カラム/キー/基準時刻）を明記する。
- 概算件数は見積り根拠が分かる粒度で示す。

推奨フォーマット（表）:

| 対象 | 期間/抽出条件 | 方式（フル/増分） | 増分基準（カラム/キー/基準時刻） | 概算件数 | 備考 |
| ---- | ------------- | ----------------- | -------------------------------- | -------- | ---- |

### 3. データマッピング

- 旧→新の対応を明確に示す。
- 1対多/多対1の関係は変換ルールと合わせて記述する。
- 主キー/参照整合（FK相当）の扱い（維持/再採番/変換テーブル、投入順序の前提）を明記する。

推奨フォーマット（表）:

| 旧データ | 新データ | 変換/補足 |
| -------- | -------- | --------- |

### 4. 変換ルール

- 変換規則（正規化、コード変換、丸め、文字種変換等）を列挙する。
- 再実行しても同じ結果になる前提で記述する。
- 根拠（参照表/仕様ID）がある場合はリンクする。

### 5. 除外ルール

- 移行対象外条件を列挙する。
- 除外理由（業務上不要、期限切れ、品質不良等）を明記する。
- 必要に応じて、除外時の影響（参照のみ/業務影響なし/代替手段あり）を追記する。

### 6. 移行手順（手動/バッチ/ツール）

- 手段（手動/バッチ/ツール）を明示する。
- 実行順序と依存関係を示す。
- 入出力（形式/置き場）と実行単位（ジョブ名/コマンド/ツール名）を明記する。

推奨フォーマット（表）:

| 手順 | 内容 | 入力 | 出力 | 実行単位（ジョブ/コマンド） | 備考 |
| ---- | ---- | ---- | ---- | --------------------------- | ---- |

### 7. 性能/所要時間見積

- 所要時間見積と前提条件（件数、並列度、スループット）を明記する。
- 目標時間（停止許容時間など）があれば明記する。
- ボトルネックが想定される場合は暫定対策（並列化/分割/先行移行）を記載する。

### 8. ログ/再実行性

- ログ保存先と識別キー（例: `run_id`）を明記する。
- 再実行条件（再投入可能範囲、再実行可否）を明記する。
- 冪等性方式（`upsert` / `run_id隔離` / `再投入前truncate` / `差分適用` など）を明記する。

推奨フォーマット（表）:

| 項目         | 方針                                       |
| ------------ | ------------------------------------------ |
| 識別キー     | run_id                                     |
| ログ保存先   | （例：S3/ログ基盤/DB）                     |
| 冪等性方式   | upsert / run_id隔離 / …                    |
| 再実行可否   | （例：同一run_id不可、別run_idで再実行可） |
| データ無効化 | （例：run_id単位で隔離/フラグ）            |

### 9. 検証方法（件数照合/サンプル照合/重要値）

- 件数照合、サンプル照合、重要値照合の方法を明記する。
- 合格基準は「差分0」または「許容差（ε）」を必ず明示する。
- 検証結果の証跡（レポート/ログ）を明記する。

推奨フォーマット（表）:

| 検証種別 | 検証項目 | 方法 | 合格基準（差分0 / 許容差ε） | 証跡 |
| -------- | -------- | ---- | --------------------------- | ---- |

## 最終チェック（自己検査）

- `id: dmd-<term>` / `type: migration` / `status` が設定されている
- 見出しが指定順序で揃っている（欠落なし）
- 対象データ詳細に「方式（フル/増分）」と「増分基準」がある
- データマッピングに主キー/参照整合の扱いがある
- 移行手順に実行単位（ジョブ/コマンド/ツール）と入出力がある
- ログ/再実行性に識別キー・冪等性方式・再実行条件がある
- 検証方法に件数照合/サンプル照合/重要値照合と合格基準（差分0 / 許容差ε）がある
