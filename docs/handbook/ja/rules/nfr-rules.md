# 非機能要件（NFR）作成ルール

本ドキュメントは、品質保証・運用設計・テスト設計のために **非機能要件（Non-Functional Requirements: NFR）を統一形式で記述する標準ルール**です。
NFR は「性能・可用性・セキュリティ等の品質要求」を、**測定可能・検証可能**な形で定義し、後工程（設計・実装・運用・試験）で解釈ブレを起こさないことを目的とします。

## 1. 全体方針

- NFR は「品質要求（Quality Attribute）」であり、**対象（何に）＋条件（いつ）＋指標（何を）＋基準（どれくらい）** を明確に書きます。
  - 例: 「在庫照会APIは、平常時の P95 応答時間 500ms 以内である」
- 曖昧な表現（例: 「高速」「安定」「十分」「強固」）は禁止し、**観測・計測できる事実**に落とします。
- 実装詳細（例: 物理テーブル名、SQL、具体ライブラリ設定、クラス/関数名）は記載しません。
- NFR は「守るべき制約・合格基準」です。**運用で実現するもの**（監視、バックアップ、手順）も NFR として扱ってよいですが、要件は“結果”として書き、手順は最小限に要約します。
- NFR は原則として **RASIS（信頼性/可用性/保守性/完全性/機密性・安全性）** の観点で抜け漏れがないことを確認します（詳細は「6.2.4」）。
- 1ファイル = 1 受入対象（品質要求のまとまり）を基本とします。
  - 例: `性能（主要画面/API）`, `可用性・復旧`, `セキュリティ`, `運用性・監視` など
  - 肥大化する場合は、カテゴリやサブシステム単位で分割し、`depends_on` で関連付けします。

## 2. 用語定義

| 用語           | 定義                                                                                         |
| -------------- | -------------------------------------------------------------------------------------------- |
| NFR            | 非機能要件。性能・可用性・保守性・運用性・セキュリティ等の品質要求                           |
| RASIS          | 非機能要件の抜け漏れを防ぐ観点（Reliability/Availability/Serviceability/Integrity/Security） |
| Reliability    | 信頼性（障害・誤動作が起きにくく、起きても影響を抑えられること）                             |
| Availability   | 可用性（利用可能であること、停止時間を抑えること）                                           |
| Serviceability | 保守性（障害検知・原因特定・復旧・変更がしやすいこと）                                       |
| Integrity      | 完全性（データ/処理の正しさ・矛盾の防止、改ざん検知・追跡性）                                |
| Security       | 機密性・安全性（不正アクセス防止、権限制御、監査、情報漏えい防止）                           |
| 対象           | NFR が適用される範囲（例: 画面、API、バッチ、帳票、システム全体）                            |
| 条件           | 計測・運用の前提条件（例: 平常時/ピーク時、同時接続、データ量、障害種別）                    |
| 指標           | 測る値（例: 応答時間、RPS、稼働率、RTO/RPO、ログ保持期間）                                   |
| 基準           | 合否を判定する閾値（例: P95 500ms、月間稼働率 99.9%）                                        |
| 測定/検証方法  | 合否判定の観測点（例: 負荷試験、監視メトリクス、監査ログ、運用レポート）                     |
| 例外/除外      | 対象外とする範囲（例: 外部サービス停止時は除外、メンテナンス時間は除外）                     |

## 3. ファイル命名・ID規則

- ファイル名: `nfr-<番号>-<短い日本語名>.md` （例: `nfr-0010-性能.md`）
- Frontmatter:
  - `id`: `nfr-performance`, `nfr-availability` のように小文字ハイフン形式。
  - `title`: 「非機能要件: 性能」など。

推奨:

- カテゴリ別に分割する場合、`nfr-performance-api`, `nfr-security-access-control` のように **範囲が分かる ID** にします。
- 上位の NFR（例: `nfr-performance`）が下位文書（例: `nfr-performance-api`, `nfr-performance-ui`）を持つ場合は、上位の `depends_on` に下位 ID を列挙するのではなく、次のどちらかに統一してください（参照方向を混在させない）。
  - 下位側が上位を `depends_on` で参照する（“前提”として参照）
  - もしくは分割せずに 1 ファイルで管理する

## 4. 推奨 Frontmatter 項目

Frontmatter は `docs/handbook/shared/schemas/spec-frontmatter.schema.yaml` の制約に従います。

| 項目       | 説明                                                    | 必須 |
| ---------- | ------------------------------------------------------- | ---- |
| id         | NFR ID（`nfr-...`）                                     | ○    |
| type       | `architecture` 固定（品質要求の合意文書として扱う）     | ○    |
| title      | 非機能要件名（例: 非機能要件: 性能）                    | ○    |
| status     | `draft`/`ready`/`deprecated`                            | ○    |
| version    | バージョン（SemVer）                                    | 任意 |
| owners     | 担当者                                                  | 任意 |
| tags       | タグ・分類                                              | 任意 |
| depends_on | 参照する仕様ID（BPS/BR/UIS/EAPIS/TSL/ADR 等）           | 任意 |
| implements | 満たすべき上位方針（ルール/ポリシー）があれば           | 任意 |
| tests      | この NFR を検証する仕様/受入条件ID（SAC/テスト仕様 等） | 任意 |
| supersedes | 置き換え関係（古仕様→新仕様）                           | 任意 |

推奨:

- `tests` に、NFR を満たすことを判定する **システム受入条件（SAC）** やテスト仕様 ID を列挙します。
- `depends_on` に、対象となる主要仕様 ID（例: `eapis-...`, `uis-...`, `bps-...`）を列挙し、範囲を明確にします。

## 5. 本文構成（標準テンプレ）

各 NFR ファイルは以下の見出しを順番に並べます。

1. 概要
2. 非機能要件
3. メモ / 将来課題

## 6. 記述ガイド詳細

### 6.1 概要

- 1〜3文で「どの品質を、どの範囲に対して、何のために」定めるかを書きます。
- 可能なら、対象仕様（API/画面/業務プロセス等）を言及し、`depends_on` と整合させます。

任意（レビューが速くなる場合のみ）:

- スコープ（対象外）を 1〜3 行で明記してよいです。
  - 例: 「対象外: バッチ処理の性能（別 NFR で扱う）」

### 6.2 非機能要件

NFR は **一覧表** を基本とし、必要に応じて補足を続けます。

#### 6.2.1 一覧表（必須）

最小の列は次を推奨します（`docs/product-docs/060-非機能要件/README.md` と整合）。

| 列         | 目的                                               |
| ---------- | -------------------------------------------------- |
| 要件区分   | 性能/可用性/セキュリティ/運用性/保守性/操作性 など |
| 内容       | 人が読める要件（対象＋条件＋指標＋基準）           |
| 指標・基準 | 数値や閾値（P95, RTO/RPO, 保持期間など）           |
| 備考       | 前提条件、除外、測定/検証方法、補足                |

推奨（レビュー/検証が難しい場合に追加）:

- `対象` 列（画面/API/バッチ/システム全体、または ID）
- `条件` 列（平常時/ピーク時、同時数、データ量など）
- `検証方法` 列（負荷試験、監視、監査ログ等）
- `優先度` 列（Must/Should/Could 等、または High/Medium/Low）
- `RASIS` 列（その要件がどの観点に属するか。`R`/`A`/`S`/`I`/`Sec` など）

#### 6.2.2 書き方のコツ

- “どれくらい”は **単位**まで書きます（ms、秒、RPS、GB、日、年、% 等）。
- 性能は「平均」よりも、レビューしやすい指標（P95/P99、最大、スループット）を優先します。
- 可用性は **除外条件**（メンテ時間、外部サービス障害の扱い等）を備考に明記します。
- 復旧は可能なら RTO/RPO を使い、「誰が何を見て合否判定するか」を備考に記載します。
- セキュリティは“機能”ではなく **要求**として書きます（例: 「権限がない利用者は参照できない」＋監査ログ要件）。

#### 6.2.3 ケース表（任意）

同じ指標を、対象（画面/API/操作）だけ変えて反復する場合は、NFR を増やす代わりに **ケース表**でまとめてよいです。

例（性能の対象が複数ある場合）:

| ケース | 対象             | 条件     | 指標・基準              |
| ------ | ---------------- | -------- | ----------------------- |
| C1     | 在庫照会API      | 平常時   | P95 500ms 以内          |
| C2     | 在庫照会API      | ピーク時 | P95 800ms 以内、100 RPS |
| C3     | 会計確定（画面） | 平常時   | 操作完了 2 秒以内       |

#### 6.2.4 RASIS 観点チェック（推奨）

非機能要件は、カテゴリ（性能/可用性/セキュリティ…）で書くだけだと、品質の抜け漏れが起きやすいため、作成・レビュー時に次のチェックを行います。

- 各 NFR の要件行（または段落）に対して、該当する RASIS を 1 つ以上割り当てられる。
- 対象システムにとって重要な RASIS が「未記載」になっていない。
  - 例: 可用性（A）を書いたが、復旧のしやすさ（S）やデータの整合（I）が抜けていた、など
- RASIS を書いたつもりで「手段」しか書いていない（例: “監視ツールを導入する”）場合は、**要求（結果）** に書き換える。
  - 例: “監視ツール導入” → “主要障害は 5 分以内に検知され、担当に通知される”

割り当ての目安（例）:

- R（信頼性）: エラー率、再試行方針、フェイルセーフ、データ破損防止
- A（可用性）: 稼働率、SLO、計画停止の扱い、冗長化要件
- S（保守性）: 監視・アラート、ログ/トレース、バックアップ/リストア、運用手順の明確化
- I（完全性）: 整合性、二重計上防止、監査証跡、改ざん検知
- Sec（機密性・安全性）: 認証/認可、最小権限、暗号化、脆弱性対応、監査ログ

### 6.3 メモ / 将来課題

- 未確定の前提（例: ピーク時の定義、想定データ量、外部依存のSLA）
- 将来追加したい NFR（例: 監査ログの検索性、DR訓練頻度、保守窓の短縮）

## 7. 禁止事項

| 項目                                            | 理由                       |
| ----------------------------------------------- | -------------------------- |
| 物理テーブル名・物理カラム名・SQL全文           | 概念レベル逸脱、変更に弱い |
| 実装クラス/関数名、特定ライブラリの設定値の列挙 | 実装依存で変更に弱い       |
| 「高速」「安定」「強固」など曖昧表現            | 検証不能                   |
| “前提”なしの数値（条件が不明）                  | 合意不能、試験設計不能     |

## 8. よくある誤りと対策

- 指標がない（「性能を確保する」） → 対象＋条件＋指標＋基準に分解して表に落とす
- 条件がない（ピーク/平常が不明） → 「平常時/ピーク時の定義」を備考に明記
- 検証できない（測れない） → 監視/試験/ログ等の観測点を備考に追記
- 例外（除外）が曖昧 → メンテ時間・外部障害の扱いを明記

## 9. サンプル（最小）

### メタ情報

```frontmatter
---
id: nfr-performance
type: architecture
title: 非機能要件: 性能
status: draft
version: '1.0.0'
owners: []
tags: [quality]
depends_on: []
implements: []
tests: []
supersedes: []
---
```

### 概要

主要な画面操作と主要 API が、平常時およびピーク時において業務上許容できる時間内で完了することを定義する。

### 非機能要件

| 要件区分 | RASIS | 内容                                                                        | 指標・基準          | 備考                                             |
| -------- | ----- | --------------------------------------------------------------------------- | ------------------- | ------------------------------------------------ |
| 性能     | R     | 在庫照会APIは、平常時に P95 応答時間 500ms 以内である                       | P95 500ms           | 検証: 負荷試験。平常時: 20 RPS を想定            |
| 性能     | R     | 在庫照会APIは、ピーク時に 100 RPS を処理でき、P95 応答時間 800ms 以内である | 100 RPS / P95 800ms | ピーク時: 16〜18時相当。外部IF遅延は別途切り分け |
| 性能     | R     | 会計確定は、操作開始から完了まで平常時 2 秒以内である                       | 2 秒以内            | 対象: レジ業務。検証: E2E + タイム計測           |

### メモ / 将来課題

- ピーク時の同時接続数・データ量の確定

## 10. 生成 AI への指示テンプレート

生成 AI に NFR を作らせるときは、以下のような指示を与えます。

> - 以下のルールに従って、**非機能要件（NFR）** を 1 ファイル作成してください。出力は **Markdown** とします。
> - 禁止: 物理テーブル名・物理カラム名・SQL全文、実装クラス/関数名、特定ライブラリの設定値の列挙、クリック手順など UI 操作の逐語列挙
> - 先頭に YAML Frontmatter を付与し、以下の形式で記述してください（`id` / `type` / `title` / `status` は必須、`type` は `architecture` 固定）：
>
>   ```yaml
>   ---
>   id: nfr-<英小文字とハイフンで構成したID>
>   type: architecture
>   title: 非機能要件: <対象名>
>   status: draft # draft / ready / deprecated
>   version: '1.0.0'
>   owners: []
>   tags: []
>   depends_on: []
>   implements: []
>   tests: []
>   supersedes: []
>   ---
>   ```
>
> - 本文は次の見出し（日本語）をこの順序で必ず含めてください：
>   1. 概要
>   2. 非機能要件
>   3. メモ / 将来課題
> - **非機能要件** には、少なくとも 5〜15 行程度の一覧表を作成してください。
> - 表は原則として次の列を含めてください：
>   - `要件区分` / `内容` / `指標・基準` / `備考`
> - 可能であれば、表に `RASIS` 列を追加し、各行に `R`/`A`/`S`/`I`/`Sec` のいずれか（または複数）を割り当ててください。
> - 各行の **内容** は、必ず「対象（何に）＋条件（いつ）＋指標（何を）＋基準（どれくらい）」を含む文章にしてください。
> - **指標・基準** は必ず数値・単位・判定軸（P95/P99、RTO/RPO、保持期間 等）まで具体化してください。
> - **備考** には、前提条件・除外条件・測定/検証方法を必要な範囲で書いてください。
> - 全体を **業務用語で統一** し、略語を使う場合は一般的な略語のみとし、意味が推測しづらい略語や内部コードは使用しないでください。
