$schema: 'http://json-schema.org/draft-07/schema#'
title: Business Data Dictionary Schema
type: object
additionalProperties: false

required:
  - id
  - type
  - title
  - status
  - entities

properties:
  id:
    type: string
    pattern: "^bdd-[a-z0-9\\-]+$"

  type:
    type: string
    const: 'domain'

  title:
    type: string

  status:
    type: string
    enum: ['draft', 'ready', 'deprecated']

  version:
    type: string

  owners:
    type: array
    items:
      type: string

  tags:
    type: array
    items:
      type: string

  supersedes:
    type: array
    items:
      type: string

  entities:
    type: array
    minItems: 1
    items:
      type: object
      additionalProperties: false
      required:
        - logical_name
        - physical_name
        - key_fields
        - fields

      properties:
        logical_name:
          type: string
          pattern: "^[\\p{Script=Hiragana}\\p{Script=Katakana}\\p{Script=Han}A-Za-z0-9]+$"

        physical_name:
          type: string
          pattern: '^[a-z][A-Za-z0-9]*$'

        description:
          type: string

        glossary_term_id:
          type: string
          pattern: "^tm-[A-Za-z0-9\\-]+$"

        related_terms:
          type: array
          items:
            type: string
            pattern: "^tm-[A-Za-z0-9\\-]+$"

        key_fields:
          type: array
          minItems: 1
          items:
            type: string
            pattern: '^[a-z][A-Za-z0-9]*$'

        fields:
          type: array
          minItems: 1
          items:
            type: object
            additionalProperties: false
            required:
              - logical_name
              - physical_name
              - type

            properties:
              logical_name:
                type: string
                pattern: "^[\\p{Script=Hiragana}\\p{Script=Katakana}\\p{Script=Han}A-Za-z0-9]+$"

              physical_name:
                type: string
                pattern: '^[a-z][A-Za-z0-9]*$'

              glossary_term_id:
                type: string
                pattern: "^tm-[A-Za-z0-9\\-]+$"

              type:
                type: string
                enum:
                  - integer
                  - string
                  - boolean
                  - date
                  - datetime
                  - enum
                  - money

              description:
                type: string

              unit:
                type: string

              example:
                type: [string, number, boolean]

              constraints:
                type: object
                additionalProperties: false
                properties:
                  required:
                    type: boolean
                  unique:
                    type: boolean
                  min:
                    type: number
                  max:
                    type: number
                  pattern:
                    type: string

              allowed_values:
                type: array
                items:
                  type: string
                uniqueItems: true

              allowed_values_detailed:
                type: array
                items:
                  type: object
                  additionalProperties: false
                  required:
                    - value
                    - label
                  properties:
                    value:
                      type: string
                    label:
                      type: string
                uniqueItems: true

      # key_fields が fields 内の physical_name に存在することを検証
      allOf:
        - $comment: 'key_fields must be included in fields[].physical_name'
        - type: object
          properties:
            key_fields:
              type: array
            fields:
              type: array
          required: ['key_fields', 'fields']
          allOf:
            # key_fields の各値が fields[].physical_name に存在すること
            - $comment: 'Check each key_field is present in fields[].physical_name'
            - type: object
              properties:
                key_fields:
                  type: array
                  items:
                    type: string
                fields:
                  type: array
                  items:
                    type: object
                    properties:
                      physical_name:
                        type: string
              required: ['key_fields', 'fields']
              allOf:
                - $comment: 'Ensure each key_fields item is contained in fields[].physical_name'
                  properties:
                    key_fields:
                      type: array
                      items:
                        type: string
                  required: ['key_fields']
                  allOf:
                    - $comment: 'for each key in key_fields check membership'
                      type: object
                      properties:
                        key_fields:
                          contains:
                            type: string
                      # membership check is implicit via contains + const matching below
                  # 各 key_field が fields[].physical_name のいずれかに一致
                - type: object
                  properties:
                    fields:
                      type: array
                      items:
                        type: object
                        properties:
                          physical_name:
                            type: string
                  required: ['fields']
